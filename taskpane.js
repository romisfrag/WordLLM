/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={118:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>r(e,t,n)>=0},9058:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>r(e,t,n)<0},9883:function(e,t,n){const r=n(23240);e.exports=(e,t,n)=>(e=new r(e,n),t=new r(t,n),e.intersects(t,n))},11282:function(e){const t=Object.freeze({loose:!0}),n=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:n},11560:function(e){function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(e[s]||0)+1;e[s]=i,i>=n&&(t=a,n=i)}return t}},12729:function(e){"use strict";const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),o=new RegExp(s.source+a.source,"gu"),c=new RegExp("\\d+"+a.source,"gu"),l=(e,a)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(a={pascalCase:!1,preserveConsecutiveUppercase:!1,...a},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const s=!1===a.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(a.locale),l=!1===a.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(a.locale);return 1===e.length?a.pascalCase?l(e):s(e):(e!==s(e)&&(e=((e,r,a)=>{let s=!1,i=!1,o=!1;for(let c=0;c<e.length;c++){const l=e[c];s&&t.test(l)?(e=e.slice(0,c)+"-"+e.slice(c),s=!1,o=i,i=!0,c++):i&&o&&n.test(l)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=i,i=!1,s=!0):(s=r(l)===l&&a(l)!==l,o=i,i=a(l)===l&&r(l)!==l)}return e})(e,s,l)),e=e.replace(i,""),e=a.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(e,s):s(e),a.pascalCase&&(e=l(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,((e,n)=>t(n))).replace(c,(e=>t(e)))))(e,l))};e.exports=l,e.exports.default=l},13569:function(e,t,n){const r=Symbol("SemVer ANY");class a{static get ANY(){return r}constructor(e,t){if(t=s(t),e instanceof a){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),l("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===r?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(e){const t=this.options.loose?i[o.COMPARATORLOOSE]:i[o.COMPARATOR],n=e.match(t);if(!n)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==n[1]?n[1]:"","="===this.operator&&(this.operator=""),n[2]?this.semver=new u(n[2],this.options.loose):this.semver=r}toString(){return this.value}test(e){if(l("Comparator.test",e,this.options.loose),this.semver===r||e===r)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return c(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=s(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(c(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(c(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}e.exports=a;const s=n(11282),{safeRe:i,t:o}=n(57221),c=n(58376),l=n(53821),u=n(32537),d=n(23240)},15718:function(e,t,n){const r=n(32537);e.exports=(e,t)=>new r(e,t).patch},19774:function(e,t,n){const r=n(96142);e.exports=(e,t)=>e.sort(((e,n)=>r(e,n,t)))},21812:function(e,t,n){const r=n(32537),a=n(23240),s=n(77317);e.exports=(e,t)=>{e=new a(e,t);let n=new r("0.0.0");if(e.test(n))return n;if(n=new r("0.0.0-0"),e.test(n))return n;n=null;for(let t=0;t<e.set.length;++t){const a=e.set[t];let i=null;a.forEach((e=>{const t=new r(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":i&&!s(t,i)||(i=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!i||n&&!s(n,i)||(n=i)}return n&&e.test(n)?n:null}},22791:function(e,t,n){const r=n(32537);e.exports=(e,t,n=!1)=>{if(e instanceof r)return e;try{return new r(e,t)}catch(e){if(!n)return null;throw e}}},23240:function(e,t,n){const r=/\s+/g;class a{constructor(e,t){if(t=i(t),e instanceof a)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new a(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(r," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!y(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&b(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+e,n=s.get(t);if(n)return n;const r=this.options.loose,a=r?u[d.HYPHENRANGELOOSE]:u[d.HYPHENRANGE];e=e.replace(a,A(this.options.includePrerelease)),c("hyphen replace",e),e=e.replace(u[d.COMPARATORTRIM],h),c("comparator trim",e),e=e.replace(u[d.TILDETRIM],p),c("tilde trim",e),e=e.replace(u[d.CARETTRIM],f),c("caret trim",e);let i=e.split(" ").map((e=>v(e,this.options))).join(" ").split(/\s+/).map((e=>P(e,this.options)));r&&(i=i.filter((e=>(c("loose invalid filter",e,this.options),!!e.match(u[d.COMPARATORLOOSE]))))),c("range list",i);const l=new Map,b=i.map((e=>new o(e,this.options)));for(const e of b){if(y(e))return[e];l.set(e.value,e)}l.size>1&&l.has("")&&l.delete("");const _=[...l.values()];return s.set(t,_),_}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Range is required");return this.set.some((n=>_(n,t)&&e.set.some((e=>_(e,t)&&n.every((n=>e.every((e=>n.intersects(e,t)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new l(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(T(this.set[t],e,this.options))return!0;return!1}}e.exports=a;const s=new(n(58597)),i=n(11282),o=n(13569),c=n(53821),l=n(32537),{safeRe:u,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=n(57221),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=n(91067),y=e=>"<0.0.0-0"===e.value,b=e=>""===e.value,_=(e,t)=>{let n=!0;const r=e.slice();let a=r.pop();for(;n&&r.length;)n=r.every((e=>a.intersects(e,t))),a=r.pop();return n},v=(e,t)=>(c("comp",e,t),e=E(e,t),c("caret",e),e=k(e,t),c("tildes",e),e=S(e,t),c("xrange",e),e=I(e,t),c("stars",e),e),w=e=>!e||"x"===e.toLowerCase()||"*"===e,k=(e,t)=>e.trim().split(/\s+/).map((e=>x(e,t))).join(" "),x=(e,t)=>{const n=t.loose?u[d.TILDELOOSE]:u[d.TILDE];return e.replace(n,((t,n,r,a,s)=>{let i;return c("tilde",e,t,n,r,a,s),w(n)?i="":w(r)?i=`>=${n}.0.0 <${+n+1}.0.0-0`:w(a)?i=`>=${n}.${r}.0 <${n}.${+r+1}.0-0`:s?(c("replaceTilde pr",s),i=`>=${n}.${r}.${a}-${s} <${n}.${+r+1}.0-0`):i=`>=${n}.${r}.${a} <${n}.${+r+1}.0-0`,c("tilde return",i),i}))},E=(e,t)=>e.trim().split(/\s+/).map((e=>O(e,t))).join(" "),O=(e,t)=>{c("caret",e,t);const n=t.loose?u[d.CARETLOOSE]:u[d.CARET],r=t.includePrerelease?"-0":"";return e.replace(n,((t,n,a,s,i)=>{let o;return c("caret",e,t,n,a,s,i),w(n)?o="":w(a)?o=`>=${n}.0.0${r} <${+n+1}.0.0-0`:w(s)?o="0"===n?`>=${n}.${a}.0${r} <${n}.${+a+1}.0-0`:`>=${n}.${a}.0${r} <${+n+1}.0.0-0`:i?(c("replaceCaret pr",i),o="0"===n?"0"===a?`>=${n}.${a}.${s}-${i} <${n}.${a}.${+s+1}-0`:`>=${n}.${a}.${s}-${i} <${n}.${+a+1}.0-0`:`>=${n}.${a}.${s}-${i} <${+n+1}.0.0-0`):(c("no pr"),o="0"===n?"0"===a?`>=${n}.${a}.${s}${r} <${n}.${a}.${+s+1}-0`:`>=${n}.${a}.${s}${r} <${n}.${+a+1}.0-0`:`>=${n}.${a}.${s} <${+n+1}.0.0-0`),c("caret return",o),o}))},S=(e,t)=>(c("replaceXRanges",e,t),e.split(/\s+/).map((e=>$(e,t))).join(" ")),$=(e,t)=>{e=e.trim();const n=t.loose?u[d.XRANGELOOSE]:u[d.XRANGE];return e.replace(n,((n,r,a,s,i,o)=>{c("xRange",e,n,r,a,s,i,o);const l=w(a),u=l||w(s),d=u||w(i),h=d;return"="===r&&h&&(r=""),o=t.includePrerelease?"-0":"",l?n=">"===r||"<"===r?"<0.0.0-0":"*":r&&h?(u&&(s=0),i=0,">"===r?(r=">=",u?(a=+a+1,s=0,i=0):(s=+s+1,i=0)):"<="===r&&(r="<",u?a=+a+1:s=+s+1),"<"===r&&(o="-0"),n=`${r+a}.${s}.${i}${o}`):u?n=`>=${a}.0.0${o} <${+a+1}.0.0-0`:d&&(n=`>=${a}.${s}.0${o} <${a}.${+s+1}.0-0`),c("xRange return",n),n}))},I=(e,t)=>(c("replaceStars",e,t),e.trim().replace(u[d.STAR],"")),P=(e,t)=>(c("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),A=e=>(t,n,r,a,s,i,o,c,l,u,d,h)=>`${n=w(r)?"":w(a)?`>=${r}.0.0${e?"-0":""}`:w(s)?`>=${r}.${a}.0${e?"-0":""}`:i?`>=${n}`:`>=${n}${e?"-0":""}`} ${c=w(l)?"":w(u)?`<${+l+1}.0.0-0`:w(d)?`<${l}.${+u+1}.0-0`:h?`<=${l}.${u}.${d}-${h}`:e?`<${l}.${u}.${+d+1}-0`:`<=${c}`}`.trim(),T=(e,t,n)=>{for(let n=0;n<e.length;n++)if(!e[n].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(let n=0;n<e.length;n++)if(c(e[n].semver),e[n].semver!==o.ANY&&e[n].semver.prerelease.length>0){const r=e[n].semver;if(r.major===t.major&&r.minor===t.minor&&r.patch===t.patch)return!0}return!1}return!0}},24540:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>0===r(e,t,n)},30228:function(e){"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new a(r,s||e,i),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,a=[];if(0===this._eventsCount)return a;for(r in e=this._events)t.call(e,r)&&a.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,a,s,i){var o=n?n+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,r);break;case 4:u[l].fn.call(u[l].context,t,r,a);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,a){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return i(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||a&&!o.once||r&&o.context!==r||i(this,s);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||a&&!o[c].once||r&&o[c].context!==r)&&l.push(o[c]);l.length?this._events[s]=1===l.length?l[0]:l:i(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},32537:function(e,t,n){const r=n(53821),{MAX_LENGTH:a,MAX_SAFE_INTEGER:s}=n(91067),{safeRe:i,safeSrc:o,t:c}=n(57221),l=n(11282),{compareIdentifiers:u}=n(75050);class d{constructor(e,t){if(t=l(t),e instanceof d){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>a)throw new TypeError(`version is longer than ${a} characters`);r("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const n=e.trim().match(t.loose?i[c.LOOSE]:i[c.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>s||this.major<0)throw new TypeError("Invalid major version");if(this.minor>s||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>s||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<s)return t}return e})):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(r("SemVer.compare",this.version,this.options,e),!(e instanceof d)){if("string"==typeof e&&e===this.version)return 0;e=new d(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof d||(e=new d(e,this.options)),u(this.major,e.major)||u(this.minor,e.minor)||u(this.patch,e.patch)}comparePre(e){if(e instanceof d||(e=new d(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const n=this.prerelease[t],a=e.prerelease[t];if(r("prerelease compare",t,n,a),void 0===n&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===n)return-1;if(n!==a)return u(n,a)}while(++t)}compareBuild(e){e instanceof d||(e=new d(e,this.options));let t=0;do{const n=this.build[t],a=e.build[t];if(r("build compare",t,n,a),void 0===n&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===n)return-1;if(n!==a)return u(n,a)}while(++t)}inc(e,t,n){if(e.startsWith("pre")){if(!t&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(t){const e=new RegExp(`^${this.options.loose?o[c.PRERELEASELOOSE]:o[c.PRERELEASE]}$`),n=`-${t}`.match(e);if(!n||n[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"release":if(0===this.prerelease.length)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(n)?1:0;if(0===this.prerelease.length)this.prerelease=[e];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(t===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let r=[t,e];!1===n&&(r=[t]),0===u(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=d},32670:function(e,t,n){const r=n(96142);e.exports=(e,t)=>e.sort(((e,n)=>r(n,e,t)))},37083:function(e,t,n){const r=n(53242);e.exports=(e,t,n)=>r(e,t,"<",n)},42648:function(e,t,n){const r=n(32537);e.exports=(e,t,n,a,s)=>{"string"==typeof n&&(s=a,a=n,n=void 0);try{return new r(e instanceof r?e.version:e,n).inc(t,a,s).version}catch(e){return null}}},42717:function(e,t,n){const r=n(22791);e.exports=(e,t)=>{const n=r(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null}},43440:function(e,t,n){const r=n(74607);e.exports=(e,t)=>r(e,t,!0)},44617:function(e){"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},44785:function(e,t,n){const r=n(23240);e.exports=(e,t,n)=>{try{t=new r(t,n)}catch(e){return!1}return t.test(e)}},48066:function(e,t,n){const r=n(44785),a=n(74607);e.exports=(e,t,n)=>{const s=[];let i=null,o=null;const c=e.sort(((e,t)=>a(e,t,n)));for(const e of c)r(e,t,n)?(o=e,i||(i=e)):(o&&s.push([i,o]),o=null,i=null);i&&s.push([i,null]);const l=[];for(const[e,t]of s)e===t?l.push(e):t||e!==c[0]?t?e===c[0]?l.push(`<=${t}`):l.push(`${e} - ${t}`):l.push(`>=${e}`):l.push("*");const u=l.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return u.length<d.length?u:t}},49418:function(e,t,n){"use strict";e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,a]of Object.entries(r))t[n]={open:`[${a[0]}m`,close:`[${a[1]}m`},r[n]=t[n],e.set(a[0],a[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=a(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=a(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},49608:function(e,t,n){e.exports=n(82230)},52448:function(e,t,n){const r=n(22791);e.exports=(e,t)=>{const n=r(e,t);return n&&n.prerelease.length?n.prerelease:null}},53242:function(e,t,n){const r=n(32537),a=n(13569),{ANY:s}=a,i=n(23240),o=n(44785),c=n(77317),l=n(9058),u=n(90507),d=n(118);e.exports=(e,t,n,h)=>{let p,f,m,g,y;switch(e=new r(e,h),t=new i(t,h),n){case">":p=c,f=u,m=l,g=">",y=">=";break;case"<":p=l,f=d,m=c,g="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let n=0;n<t.set.length;++n){const r=t.set[n];let i=null,o=null;if(r.forEach((e=>{e.semver===s&&(e=new a(">=0.0.0")),i=i||e,o=o||e,p(e.semver,i.semver,h)?i=e:m(e.semver,o.semver,h)&&(o=e)})),i.operator===g||i.operator===y)return!1;if((!o.operator||o.operator===g)&&f(e,o.semver))return!1;if(o.operator===y&&m(e,o.semver))return!1}return!0}},53821:function(e){const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},54040:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>0!==r(e,t,n)},54774:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(79998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const a=r.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(a,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},56335:function(e,t,n){const r=n(23240);e.exports=(e,t)=>{try{return new r(e,t).range||"*"}catch(e){return null}}},56641:function(e,t,n){"use strict";const r=n(44617);class a extends Error{constructor(e){super(e),this.name="TimeoutError"}}const s=(e,t,n)=>new Promise(((s,i)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void s(e);const o=setTimeout((()=>{if("function"==typeof n){try{s(n())}catch(e){i(e)}return}const r=n instanceof Error?n:new a("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),i(r)}),t);r(e.then(s,i),(()=>{clearTimeout(o)}))}));e.exports=s,e.exports.default=s,e.exports.TimeoutError=a},57221:function(e,t,n){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:s}=n(91067),i=n(53821),o=(t=e.exports={}).re=[],c=t.safeRe=[],l=t.src=[],u=t.safeSrc=[],d=t.t={};let h=0;const p="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[p,a]],m=(e,t,n)=>{const r=(e=>{for(const[t,n]of f)e=e.split(`${t}*`).join(`${t}{0,${n}}`).split(`${t}+`).join(`${t}{1,${n}}`);return e})(t),a=h++;i(e,a,t),d[e]=a,l[a]=t,u[a]=r,o[a]=new RegExp(t,n?"g":void 0),c[a]=new RegExp(r,n?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),m("MAINVERSION",`(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${l[d.NUMERICIDENTIFIER]}|${l[d.NONNUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${l[d.NUMERICIDENTIFIERLOOSE]}|${l[d.NONNUMERICIDENTIFIER]})`),m("PRERELEASE",`(?:-(${l[d.PRERELEASEIDENTIFIER]}(?:\\.${l[d.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${l[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[d.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${p}+`),m("BUILD",`(?:\\+(${l[d.BUILDIDENTIFIER]}(?:\\.${l[d.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${l[d.MAINVERSION]}${l[d.PRERELEASE]}?${l[d.BUILD]}?`),m("FULL",`^${l[d.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${l[d.MAINVERSIONLOOSE]}${l[d.PRERELEASELOOSE]}?${l[d.BUILD]}?`),m("LOOSE",`^${l[d.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${l[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${l[d.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:${l[d.PRERELEASE]})?${l[d.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:${l[d.PRERELEASELOOSE]})?${l[d.BUILD]}?)?)?`),m("XRANGE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),m("COERCE",`${l[d.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",l[d.COERCEPLAIN]+`(?:${l[d.PRERELEASE]})?`+`(?:${l[d.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",l[d.COERCE],!0),m("COERCERTLFULL",l[d.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${l[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",m("TILDE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${l[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",m("CARET",`^${l[d.LONECARET]}${l[d.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${l[d.LONECARET]}${l[d.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${l[d.GTLT]}\\s*(${l[d.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]}|${l[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${l[d.XRANGEPLAIN]})\\s+-\\s+(${l[d.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${l[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[d.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},58376:function(e,t,n){const r=n(24540),a=n(54040),s=n(77317),i=n(118),o=n(9058),c=n(90507);e.exports=(e,t,n,l)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return r(e,n,l);case"!=":return a(e,n,l);case">":return s(e,n,l);case">=":return i(e,n,l);case"<":return o(e,n,l);case"<=":return c(e,n,l);default:throw new TypeError(`Invalid operator: ${t}`)}}},58394:function(e,t,n){"use strict";e.exports=n.p+"6a74d6f636f31ab59a37.css"},58597:function(e){e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},59267:function(e,t,n){const r=n(32537),a=n(23240);e.exports=(e,t,n)=>{let s=null,i=null,o=null;try{o=new a(t,n)}catch(e){return null}return e.forEach((e=>{o.test(e)&&(s&&-1!==i.compare(e)||(s=e,i=new r(s,n)))})),s}},61134:function(e,t,n){const r=n(57221),a=n(91067),s=n(32537),i=n(75050),o=n(22791),c=n(96830),l=n(42717),u=n(42648),d=n(75505),h=n(76873),p=n(74061),f=n(15718),m=n(52448),g=n(74607),y=n(63695),b=n(43440),_=n(96142),v=n(19774),w=n(32670),k=n(77317),x=n(9058),E=n(24540),O=n(54040),S=n(118),$=n(90507),I=n(58376),P=n(62107),A=n(13569),T=n(23240),R=n(44785),j=n(84248),N=n(59267),C=n(67369),L=n(21812),M=n(56335),U=n(53242),D=n(74070),F=n(37083),B=n(9883),z=n(48066),Z=n(72115);e.exports={parse:o,valid:c,clean:l,inc:u,diff:d,major:h,minor:p,patch:f,prerelease:m,compare:g,rcompare:y,compareLoose:b,compareBuild:_,sort:v,rsort:w,gt:k,lt:x,eq:E,neq:O,gte:S,lte:$,cmp:I,coerce:P,Comparator:A,Range:T,satisfies:R,toComparators:j,maxSatisfying:N,minSatisfying:C,minVersion:L,validRange:M,outside:U,gtr:D,ltr:F,intersects:B,simplifyRange:z,subset:Z,SemVer:s,re:r.re,src:r.src,tokens:r.t,SEMVER_SPEC_VERSION:a.SEMVER_SPEC_VERSION,RELEASE_TYPES:a.RELEASE_TYPES,compareIdentifiers:i.compareIdentifiers,rcompareIdentifiers:i.rcompareIdentifiers}},62107:function(e,t,n){const r=n(32537),a=n(22791),{safeRe:s,t:i}=n(57221);e.exports=(e,t)=>{if(e instanceof r)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let n=null;if((t=t||{}).rtl){const r=t.includePrerelease?s[i.COERCERTLFULL]:s[i.COERCERTL];let a;for(;(a=r.exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&a.index+a[0].length===n.index+n[0].length||(n=a),r.lastIndex=a.index+a[1].length+a[2].length;r.lastIndex=-1}else n=e.match(t.includePrerelease?s[i.COERCEFULL]:s[i.COERCE]);if(null===n)return null;const o=n[2],c=n[3]||"0",l=n[4]||"0",u=t.includePrerelease&&n[5]?`-${n[5]}`:"",d=t.includePrerelease&&n[6]?`+${n[6]}`:"";return a(`${o}.${c}.${l}${u}${d}`,t)}},63695:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>r(t,e,n)},67369:function(e,t,n){const r=n(32537),a=n(23240);e.exports=(e,t,n)=>{let s=null,i=null,o=null;try{o=new a(t,n)}catch(e){return null}return e.forEach((e=>{o.test(e)&&(s&&1!==i.compare(e)||(s=e,i=new r(s,n)))})),s}},67526:function(e,t){"use strict";t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,s=o(e),i=s[0],c=s[1],l=new a(function(e,t,n){return 3*(t+n)/4-n}(0,i,c)),u=0,d=c>0?i-4:i;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,l[u++]=255&t),1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},t.fromByteArray=function(e){for(var t,r=e.length,a=r%3,s=[],i=16383,o=0,l=r-a;o<l;o+=i)s.push(c(e,o,o+i>l?l:o+i));return 1===a?(t=e[r-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===a&&(t=(e[r-2]<<8)+e[r-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),s.join("")};for(var n=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0;i<64;++i)n[i]=s[i],r[s.charCodeAt(i)]=i;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e,t,r){for(var a,s,i=[],o=t;o<r;o+=3)a=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(n[(s=a)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return i.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},72115:function(e,t,n){const r=n(23240),a=n(13569),{ANY:s}=a,i=n(44785),o=n(74607),c=[new a(">=0.0.0-0")],l=[new a(">=0.0.0")],u=(e,t,n)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===s){if(1===t.length&&t[0].semver===s)return!0;e=n.includePrerelease?c:l}if(1===t.length&&t[0].semver===s){if(n.includePrerelease)return!0;t=l}const r=new Set;let a,u,p,f,m,g,y;for(const t of e)">"===t.operator||">="===t.operator?a=d(a,t,n):"<"===t.operator||"<="===t.operator?u=h(u,t,n):r.add(t.semver);if(r.size>1)return null;if(a&&u){if(p=o(a.semver,u.semver,n),p>0)return null;if(0===p&&(">="!==a.operator||"<="!==u.operator))return null}for(const e of r){if(a&&!i(e,String(a),n))return null;if(u&&!i(e,String(u),n))return null;for(const r of t)if(!i(e,String(r),n))return!1;return!0}let b=!(!u||n.includePrerelease||!u.semver.prerelease.length)&&u.semver,_=!(!a||n.includePrerelease||!a.semver.prerelease.length)&&a.semver;b&&1===b.prerelease.length&&"<"===u.operator&&0===b.prerelease[0]&&(b=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,a)if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),">"===e.operator||">="===e.operator){if(f=d(a,e,n),f===e&&f!==a)return!1}else if(">="===a.operator&&!i(a.semver,String(e),n))return!1;if(u)if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),"<"===e.operator||"<="===e.operator){if(m=h(u,e,n),m===e&&m!==u)return!1}else if("<="===u.operator&&!i(u.semver,String(e),n))return!1;if(!e.operator&&(u||a)&&0!==p)return!1}return!(a&&g&&!u&&0!==p||u&&y&&!a&&0!==p||_||b)},d=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r>0?e:r<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r<0?e:r>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,n={})=>{if(e===t)return!0;e=new r(e,n),t=new r(t,n);let a=!1;e:for(const r of e.set){for(const e of t.set){const t=u(r,e,n);if(a=a||null!==t,t)continue e}if(a)return!1}return!0}},73290:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(30228),a=n(56641),s=n(54774),i=()=>{},o=new a.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=i,this._resolveIdle=i,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:s.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(a=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==a?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=i,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=i,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():a.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},74061:function(e,t,n){const r=n(32537);e.exports=(e,t)=>new r(e,t).minor},74070:function(e,t,n){const r=n(53242);e.exports=(e,t,n)=>r(e,t,">",n)},74607:function(e,t,n){const r=n(32537);e.exports=(e,t,n)=>new r(e,n).compare(new r(t,n))},75050:function(e){const t=/^[0-9]+$/,n=(e,n)=>{const r=t.test(e),a=t.test(n);return r&&a&&(e=+e,n=+n),e===n?0:r&&!a?-1:a&&!r?1:e<n?-1:1};e.exports={compareIdentifiers:n,rcompareIdentifiers:(e,t)=>n(t,e)}},75505:function(e,t,n){const r=n(22791);e.exports=(e,t)=>{const n=r(e,null,!0),a=r(t,null,!0),s=n.compare(a);if(0===s)return null;const i=s>0,o=i?n:a,c=i?a:n,l=!!o.prerelease.length;if(c.prerelease.length&&!l){if(!c.patch&&!c.minor)return"major";if(0===c.compareMain(o))return c.minor&&!c.patch?"minor":"patch"}const u=l?"pre":"";return n.major!==a.major?u+"major":n.minor!==a.minor?u+"minor":n.patch!==a.patch?u+"patch":"prerelease"}},76873:function(e,t,n){const r=n(32537);e.exports=(e,t)=>new r(e,t).major},77317:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>r(e,t,n)>0},79478:function(e){"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},79998:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,a=e.length;for(;a>0;){const s=a/2|0;let i=r+s;n(e[i],t)<=0?(r=++i,a-=s+1):a=s}return r}},82230:function(e,t,n){var r=n(11560);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<t.retries;a++)r.push(this.createTimeout(a,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(a,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var a in r=[],e)"function"==typeof e[a]&&r.push(a);for(var s=0;s<r.length;s++){var i=r[s],o=e[i];e[i]=function(r){var a=t.operation(n),s=Array.prototype.slice.call(arguments,1),i=s.pop();s.push((function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),i.apply(this,arguments))})),a.attempt((function(){r.apply(e,s)}))}.bind(e,o),e[i].options=n}}},84248:function(e,t,n){const r=n(23240);e.exports=(e,t)=>new r(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")))},88981:function(e,t,n){"use strict";const r=n(49608),a=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const i=(e,t)=>new Promise(((n,i)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt((async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void i(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)o.stop(),i(e.originalError);else if(e instanceof TypeError&&(c=e.message,!a.includes(c)))o.stop(),i(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void i(e)}o.retry(e)||i(o.mainError())}}var c}))}));e.exports=i,e.exports.default=i,e.exports.AbortError=s},90507:function(e,t,n){const r=n(74607);e.exports=(e,t,n)=>r(e,t,n)<=0},91067:function(e){const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},96142:function(e,t,n){const r=n(32537);e.exports=(e,t,n)=>{const a=new r(e,n),s=new r(t,n);return a.compare(s)||a.compareBuild(s)}},96830:function(e,t,n){const r=n(22791);e.exports=(e,t)=>{const n=r(e,t);return n?n.version:null}}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={id:r,loaded:!1,exports:{}};return e[r](s,s.exports,n),s.loaded=!0,s.exports}n.m=e,n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var a=r.length-1;a>-1&&(!e||!/^http(s?):/.test(e));)e=r[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}(),n.b=document.baseURI||self.location.href,function(){"use strict";var e={};n.r(e),n.d(e,{JsonPatchError:function(){return wc},_areEquals:function(){return Tc},applyOperation:function(){return Sc},applyPatch:function(){return $c},applyReducer:function(){return Ic},deepClone:function(){return kc},getValueByPointer:function(){return Oc},validate:function(){return Ac},validator:function(){return Pc}});const t="RFC3986",r={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},a=(Object.prototype.hasOwnProperty,Array.isArray),s=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),i=1024;function o(e,t){if(a(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const c=Object.prototype.hasOwnProperty,l={brackets(e){return String(e)+"[]"},comma:"comma",indices(e,t){return String(e)+"["+t+"]"},repeat(e){return String(e)}},u=Array.isArray,d=Array.prototype.push,h=function(e,t){d.apply(e,u(t)?t:[t])},p=Date.prototype.toISOString,f={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,a)=>{if(0===e.length)return e;let o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===n)return escape(o).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let c="";for(let e=0;e<o.length;e+=i){const t=o.length>=i?o.slice(e,e+i):o,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||"RFC1738"===a&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=s[r]:r<2048?n[n.length]=s[192|r>>6]+s[128|63&r]:r<55296||r>=57344?n[n.length]=s[224|r>>12]+s[128|r>>6&63]+s[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=s[240|r>>18]+s[128|r>>12&63]+s[128|r>>6&63]+s[128|63&r])}c+=n.join("")}return c},encodeValuesOnly:!1,format:t,formatter:r[t],indices:!1,serializeDate(e){return p.call(e)},skipNulls:!1,strictNullHandling:!1},m={};function g(e,t,n,r,a,s,i,c,l,d,p,y,b,_,v,w,k,x){let E=e,O=x,S=0,$=!1;for(;void 0!==(O=O.get(m))&&!$;){const t=O.get(e);if(S+=1,void 0!==t){if(t===S)throw new RangeError("Cyclic object value");$=!0}void 0===O.get(m)&&(S=0)}if("function"==typeof d?E=d(t,E):E instanceof Date?E=b?.(E):"comma"===n&&u(E)&&(E=o(E,(function(e){return e instanceof Date?b?.(e):e}))),null===E){if(s)return l&&!w?l(t,f.encoder,k,"key",_):t;E=""}if("string"==typeof(I=E)||"number"==typeof I||"boolean"==typeof I||"symbol"==typeof I||"bigint"==typeof I||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(E)){if(l){const e=w?t:l(t,f.encoder,k,"key",_);return[v?.(e)+"="+v?.(l(E,f.encoder,k,"value",_))]}return[v?.(t)+"="+v?.(String(E))]}var I;const P=[];if(void 0===E)return P;let A;if("comma"===n&&u(E))w&&l&&(E=o(E,l)),A=[{value:E.length>0?E.join(",")||null:void 0}];else if(u(d))A=d;else{const e=Object.keys(E);A=p?e.sort(p):e}const T=c?String(t).replace(/\./g,"%2E"):String(t),R=r&&u(E)&&1===E.length?T+"[]":T;if(a&&u(E)&&0===E.length)return R+"[]";for(let t=0;t<A.length;++t){const o=A[t],f="object"==typeof o&&void 0!==o.value?o.value:E[o];if(i&&null===f)continue;const O=y&&c?o.replace(/\./g,"%2E"):o,$=u(E)?"function"==typeof n?n(R,O):R:R+(y?"."+O:"["+O+"]");x.set(e,S);const I=new WeakMap;I.set(m,x),h(P,g(f,$,n,r,a,s,i,c,"comma"===n&&w&&u(E)?null:l,d,p,y,b,_,v,w,k,I))}return P}const y="4.96.0";let b,_,v,w,k,x,E,O,S,$=!1,I=null,P=null,A=null,T=null;class R{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}const j=()=>{b||function(e,t={auto:!1}){if($)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(b)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${b}'\``);$=t.auto,b=e.kind,_=e.fetch,I=e.Request,P=e.Response,A=e.Headers,v=e.FormData,T=e.Blob,w=e.File,k=e.ReadableStream,x=e.getMultipartRequestOptions,E=e.getDefaultAgent,O=e.fileFromPath,S=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,a,s;try{n=fetch,r=Request,a=Response,s=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:a,Headers:s,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new R(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0})};j();class N extends Error{}class C extends N{constructor(e,t,n,r){super(`${C.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"],this.error=t;const a=t;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e||!r)return new M({message:n,cause:je(t)});const a=t?.error;return 400===e?new D(e,a,n,r):401===e?new F(e,a,n,r):403===e?new B(e,a,n,r):404===e?new z(e,a,n,r):409===e?new Z(e,a,n,r):422===e?new q(e,a,n,r):429===e?new H(e,a,n,r):e>=500?new W(e,a,n,r):new C(e,a,n,r)}}class L extends C{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class M extends C{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class U extends M{constructor({message:e}={}){super({message:e??"Request timed out."})}}class D extends C{}class F extends C{}class B extends C{}class z extends C{}class Z extends C{}class q extends C{}class H extends C{}class W extends C{}class G extends N{constructor(){super("Could not parse response content as the length limit was reached")}}class J extends N{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var V,K=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},X=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Q{constructor(){V.set(this,void 0),this.buffer=new Uint8Array,K(this,V,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?(new TextEncoder).encode(e):e;let n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;const r=[];let a;for(;null!=(a=Y(this.buffer,X(this,V,"f")));){if(a.carriage&&null==X(this,V,"f")){K(this,V,a.index,"f");continue}if(null!=X(this,V,"f")&&(a.index!==X(this,V,"f")+1||a.carriage)){r.push(this.decodeText(this.buffer.slice(0,X(this,V,"f")-1))),this.buffer=this.buffer.slice(X(this,V,"f")),K(this,V,null,"f");continue}const e=null!==X(this,V,"f")?a.preceding-1:a.preceding,t=this.decodeText(this.buffer.slice(0,e));r.push(t),this.buffer=this.buffer.slice(a.index),K(this,V,null,"f")}return r}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new N(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new N(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new N("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode("\n"):[]}}function Y(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function ee(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}function te(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}V=new WeakMap,Q.NEWLINE_CHARS=new Set(["\n","\r"]),Q.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class ne{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new ne((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new N("Attempted to iterate over a response with no body");const n=new re,r=new Q,a=te(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,a=new Uint8Array(t.length+e.length);for(a.set(t),a.set(e,t.length),t=a;-1!==(r=ee(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(a))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!r)if(n.data.startsWith("[DONE]"))r=!0;else if(null===n.event||n.event.startsWith("response.")||n.event.startsWith("transcript.")){let t;try{t=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(t&&t.error)throw new C(void 0,t.error,void 0,we(e.headers));yield t}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new C(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new ne((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new Q,n=te(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new ne((()=>r(e)),this.controller),new ne((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new k({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:a}=await t.next();if(a)return e.close();const s=n.encode(JSON.stringify(r)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class re{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}const ae=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,se=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&ie(e),ie=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function oe(e,t,n){if(e=await e,se(e))return e;if(ae(e)){const r=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=ie(r)?[await r.arrayBuffer()]:[r];return new w(a,t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(ie(e))t.push(await e.arrayBuffer());else{if(!le(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return ce(e.name)||ce(e.filename)||ce(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new w(r,t,n)}const ce=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,le=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],ue=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],de=async e=>{const t=await he(e.body);return x(t,e)},he=async e=>{const t=new v;return await Promise.all(Object.entries(e||{}).map((([e,n])=>pe(t,e,n)))),t},pe=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>se(e)||ae(e)||S(e))(n)){const r=await oe(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>pe(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>pe(e,`${t}[${n}]`,r))))}}};var fe;async function me(e){const{response:t}=e;if(e.options.stream)return De("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):ne.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type"),r=n?.split(";")[0]?.trim();if(r?.includes("application/json")||r?.endsWith("+json")){const e=await t.json();return De("response",t.status,t.url,t.headers,e),ge(e,t)}const a=await t.text();return De("response",t.status,t.url,t.headers,a),a}function ge(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}j();class ye extends Promise{constructor(e,t=me){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new ye(this.responsePromise,(async t=>ge(e(await this.parseResponse(t),t),t.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class be{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:a}){this.baseURL=e,this.maxRetries=Re("maxRetries",t),this.timeout=Re("timeout",n),this.httpAgent=r,this.fetch=a??_}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...$e(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Fe()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const r=n&&ie(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:r}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:r,path:a,query:s,headers:i={}}=n,o=ArrayBuffer.isView(n.body)||n.__binaryRequest&&"string"==typeof n.body?n.body:ue(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(o),l=this.buildURL(a,s);"timeout"in n&&Re("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const u=n.httpAgent??this.httpAgent??E(l),d=n.timeout+1e3;return"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==r&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey),{req:{method:r,...o&&{body:o},headers:this.buildHeaders({options:n,headers:i,contentLength:c,retryCount:t}),...u&&{agent:u},signal:n.signal??null},url:l,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){const a={};n&&(a["content-length"]=n);const s=this.defaultHeaders(e);return Me(a,s),Me(a,t),ue(e.body)&&"node"!==b&&delete a["content-type"],void 0===Be(s,"x-stainless-retry-count")&&void 0===Be(t,"x-stainless-retry-count")&&(a["x-stainless-retry-count"]=String(r)),void 0===Be(s,"x-stainless-timeout")&&void 0===Be(t,"x-stainless-timeout")&&e.timeout&&(a["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return C.generate(e,t,n,r)}request(e,t=null){return new ye(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:a,url:s,timeout:i}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(a,{url:s,options:n}),De("request",s,n,a.headers),n.signal?.aborted)throw new L;const o=new AbortController,c=await this.fetchWithTimeout(s,a,i,o).catch(je);if(c instanceof Error){if(n.signal?.aborted)throw new L;if(t)return this.retryRequest(n,t);if("AbortError"===c.name)throw new U;throw new M({cause:c})}const l=we(c.headers);if(!c.ok){if(t&&this.shouldRetry(c))return De(`response (error; retrying, ${t} attempts remaining)`,c.status,s,l),this.retryRequest(n,t,l);const e=await c.text().catch((e=>je(e).message)),r=Ie(e),a=r?void 0:e;throw De(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,s,l,a),this.makeStatusError(c.status,r,a,l)}return{response:c,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new ve(this,n,e)}buildURL(e,t){const n=Ae(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return Ce(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new N(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:a,...s}=t||{};a&&a.addEventListener("abort",(()=>r.abort()));const i=setTimeout((()=>r.abort()),n),o={signal:r.signal,...s};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally((()=>{clearTimeout(i)}))}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let r;const a=n?.["retry-after-ms"];if(a){const e=parseFloat(a);Number.isNaN(e)||(r=e)}const s=n?.["retry-after"];if(s&&!r){const e=parseFloat(s);r=Number.isNaN(e)?Date.parse(s)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Te(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${y}`}}class _e{constructor(e,t,n,r){fe.set(this,void 0),function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===r?a.call(e,n):a?a.value=n:t.set(e,n)}(this,fe,e,"f"),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new N("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}(this,fe,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(fe=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class ve extends ye{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await me(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const we=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),ke={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},xe=e=>"object"==typeof e&&null!==e&&!Ce(e)&&Object.keys(e).every((e=>Le(ke,e))),Ee=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Oe=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Se;const $e=()=>Se??(Se=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":y,"X-Stainless-OS":Oe(Deno.build.os),"X-Stainless-Arch":Ee(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":y,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":y,"X-Stainless-OS":Oe(process.platform),"X-Stainless-Arch":Ee(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":y,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":y,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),Ie=e=>{try{return JSON.parse(e)}catch(e){return}},Pe=/^[a-z][a-z0-9+.-]*:/i,Ae=e=>Pe.test(e),Te=e=>new Promise((t=>setTimeout(t,e))),Re=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new N(`${e} must be an integer`);if(t<0)throw new N(`${e} must be a positive integer`);return t},je=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},Ne=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Ce(e){if(!e)return!0;for(const t in e)return!1;return!0}function Le(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Me(e,t){for(const n in t){if(!Le(t,n))continue;const r=n.toLowerCase();if(!r)continue;const a=t[n];null===a?delete e[r]:void 0!==a&&(e[r]=a)}}const Ue=new Set(["authorization","api-key"]);function De(e,...t){if("undefined"!=typeof process&&"true"===process?.env?.DEBUG){const n=t.map((e=>{if(!e)return e;if(e.headers){const t={...e,headers:{...e.headers}};for(const n in e.headers)Ue.has(n.toLowerCase())&&(t.headers[n]="REDACTED");return t}let t=null;for(const n in e)Ue.has(n.toLowerCase())&&(t??(t={...e}),t[n]="REDACTED");return t??e}));console.log(`OpenAI:DEBUG:${e}`,...n)}}const Fe=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),Be=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const a of[t,n,t.toUpperCase(),r]){const t=e.get(a);if(t)return t}}for(const[r,a]of Object.entries(e))if(r.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${t} header, using the first entry.`),a[0]):a};function ze(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Ze{constructor(e){this._client=e}}class qe extends Ze{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class He extends Ze{list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,Ke,{query:t,...n})}}class We extends _e{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Ge extends _e{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Je extends Ze{constructor(){super(...arguments),this.messages=new He(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/chat/completions",Ve,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}}class Ve extends Ge{}class Ke extends Ge{}Je.ChatCompletionsPage=Ve,Je.Messages=He;class Xe extends Ze{constructor(){super(...arguments),this.completions=new Je(this._client)}}Xe.Completions=Je,Xe.ChatCompletionsPage=Ve;class Qe extends Ze{create(e,t){const n=!!e.encoding_format;let r=n?e.encoding_format:"base64";n&&De("Request","User defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return n?a:(De("response","Decoding base64 embeddings to float32 array"),a._thenUnwrap((e=>(e&&e.data&&e.data.forEach((e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return Array.from(new Float32Array(r.buffer))}})(t)})),e))))}}class Ye extends Ze{create(e,t){return this._client.post("/files",de({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/files",et,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let s=await this.retrieve(e);for(;!s.status||!r.has(s.status);)if(await Te(t),s=await this.retrieve(e),Date.now()-a>n)throw new U({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return s}}class et extends Ge{}Ye.FileObjectsPage=et;class tt extends Ze{createVariation(e,t){return this._client.post("/images/variations",de({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",de({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class nt extends Ze{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class rt extends Ze{create(e,t){return this._client.post("/audio/transcriptions",de({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class at extends Ze{create(e,t){return this._client.post("/audio/translations",de({body:e,...t,__metadata:{model:e.model}}))}}class st extends Ze{constructor(){super(...arguments),this.transcriptions=new rt(this._client),this.translations=new at(this._client),this.speech=new nt(this._client)}}st.Transcriptions=rt,st.Translations=at,st.Speech=nt;class it extends Ze{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class ot extends Ze{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ct,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class ct extends We{}ot.ModelsPage=ct;class lt extends Ze{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,ut,{body:t,method:"post",...n})}retrieve(e,t={},n){return xe(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}}class ut extends We{}lt.PermissionCreateResponsesPage=ut;class dt extends Ze{constructor(){super(...arguments),this.permissions=new lt(this._client)}}dt.Permissions=lt,dt.PermissionCreateResponsesPage=ut;class ht extends Ze{list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,pt,{query:t,...n})}}class pt extends Ge{}ht.FineTuningJobCheckpointsPage=pt;class ft extends Ze{constructor(){super(...arguments),this.checkpoints=new ht(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",mt,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return xe(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,gt,{query:t,...n})}}class mt extends Ge{}class gt extends Ge{}ft.FineTuningJobsPage=mt,ft.FineTuningJobEventsPage=gt,ft.Checkpoints=ht,ft.FineTuningJobCheckpointsPage=pt;class yt extends Ze{constructor(){super(...arguments),this.jobs=new ft(this._client),this.checkpoints=new dt(this._client)}}yt.Jobs=ft,yt.FineTuningJobsPage=mt,yt.FineTuningJobEventsPage=gt,yt.Checkpoints=dt;class bt extends Ze{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,_t,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const a=await this.retrieve(e,t,{...n,headers:r}).withResponse(),s=a.data;switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Te(e);break;case"failed":case"completed":return s}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,vt,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class _t extends Ge{}class vt extends We{}bt.VectorStoreFilesPage=_t,bt.FileContentResponsesPage=vt;class wt extends Ze{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return xe(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,_t,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:s}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Te(e);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=r?.maxConcurrency??5,s=Math.min(a,t.length),i=this._client,o=t.values(),c=[...n],l=Array(s).fill(o).map((async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},r);c.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(l),await this.createAndPoll(e,{file_ids:c})}}class kt extends Ze{constructor(){super(...arguments),this.files=new bt(this._client),this.fileBatches=new wt(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/vector_stores",xt,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,Et,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class xt extends Ge{}class Et extends We{}kt.VectorStoresPage=xt,kt.VectorStoreSearchResponsesPage=Et,kt.Files=bt,kt.VectorStoreFilesPage=_t,kt.FileContentResponsesPage=vt,kt.FileBatches=wt;class Ot extends Ze{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/assistants",St,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class St extends Ge{}function $t(e){return"function"==typeof e.parse}Ot.AssistantsPage=St;const It=e=>"assistant"===e?.role,Pt=e=>"function"===e?.role,At=e=>"tool"===e?.role;var Tt,Rt,jt,Nt,Ct,Lt,Mt,Ut,Dt,Ft,Bt,zt,Zt,qt=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},Ht=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Wt{constructor(){Tt.add(this),this.controller=new AbortController,Rt.set(this,void 0),jt.set(this,(()=>{})),Nt.set(this,(()=>{})),Ct.set(this,void 0),Lt.set(this,(()=>{})),Mt.set(this,(()=>{})),Ut.set(this,{}),Dt.set(this,!1),Ft.set(this,!1),Bt.set(this,!1),zt.set(this,!1),qt(this,Rt,new Promise(((e,t)=>{qt(this,jt,e,"f"),qt(this,Nt,t,"f")})),"f"),qt(this,Ct,new Promise(((e,t)=>{qt(this,Lt,e,"f"),qt(this,Mt,t,"f")})),"f"),Ht(this,Rt,"f").catch((()=>{})),Ht(this,Ct,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),Ht(this,Tt,"m",Zt).bind(this))}),0)}_connected(){this.ended||(Ht(this,jt,"f").call(this),this._emit("connect"))}get ended(){return Ht(this,Dt,"f")}get errored(){return Ht(this,Ft,"f")}get aborted(){return Ht(this,Bt,"f")}abort(){this.controller.abort()}on(e,t){return(Ht(this,Ut,"f")[e]||(Ht(this,Ut,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Ht(this,Ut,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(Ht(this,Ut,"f")[e]||(Ht(this,Ut,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{qt(this,zt,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){qt(this,zt,!0,"f"),await Ht(this,Ct,"f")}_emit(e,...t){if(Ht(this,Dt,"f"))return;"end"===e&&(qt(this,Dt,!0,"f"),Ht(this,Lt,"f").call(this));const n=Ht(this,Ut,"f")[e];if(n&&(Ht(this,Ut,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Ht(this,zt,"f")||n?.length||Promise.reject(e),Ht(this,Nt,"f").call(this,e),Ht(this,Mt,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Ht(this,zt,"f")||n?.length||Promise.reject(e),Ht(this,Nt,"f").call(this,e),Ht(this,Mt,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function Gt(e){return"auto-parseable-response-format"===e?.$brand}function Jt(e){return"auto-parseable-tool"===e?.$brand}function Vt(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new G;if("content_filter"===e.finish_reason)throw new J;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:Jt(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?Kt(t,e.message.content):null}}}));return{...e,choices:n}}function Kt(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function Xt(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return Jt(n)||n?.function.strict||!1}function Qt(e){return!!Gt(e.response_format)||(e.tools?.some((e=>Jt(e)||"function"===e.type&&!0===e.function.strict))??!1)}Rt=new WeakMap,jt=new WeakMap,Nt=new WeakMap,Ct=new WeakMap,Lt=new WeakMap,Mt=new WeakMap,Ut=new WeakMap,Dt=new WeakMap,Ft=new WeakMap,Bt=new WeakMap,zt=new WeakMap,Tt=new WeakSet,Zt=function(e){if(qt(this,Ft,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new L),e instanceof L)return qt(this,Bt,!0,"f"),this._emit("abort",e);if(e instanceof N)return this._emit("error",e);if(e instanceof Error){const t=new N(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new N(String(e)))};var Yt,en,tn,nn,rn,an,sn,on,cn=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const ln=10;class un extends Wt{constructor(){super(...arguments),Yt.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Pt(e)||At(e))&&e.content)this._emit("functionCallResult",e.content);else if(It(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(It(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new N("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),cn(this,Yt,"m",en).call(this)}async finalMessage(){return await this.done(),cn(this,Yt,"m",tn).call(this)}async finalFunctionCall(){return await this.done(),cn(this,Yt,"m",nn).call(this)}async finalFunctionCallResult(){return await this.done(),cn(this,Yt,"m",rn).call(this)}async totalUsage(){return await this.done(),cn(this,Yt,"m",an).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=cn(this,Yt,"m",tn).call(this);t&&this._emit("finalMessage",t);const n=cn(this,Yt,"m",en).call(this);n&&this._emit("finalContent",n);const r=cn(this,Yt,"m",nn).call(this);r&&this._emit("finalFunctionCall",r);const a=cn(this,Yt,"m",rn).call(this);null!=a&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",cn(this,Yt,"m",an).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),cn(this,Yt,"m",sn).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Vt(a,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:a="auto",stream:s,...i}=t,o="string"!=typeof a&&a?.name,{maxChatCompletions:c=ln}=n||{},l={};for(const e of t.functions)l[e.name||e.function.name]=e;const u=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...i,function_call:a,functions:u,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new N("missing message in ChatCompletion response");if(!s.function_call)return;const{name:c,arguments:d}=s.function_call,h=l[c];if(!h){const e=`Invalid function_call: ${JSON.stringify(c)}. Available options are: ${u.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:c,content:e});continue}if(o&&o!==c){const e=`Invalid function_call: ${JSON.stringify(c)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:c,content:e});continue}let p;try{p=$t(h)?await h.parse(d):d}catch(e){this._addMessage({role:r,name:c,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=cn(this,Yt,"m",on).call(this,f);if(this._addMessage({role:r,name:c,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:a="auto",stream:s,...i}=t,o="string"!=typeof a&&a?.function?.name,{maxChatCompletions:c=ln}=n||{},l=t.tools.map((e=>{if(Jt(e)){if(!e.$callback)throw new N("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),u={};for(const e of l)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?l.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:a,tools:d,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new N("missing message in ChatCompletion response");if(!s.tool_calls?.length)return;for(const e of s.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:a}=e.function,s=u[n];if(!s){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(o&&o!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let i;try{i=$t(s)?await s.parse(a):a}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:t,content:n});continue}const c=await s.function(i,this),l=cn(this,Yt,"m",on).call(this,c);if(this._addMessage({role:r,tool_call_id:t,content:l}),o)return}}}}Yt=new WeakSet,en=function(){return cn(this,Yt,"m",tn).call(this).content??null},tn=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(It(t)){const{function_call:e,...n}=t,r={...n,content:t.content??null,refusal:t.refusal??null};return e&&(r.function_call=e),r}}throw new N("stream ended without producing a ChatCompletionMessage with role=assistant")},nn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(It(t)&&t?.function_call)return t.function_call;if(It(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},rn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Pt(t)&&null!=t.content)return t.content;if(At(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},an=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},sn=function(e){if(null!=e.n&&e.n>1)throw new N("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},on=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class dn extends un{static runFunctions(e,t,n){const r=new dn,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,a))),r}static runTools(e,t,n){const r=new dn,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,a))),r}_addMessage(e,t=!0){super._addMessage(e,t),It(e)&&e.content&&this._emit("content",e.content)}}class hn extends Error{}class pn extends Error{}const fn=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let r=0;const a=e=>{throw new hn(`${e} at position ${r}`)},s=e=>{throw new pn(`${e} at position ${r}`)},i=()=>(d(),r>=n&&a("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?c():"["===e[r]?l():"null"===e.substring(r,r+4)||16&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||32&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||32&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||128&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||256&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||64&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):u()),o=()=>{const i=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(i,++r-Number(o)))}catch(e){s(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},c=()=>{r++,d();const s={};try{for(;"}"!==e[r];){if(d(),r>=n&&8&t)return s;const a=o();d(),r++;try{const e=i();Object.defineProperty(s,a,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return s;throw e}d(),","===e[r]&&r++}}catch(e){if(8&t)return s;a("Expected '}' at end of object")}return r++,s},l=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(i()),d(),","===e[r]&&r++}catch(e){if(4&t)return n;a("Expected ']' at end of array")}return r++,n},u=()=>{if(0===r){"-"===e&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}s(String(n))}}const i=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||2&t||a("Unterminated number literal");try{return JSON.parse(e.substring(i,r))}catch(n){"-"===e.substring(i,r)&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){s(String(e))}}},d=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return i()})(e.trim(),t)}(e,509);var mn,gn,yn,bn,_n,vn,wn,kn,xn,En,On,Sn,$n=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},In=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Pn extends un{constructor(e){super(),mn.add(this),gn.set(this,void 0),yn.set(this,void 0),bn.set(this,void 0),$n(this,gn,e,"f"),$n(this,yn,[],"f")}get currentChatCompletionSnapshot(){return In(this,bn,"f")}static fromReadableStream(e){const t=new Pn(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new Pn(t);return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),In(this,mn,"m",_n).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of a)In(this,mn,"m",wn).call(this,e);if(a.controller.signal?.aborted)throw new L;return this._addChatCompletion(In(this,mn,"m",En).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),In(this,mn,"m",_n).call(this),this._connected();const r=ne.fromReadableStream(e,this.controller);let a;for await(const e of r)a&&a!==e.id&&this._addChatCompletion(In(this,mn,"m",En).call(this)),In(this,mn,"m",wn).call(this,e),a=e.id;if(r.controller.signal?.aborted)throw new L;return this._addChatCompletion(In(this,mn,"m",En).call(this))}[(gn=new WeakMap,yn=new WeakMap,bn=new WeakMap,mn=new WeakSet,_n=function(){this.ended||$n(this,bn,void 0,"f")},vn=function(e){let t=In(this,yn,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},In(this,yn,"f")[e.index]=t,t)},wn=function(e){if(this.ended)return;const t=In(this,mn,"m",Sn).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=In(this,mn,"m",vn).call(this,e);e.finish_reason&&(In(this,mn,"m",xn).call(this,e),null!=r.current_tool_call_index&&In(this,mn,"m",kn).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(In(this,mn,"m",xn).call(this,e),null!=r.current_tool_call_index&&In(this,mn,"m",kn).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&"function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""})}}},kn=function(e,t){if(In(this,mn,"m",vn).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=In(this,gn,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Jt(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},xn=function(e){const t=In(this,mn,"m",vn).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=In(this,mn,"m",On).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},En=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");const e=In(this,bn,"f");if(!e)throw new N("request ended without sending any chunks");return $n(this,bn,void 0,"f"),$n(this,yn,[],"f"),function(e,t){const{id:n,choices:r,created:a,model:s,system_fingerprint:i,...o}=e,c={...o,id:n,choices:r.map((({message:t,finish_reason:n,index:r,logprobs:a,...s})=>{if(!n)throw new N(`missing finish_reason for choice ${r}`);const{content:i=null,function_call:o,tool_calls:c,...l}=t,u=t.role;if(!u)throw new N(`missing role for choice ${r}`);if(o){const{arguments:e,name:c}=o;if(null==e)throw new N(`missing function_call.arguments for choice ${r}`);if(!c)throw new N(`missing function_call.name for choice ${r}`);return{...s,message:{content:i,function_call:{arguments:e,name:c},role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:a}}return c?{...s,index:r,finish_reason:n,logprobs:a,message:{...l,role:u,content:i,refusal:t.refusal??null,tool_calls:c.map(((t,n)=>{const{function:a,type:s,id:i,...o}=t,{arguments:c,name:l,...u}=a||{};if(null==i)throw new N(`missing choices[${r}].tool_calls[${n}].id\n${An(e)}`);if(null==s)throw new N(`missing choices[${r}].tool_calls[${n}].type\n${An(e)}`);if(null==l)throw new N(`missing choices[${r}].tool_calls[${n}].function.name\n${An(e)}`);if(null==c)throw new N(`missing choices[${r}].tool_calls[${n}].function.arguments\n${An(e)}`);return{...o,id:i,type:s,function:{...u,name:l,arguments:c}}}))}}:{...s,message:{...l,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:a}})),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&Qt(t)?Vt(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}})))}}(c,t)}(e,In(this,gn,"f"))},On=function(){const e=In(this,gn,"f")?.response_format;return Gt(e)?e:null},Sn=function(e){var t,n,r,a;let s=In(this,bn,"f");const{choices:i,...o}=e;s?Object.assign(s,o):s=$n(this,bn,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:c,logprobs:l=null,...u}of e.choices){let e=s.choices[c];if(e||(e=s.choices[c]={finish_reason:o,index:c,message:{},logprobs:l,...u}),l)if(e.logprobs){const{content:r,refusal:a,...s}=l;Object.assign(e.logprobs,s),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),a&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...a))}else e.logprobs=Object.assign({},l);if(o&&(e.finish_reason=o,In(this,gn,"f")&&Qt(In(this,gn,"f")))){if("length"===o)throw new G;if("content_filter"===o)throw new J}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...g}=i;if(Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((r=e.message.function_call).arguments??(r.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&In(this,mn,"m",On).call(this)&&(e.message.parsed=fn(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:s,...i}of m){const o=(a=e.message.tool_calls)[t]??(a[t]={});Object.assign(o,i),n&&(o.id=n),r&&(o.type=r),s&&(o.function??(o.function={name:s.name??"",arguments:""})),s?.name&&(o.function.name=s.name),s?.arguments&&(o.function.arguments+=s.arguments,Xt(In(this,gn,"f"),o)&&(o.function.parsed_arguments=fn(o.function.arguments)))}}}return s},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ne(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function An(e){return JSON.stringify(e)}class Tn extends Pn{static fromReadableStream(e){const t=new Tn(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new Tn(null),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,a))),r}static runTools(e,t,n){const r=new Tn(t),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,a))),r}}class Rn extends Ze{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new N(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new N(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>Vt(t,e)))}runFunctions(e,t){return e.stream?Tn.runFunctions(this._client,e,t):dn.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Tn.runTools(this._client,e,t):dn.runTools(this._client,e,t)}stream(e,t){return Pn.createChatCompletion(this._client,e,t)}}class jn extends Ze{constructor(){super(...arguments),this.completions=new Rn(this._client)}}!function(e){e.Completions=Rn}(jn||(jn={}));class Nn extends Ze{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Cn extends Ze{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Ln extends Ze{constructor(){super(...arguments),this.sessions=new Nn(this._client),this.transcriptionSessions=new Cn(this._client)}}Ln.Sessions=Nn,Ln.TranscriptionSessions=Cn;var Mn,Un,Dn,Fn,Bn,zn,Zn,qn,Hn,Wn,Gn,Jn,Vn,Kn,Xn,Qn,Yn,er,tr,nr,rr,ar,sr=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},ir=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n};class or extends Wt{constructor(){super(...arguments),Mn.add(this),Un.set(this,[]),Dn.set(this,{}),Fn.set(this,{}),Bn.set(this,void 0),zn.set(this,void 0),Zn.set(this,void 0),qn.set(this,void 0),Hn.set(this,void 0),Wn.set(this,void 0),Gn.set(this,void 0),Jn.set(this,void 0),Vn.set(this,void 0)}[(Un=new WeakMap,Dn=new WeakMap,Fn=new WeakMap,Bn=new WeakMap,zn=new WeakMap,Zn=new WeakMap,qn=new WeakMap,Hn=new WeakMap,Wn=new WeakMap,Gn=new WeakMap,Jn=new WeakMap,Vn=new WeakMap,Mn=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new or;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=ne.fromReadableStream(e,this.controller);for await(const e of r)sr(this,Mn,"m",Kn).call(this,e);if(r.controller.signal?.aborted)throw new L;return this._addRun(sr(this,Mn,"m",Xn).call(this))}toReadableStream(){return new ne(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,a){const s=new or;return s._run((()=>s._runToolAssistantStream(e,t,n,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}async _createToolAssistantStream(e,t,n,r,a){const s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const i={...r,stream:!0},o=await e.submitToolOutputs(t,n,i,{...a,signal:this.controller.signal});this._connected();for await(const e of o)sr(this,Mn,"m",Kn).call(this,e);if(o.controller.signal?.aborted)throw new L;return this._addRun(sr(this,Mn,"m",Xn).call(this))}static createThreadAssistantStream(e,t,n){const r=new or;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const a=new or;return a._run((()=>a._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),a}currentEvent(){return sr(this,Gn,"f")}currentRun(){return sr(this,Jn,"f")}currentMessageSnapshot(){return sr(this,Bn,"f")}currentRunStepSnapshot(){return sr(this,Vn,"f")}async finalRunSteps(){return await this.done(),Object.values(sr(this,Dn,"f"))}async finalMessages(){return await this.done(),Object.values(sr(this,Fn,"f"))}async finalRun(){if(await this.done(),!sr(this,zn,"f"))throw Error("Final run was not received.");return sr(this,zn,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const a={...t,stream:!0},s=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(const e of s)sr(this,Mn,"m",Kn).call(this,e);if(s.controller.signal?.aborted)throw new L;return this._addRun(sr(this,Mn,"m",Xn).call(this))}async _createAssistantStream(e,t,n,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(()=>this.controller.abort())));const s={...n,stream:!0},i=await e.create(t,s,{...r,signal:this.controller.signal});this._connected();for await(const e of i)sr(this,Mn,"m",Kn).call(this,e);if(i.controller.signal?.aborted)throw new L;return this._addRun(sr(this,Mn,"m",Xn).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!ze(t)||!ze(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}for(const e of r){if(!ze(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,a){return await this._createToolAssistantStream(n,e,t,r,a)}}Kn=function(e){if(!this.ended)switch(ir(this,Gn,e,"f"),sr(this,Mn,"m",er).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":sr(this,Mn,"m",ar).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":sr(this,Mn,"m",Yn).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":sr(this,Mn,"m",Qn).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Xn=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");if(!sr(this,zn,"f"))throw Error("Final run has not been received");return sr(this,zn,"f")},Qn=function(e){const[t,n]=sr(this,Mn,"m",nr).call(this,e,sr(this,Bn,"f"));ir(this,Bn,t,"f"),sr(this,Fn,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=sr(this,Zn,"f")){if(sr(this,qn,"f"))switch(sr(this,qn,"f").type){case"text":this._emit("textDone",sr(this,qn,"f").text,sr(this,Bn,"f"));break;case"image_file":this._emit("imageFileDone",sr(this,qn,"f").image_file,sr(this,Bn,"f"))}ir(this,Zn,n.index,"f")}ir(this,qn,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==sr(this,Zn,"f")){const t=e.data.content[sr(this,Zn,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,sr(this,Bn,"f"));break;case"text":this._emit("textDone",t.text,sr(this,Bn,"f"))}}sr(this,Bn,"f")&&this._emit("messageDone",e.data),ir(this,Bn,void 0,"f")}},Yn=function(e){const t=sr(this,Mn,"m",tr).call(this,e);switch(ir(this,Vn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==sr(this,Hn,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(sr(this,Wn,"f")&&this._emit("toolCallDone",sr(this,Wn,"f")),ir(this,Hn,e.index,"f"),ir(this,Wn,t.step_details.tool_calls[e.index],"f"),sr(this,Wn,"f")&&this._emit("toolCallCreated",sr(this,Wn,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ir(this,Vn,void 0,"f"),"tool_calls"==e.data.step_details.type&&sr(this,Wn,"f")&&(this._emit("toolCallDone",sr(this,Wn,"f")),ir(this,Wn,void 0,"f")),this._emit("runStepDone",e.data,t)}},er=function(e){sr(this,Un,"f").push(e),this._emit("event",e)},tr=function(e){switch(e.event){case"thread.run.step.created":return sr(this,Dn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=sr(this,Dn,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=or.accumulateDelta(t,n.delta);sr(this,Dn,"f")[e.data.id]=r}return sr(this,Dn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":sr(this,Dn,"f")[e.data.id]=e.data}if(sr(this,Dn,"f")[e.data.id])return sr(this,Dn,"f")[e.data.id];throw new Error("No snapshot available")},nr=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=sr(this,Mn,"m",rr).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},rr=function(e,t){return or.accumulateDelta(t,e)},ar=function(e){switch(ir(this,Jn,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ir(this,zn,e.data,"f"),sr(this,Wn,"f")&&(this._emit("toolCallDone",sr(this,Wn,"f")),ir(this,Wn,void 0,"f"))}};class cr extends Ze{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,lr,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class lr extends Ge{}cr.MessagesPage=lr;class ur extends Ze{retrieve(e,t,n,r={},a){return xe(r)?this.retrieve(e,t,n,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,n={},r){return xe(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,dr,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class dr extends Ge{}ur.RunStepsPage=dr;class hr extends Ze{constructor(){super(...arguments),this.steps=new ur(this._client)}create(e,t,n){const{include:r,...a}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,pr,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return or.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:s}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Te(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,n){return or.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const a=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,a.id,r)}submitToolOutputsStream(e,t,n,r){return or.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class pr extends Ge{}hr.RunsPage=pr,hr.Steps=ur,hr.RunStepsPage=dr;class fr extends Ze{constructor(){super(...arguments),this.runs=new hr(this._client),this.messages=new cr(this._client)}create(e={},t){return xe(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return or.createThreadAssistantStream(e,this._client.beta.threads,t)}}fr.Runs=hr,fr.RunsPage=pr,fr.Messages=cr,fr.MessagesPage=lr;class mr extends Ze{constructor(){super(...arguments),this.realtime=new Ln(this._client),this.chat=new jn(this._client),this.assistants=new Ot(this._client),this.threads=new fr(this._client)}}mr.Realtime=Ln,mr.Assistants=Ot,mr.AssistantsPage=St,mr.Threads=fr;class gr extends Ze{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/batches",yr,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class yr extends Ge{}gr.BatchesPage=yr;class br extends Ze{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,de({body:t,...n}))}}class _r extends Ze{constructor(){super(...arguments),this.parts=new br(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}function vr(e,t){const n=e.output.map((e=>{if("function_call"===e.type)return{...e,parsed_arguments:kr(t,e)};if("message"===e.type){const n=e.content.map((e=>"output_text"===e.type?{...e,parsed:wr(t,e.text)}:e));return{...e,content:n}}return e})),r=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||xr(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const e of r.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),r}function wr(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const n=e.text?.format;return n.$parseRaw(t)}return JSON.parse(t)}function kr(e,t){const n=(r=e.tools??[],a=t.name,r.find((e=>"function"===e.type&&e.name===a)));var r,a,s;return{...t,...t,parsed_arguments:(s=n,"auto-parseable-tool"===s?.$brand?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null)}}function xr(e){const t=[];for(const n of e.output)if("message"===n.type)for(const e of n.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}_r.Parts=br;class Er extends Ze{list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Ur,{query:t,...n})}}var Or,Sr,$r,Ir,Pr,Ar,Tr,Rr,jr,Nr=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},Cr=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Lr extends Wt{constructor(e){super(),Or.add(this),Sr.set(this,void 0),$r.set(this,void 0),Ir.set(this,void 0),Nr(this,Sr,e,"f")}static createResponse(e,t,n){const r=new Lr(t);return r._run((()=>r._createResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createResponse(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Cr(this,Or,"m",Pr).call(this);const a=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of a)Cr(this,Or,"m",Ar).call(this,e);if(a.controller.signal?.aborted)throw new L;return Cr(this,Or,"m",Tr).call(this)}[(Sr=new WeakMap,$r=new WeakMap,Ir=new WeakMap,Or=new WeakSet,Pr=function(){this.ended||Nr(this,$r,void 0,"f")},Ar=function(e){if(this.ended)return;const t=Cr(this,Or,"m",Rr).call(this,e);switch(this._emit("event",e),e.type){case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new N(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new N(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new N(`expected content to be 'output_text', got ${t.type}`);this._emit("response.output_text.delta",{...e,snapshot:t.text})}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new N(`missing output at index ${e.output_index}`);"function_call"===n.type&&this._emit("response.function_call_arguments.delta",{...e,snapshot:n.arguments});break}default:this._emit(e.type,e)}},Tr=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");const e=Cr(this,$r,"f");if(!e)throw new N("request ended without sending any events");Nr(this,$r,void 0,"f");const t=function(e,t){return function(e,t){return t&&function(e){return!!Gt(e.text?.format)}(t)?vr(e,t):{...e,output_parsed:null,output:e.output.map((e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map((e=>({...e,parsed:null})))}:e))}}(e,t)}(e,Cr(this,Sr,"f"));return Nr(this,Ir,t,"f"),t},Rr=function(e){let t=Cr(this,$r,"f");if(!t){if("response.created"!==e.type)throw new N(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=Nr(this,$r,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new N(`missing output at index ${e.output_index}`);"message"===n.type&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new N(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new N(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new N(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new N(`missing output at index ${e.output_index}`);"function_call"===n.type&&(n.arguments+=e.delta);break}case"response.completed":Nr(this,$r,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Cr(this,Ir,"f");if(!e)throw new N("stream ended without producing a ChatCompletion");return e}}class Mr extends Ze{constructor(){super(...arguments),this.inputItems=new Er(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap((e=>("object"in e&&"response"===e.object&&xr(e),e)))}retrieve(e,t={},n){return xe(t)?this.retrieve(e,{},t):this._client.get(`/responses/${e}`,{query:t,...n})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap((t=>vr(t,e)))}stream(e,t){return Lr.createResponse(this._client,e,t)}}class Ur extends Ge{}Mr.InputItems=Er;class Dr extends Ze{retrieve(e,t,n,r){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,r)}list(e,t,n={},r){return xe(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Fr,{query:n,...r})}}class Fr extends Ge{}Dr.OutputItemListResponsesPage=Fr;class Br extends Ze{constructor(){super(...arguments),this.outputItems=new Dr(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,zr,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}}class zr extends Ge{}Br.RunListResponsesPage=zr,Br.OutputItems=Dr,Br.OutputItemListResponsesPage=Fr;class Zr extends Ze{constructor(){super(...arguments),this.runs=new Br(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/evals",qr,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class qr extends Ge{}Zr.EvalListResponsesPage=qr,Zr.Runs=Br,Zr.RunListResponsesPage=zr;class Hr extends be{constructor({baseURL:e=Ne("OPENAI_BASE_URL"),apiKey:t=Ne("OPENAI_API_KEY"),organization:n=Ne("OPENAI_ORG_ID")??null,project:r=Ne("OPENAI_PROJECT_ID")??null,...a}={}){if(void 0===t)throw new N("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const s={apiKey:t,organization:n,project:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new N("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new qe(this),this.chat=new Xe(this),this.embeddings=new Qe(this),this.files=new Ye(this),this.images=new tt(this),this.audio=new st(this),this.moderations=new it(this),this.models=new ot(this),this.fineTuning=new yt(this),this.vectorStores=new kt(this),this.beta=new mr(this),this.batches=new gr(this),this.uploads=new _r(this),this.responses=new Mr(this),this.evals=new Zr(this),this._options=s,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,n={}){let a=e;const s=function(e=f){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const n=e.charset||f.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let a=t;if(void 0!==e.format){if(!c.call(r,e.format))throw new TypeError("Unknown format option provided.");a=e.format}const s=r[a];let i,o=f.filter;if(("function"==typeof e.filter||u(e.filter))&&(o=e.filter),i=e.arrayFormat&&e.arrayFormat in l?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":f.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const d=void 0===e.allowDots?1==!!e.encodeDotInKeys||f.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:f.addQueryPrefix,allowDots:d,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:f.allowEmptyArrays,arrayFormat:i,charset:n,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:f.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?f.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:f.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:f.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:f.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:f.encodeValuesOnly,filter:o,format:a,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:f.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:f.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:f.strictNullHandling}}(n);let i,o;"function"==typeof s.filter?(o=s.filter,a=o("",a)):u(s.filter)&&(o=s.filter,i=o);const d=[];if("object"!=typeof a||null===a)return"";const p=l[s.arrayFormat],m="comma"===p&&s.commaRoundTrip;i||(i=Object.keys(a)),s.sort&&i.sort(s.sort);const y=new WeakMap;for(let e=0;e<i.length;++e){const t=i[e];s.skipNulls&&null===a[t]||h(d,g(a[t],t,p,m,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,y))}const b=d.join(s.delimiter);let _=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?_+="utf8=%26%2310003%3B&":_+="utf8=%E2%9C%93&"),b.length>0?_+b:""}(e,{arrayFormat:"brackets"})}}function Wr(e,t=Gr){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function Gr(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,a=!1;for(let s of e){if(r)'"'!==s||a?"\n"!==s||a?a="\\"===s&&!a:s="\\n":r=!1;else if('"'===s)r=!0,a=!1;else if("{"===s)n.push("}");else if("["===s)n.push("]");else if("}"===s||"]"===s){if(!n||n[n.length-1]!==s)return null;n.pop()}t+=s}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}jr=Hr,Hr.OpenAI=jr,Hr.DEFAULT_TIMEOUT=6e5,Hr.OpenAIError=N,Hr.APIError=C,Hr.APIConnectionError=M,Hr.APIConnectionTimeoutError=U,Hr.APIUserAbortError=L,Hr.NotFoundError=z,Hr.ConflictError=Z,Hr.RateLimitError=H,Hr.BadRequestError=D,Hr.AuthenticationError=F,Hr.InternalServerError=W,Hr.PermissionDeniedError=B,Hr.UnprocessableEntityError=q,Hr.toFile=oe,Hr.fileFromPath=O,Hr.Completions=qe,Hr.Chat=Xe,Hr.ChatCompletionsPage=Ve,Hr.Embeddings=Qe,Hr.Files=Ye,Hr.FileObjectsPage=et,Hr.Images=tt,Hr.Audio=st,Hr.Moderations=it,Hr.Models=ot,Hr.ModelsPage=ct,Hr.FineTuning=yt,Hr.VectorStores=kt,Hr.VectorStoresPage=xt,Hr.VectorStoreSearchResponsesPage=Et,Hr.Beta=mr,Hr.Batches=gr,Hr.BatchesPage=yr,Hr.Uploads=_r,Hr.Responses=Mr,Hr.Evals=Zr,Hr.EvalListResponsesPage=qr,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]);var Jr,Vr,Kr=n(79478);function Xr(e,t){return t?.[e]||Kr(e)}function Qr(e,t,n){const r={};for(const a in e)Object.hasOwn(e,a)&&(r[t(a,n)]=e[a]);return r}function Yr(e){return Array.isArray(e)?[...e]:{...e}}function ea(e,t){const n=Yr(e);for(const[e,r]of Object.entries(t)){const[t,...a]=e.split(".").reverse();let s=n;for(const e of a.reverse()){if(void 0===s[e])break;s[e]=Yr(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[r]})}return n}function ta(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}n(12729);class na{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ta(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter((([e])=>this.lc_serializable_keys?.includes(e)))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof na||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[a,...s]=e.split(".").reverse();for(const e of s.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}a in t&&void 0!==t[a]&&(r[a]=r[a]||t[a])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:Qr(Object.keys(t).length?ea(n,t):n,Xr,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function ra(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function aa(e){return ra(e)&&"base64"===e.source_type&&"data"in e&&"string"==typeof e.data}function sa(e){if(ra(e)){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url}};if("base64"===e.source_type){if(!e.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${e.mime_type};base64,${e.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function ia(e){const t=e.split(";")[0].split("/");if(2!==t.length)throw new Error(`Invalid mime type: "${e}" - does not match type/subtype format.`);const n=t[0].trim(),r=t[1].trim();if(""===n||""===r)throw new Error(`Invalid mime type: "${e}" - type or subtype is empty.`);const a={};for(const t of e.split(";").slice(1)){const n=t.split("=");if(2!==n.length)throw new Error(`Invalid parameter syntax in mime type: "${e}".`);const r=n[0].trim(),s=n[1].trim();if(""===r)throw new Error(`Invalid parameter syntax in mime type: "${e}".`);a[r]=s}return{type:n,subtype:r,parameters:a}}function oa({dataUrl:e,asTypedArray:t=!1}){const n=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(n)return r=n[1].toLowerCase(),{mime_type:r,data:t?Uint8Array.from(atob(n[2]),(e=>e.charCodeAt(0))):n[2]}}function ca(e,t){if("text"===e.type){if(!t.fromStandardTextBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardTextBlock\` method.`);return t.fromStandardTextBlock(e)}if("image"===e.type){if(!t.fromStandardImageBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardImageBlock\` method.`);return t.fromStandardImageBlock(e)}if("audio"===e.type){if(!t.fromStandardAudioBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardAudioBlock\` method.`);return t.fromStandardAudioBlock(e)}if("file"===e.type){if(!t.fromStandardFileBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardFileBlock\` method.`);return t.fromStandardFileBlock(e)}throw new Error(`Unable to convert content block type '${e.type}' to provider-specific format: not recognized.`)}function la(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some((e=>ra(e)))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?ha(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some((e=>ra(e)))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}class ua extends na{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map((e=>"string"==typeof e?e:"text"===e.type?e.text:"")).join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=(n=this._printableFields,r=Math.max(4,e),JSON.stringify(function e(t,n){if("object"!=typeof t||null==t)return t;if(n>=r)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map((t=>e(t,n+1)));const a={};for(const r of Object.keys(t))a[r]=e(t[r],n+1);return a}(n,0),null,2));var n,r;return`${this.constructor.lc_name()} ${t}`}}function da(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e]){if("type"===e)continue;n[e]+=r}else if("object"!=typeof n[e]||Array.isArray(n[e]))if(Array.isArray(n[e]))n[e]=ha(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=da(n[e],r)}return n}function ha(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=da(n[t],e):n.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;n.push(e)}return n}}}function pa(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return ha(e,t);if("object"==typeof e&&"object"==typeof t)return da(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class fa extends ua{}function ma(e){return"function"==typeof e?._getType}class ga extends ua{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,n){"string"==typeof e&&(e={content:e,name:n,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class ya extends fa{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new ya({content:la(this.content,e.content),additional_kwargs:da(this.additional_kwargs,e.additional_kwargs),response_metadata:da(this.response_metadata,e.response_metadata),artifact:pa(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(t=this.status,n=e.status,"error"===t||"error"===n?"error":"success")});var t,n}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class ba extends ua{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function _a(e){return"ai"===e._getType()}function va(e){return"ai"===e._getType()}class wa extends fa{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const n=[],r=[];for(const t of e.tool_call_chunks){let e={};try{if(e=Gr(t.args||"{}"),null===e||"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){r.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:n,invalid_tool_calls:r,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:la(this.content,e.content),additional_kwargs:da(this.additional_kwargs,e.additional_kwargs),response_metadata:da(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=ha(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const n={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},r={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},a=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i={input_tokens:a.input_tokens+s.input_tokens,output_tokens:a.output_tokens+s.output_tokens,total_tokens:a.total_tokens+s.total_tokens,...Object.keys(n).length>0&&{input_token_details:n},...Object.keys(r).length>0&&{output_token_details:r}};t.usage_metadata=i}return new wa(t)}}class ka extends ua{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return ka}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class xa extends fa{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new xa({content:la(this.content,e.content),additional_kwargs:da(this.additional_kwargs,e.additional_kwargs),response_metadata:da(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class Ea extends fa{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Ea({content:la(this.content,e.content),additional_kwargs:da(this.additional_kwargs,e.additional_kwargs),response_metadata:da(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class Oa extends ua{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class Sa extends fa{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new Sa({content:la(this.content,e.content),additional_kwargs:da(this.additional_kwargs,e.additional_kwargs),response_metadata:da(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class $a extends ua{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}class Ia extends fa{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new Ia({content:la(this.content,e.content),additional_kwargs:da(this.additional_kwargs,e.additional_kwargs),response_metadata:da(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function Pa(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function Aa(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}class Ta extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function Ra(e){return Aa(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function ja(e){let t,n;if("object"==typeof(r=e)&&null!=r&&1===r.lc&&Array.isArray(r.id)&&null!=r.kwargs&&"object"==typeof r.kwargs){const r=e.id.at(-1);t="HumanMessage"===r||"HumanMessageChunk"===r?"user":"AIMessage"===r||"AIMessageChunk"===r?"assistant":"SystemMessage"===r||"SystemMessageChunk"===r?"system":"FunctionMessage"===r||"FunctionMessageChunk"===r?"function":"ToolMessage"===r||"ToolMessageChunk"===r?"tool":"unknown",n=e.kwargs}else{const{type:r,...a}=e;t=r,n=a}var r;if("human"===t||"user"===t)return new Oa(n);if("ai"===t||"assistant"===t){const{tool_calls:e,...t}=n;if(!Array.isArray(e))return new ba(n);const r=e.map(Ra);return new ba({...t,tool_calls:r})}if("system"===t)return new $a(n);if("developer"===t)return new $a({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in n)return new ga({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});throw Pa(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.\n\nReceived: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function Na(e){if("string"==typeof e)return new Oa(e);if(ma(e))return e;if(Array.isArray(e)){const[t,n]=e;return ja({type:t,content:n})}if("string"==typeof e.role){const{role:t,...n}=e;return ja({...n,type:t})}return ja(e)}function Ca(e,t="Human",n="AI"){const r=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=n;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const s=a.name?`${a.name}, `:"",i="string"==typeof a.content?a.content:JSON.stringify(a.content,null,2);r.push(`${e}: ${s}${i}`)}return r.join("\n")}function La(e){const t=e._getType();if("human"===t)return new Sa({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map((e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)})))}),new wa({...t})}if("system"===t)return new Ia({...e});if("function"===t)return new Ea({...e});if(ka.isInstance(e))return new xa({...e});throw new Error("Unknown message type.")}!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(Jr||(Jr={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Vr||(Vr={}));const Ma=Jr.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ua=e=>{switch(typeof e){case"undefined":return Ma.undefined;case"string":return Ma.string;case"number":return isNaN(e)?Ma.nan:Ma.number;case"boolean":return Ma.boolean;case"function":return Ma.function;case"bigint":return Ma.bigint;case"symbol":return Ma.symbol;case"object":return Array.isArray(e)?Ma.array:null===e?Ma.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?Ma.promise:"undefined"!=typeof Map&&e instanceof Map?Ma.map:"undefined"!=typeof Set&&e instanceof Set?Ma.set:"undefined"!=typeof Date&&e instanceof Date?Ma.date:Ma.object;default:return Ma.unknown}},Da=Jr.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Fa extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const a of e.issues)if("invalid_union"===a.code)a.unionErrors.map(r);else if("invalid_return_type"===a.code)r(a.returnTypeError);else if("invalid_arguments"===a.code)r(a.argumentsError);else if(0===a.path.length)n._errors.push(t(a));else{let e=n,r=0;for(;r<a.path.length;){const n=a.path[r];r===a.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(a))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof Fa))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Jr.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Fa.create=e=>new Fa(e);const Ba=(e,t)=>{let n;switch(e.code){case Da.invalid_type:n=e.received===Ma.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Da.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,Jr.jsonStringifyReplacer)}`;break;case Da.unrecognized_keys:n=`Unrecognized key(s) in object: ${Jr.joinValues(e.keys,", ")}`;break;case Da.invalid_union:n="Invalid input";break;case Da.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${Jr.joinValues(e.options)}`;break;case Da.invalid_enum_value:n=`Invalid enum value. Expected ${Jr.joinValues(e.options)}, received '${e.received}'`;break;case Da.invalid_arguments:n="Invalid function arguments";break;case Da.invalid_return_type:n="Invalid function return type";break;case Da.invalid_date:n="Invalid date";break;case Da.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:Jr.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Da.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Da.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Da.custom:n="Invalid input";break;case Da.invalid_intersection_types:n="Intersection results could not be merged";break;case Da.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Da.not_finite:n="Number must be finite";break;default:n=t.defaultError,Jr.assertNever(e)}return{message:n}};let za=Ba;function Za(){return za}const qa=e=>{const{data:t,path:n,errorMaps:r,issueData:a}=e,s=[...n,...a.path||[]],i={...a,path:s};if(void 0!==a.message)return{...a,path:s,message:a.message};let o="";const c=r.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...a,path:s,message:o}};function Ha(e,t){const n=Za(),r=qa({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Ba?void 0:Ba].filter((e=>!!e))});e.common.issues.push(r)}class Wa{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return Ga;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return Wa.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:a}=r;if("aborted"===t.status)return Ga;if("aborted"===a.status)return Ga;"dirty"===t.status&&e.dirty(),"dirty"===a.status&&e.dirty(),"__proto__"===t.value||void 0===a.value&&!r.alwaysSet||(n[t.value]=a.value)}return{status:e.value,value:n}}}const Ga=Object.freeze({status:"aborted"}),Ja=e=>({status:"dirty",value:e}),Va=e=>({status:"valid",value:e}),Ka=e=>"aborted"===e.status,Xa=e=>"dirty"===e.status,Qa=e=>"valid"===e.status,Ya=e=>"undefined"!=typeof Promise&&e instanceof Promise;function es(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function ts(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n}var ns,rs,as;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(ns||(ns={}));class ss{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const is=(e,t)=>{if(Qa(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Fa(e.common.issues);return this._error=t,this._error}}};function os(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:a}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:a}:{errorMap:(t,a)=>{var s,i;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:a.defaultError}:void 0===a.data?{message:null!==(s=null!=o?o:r)&&void 0!==s?s:a.defaultError}:"invalid_type"!==t.code?{message:a.defaultError}:{message:null!==(i=null!=o?o:n)&&void 0!==i?i:a.defaultError}},description:a}}class cs{get description(){return this._def.description}_getType(e){return Ua(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Ua(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Wa,ctx:{common:e.parent.common,data:e.data,parsedType:Ua(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Ya(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ua(e)},a=this._parseSync({data:e,path:r.path,parent:r});return is(r,a)}"~validate"(e){var t,n;const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ua(e)};if(!this["~standard"].async)try{const t=this._parseSync({data:e,path:[],parent:r});return Qa(t)?{value:t.value}:{issues:r.common.issues}}catch(e){(null===(n=null===(t=null==e?void 0:e.message)||void 0===t?void 0:t.toLowerCase())||void 0===n?void 0:n.includes("encountered"))&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:r}).then((e=>Qa(e)?{value:e.value}:{issues:r.common.issues}))}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ua(e)},r=this._parse({data:e,path:n.path,parent:n}),a=await(Ya(r)?r:Promise.resolve(r));return is(n,a)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const a=e(t),s=()=>r.addIssue({code:Da.custom,...n(t)});return"undefined"!=typeof Promise&&a instanceof Promise?a.then((e=>!!e||(s(),!1))):!!a||(s(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new ci({schema:this,typeName:wi.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return li.create(this,this._def)}nullable(){return ui.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Zs.create(this)}promise(){return oi.create(this,this._def)}or(e){return Ws.create([this,e],this._def)}and(e){return Ks.create(this,e,this._def)}transform(e){return new ci({...os(this._def),schema:this,typeName:wi.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new di({...os(this._def),innerType:this,defaultValue:t,typeName:wi.ZodDefault})}brand(){return new mi({typeName:wi.ZodBranded,type:this,...os(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new hi({...os(this._def),innerType:this,catchValue:t,typeName:wi.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return gi.create(this,e)}readonly(){return yi.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ls=/^c[^\s-]{8,}$/i,us=/^[0-9a-z]+$/,ds=/^[0-9A-HJKMNP-TV-Z]{26}$/i,hs=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,ps=/^[a-z0-9_-]{21}$/i,fs=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,ms=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,gs=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let ys;const bs=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,_s=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,vs=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,ws=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ks=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,xs=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Es="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Os=new RegExp(`^${Es}$`);function Ss(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function $s(e){let t=`${Es}T${Ss(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function Is(e,t){if(!fs.test(e))return!1;try{const[n]=e.split("."),r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),a=JSON.parse(atob(r));return!("object"!=typeof a||null===a||!a.typ||!a.alg||t&&a.alg!==t)}catch(e){return!1}}function Ps(e,t){return!("v4"!==t&&t||!_s.test(e))||!("v6"!==t&&t||!ws.test(e))}class As extends cs{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==Ma.string){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.string,received:t.parsedType}),Ga}const t=new Wa;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,a=e.data.length<s.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?Ha(n,{code:Da.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&Ha(n,{code:Da.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)gs.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"email",code:Da.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)ys||(ys=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ys.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"emoji",code:Da.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)hs.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"uuid",code:Da.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)ps.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"nanoid",code:Da.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)ls.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"cuid",code:Da.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)us.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"cuid2",code:Da.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)ds.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"ulid",code:Da.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch(r){n=this._getOrReturnCtx(e,n),Ha(n,{validation:"url",code:Da.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"regex",code:Da.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?$s(s).test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?Os.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?new RegExp(`^${Ss(s)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?ms.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"duration",code:Da.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?(r=e.data,("v4"!==(a=s.version)&&a||!bs.test(r))&&("v6"!==a&&a||!vs.test(r))&&(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"ip",code:Da.invalid_string,message:s.message}),t.dirty())):"jwt"===s.kind?Is(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"jwt",code:Da.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?Ps(e.data,s.version)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"cidr",code:Da.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?ks.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"base64",code:Da.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?xs.test(e.data)||(n=this._getOrReturnCtx(e,n),Ha(n,{validation:"base64url",code:Da.invalid_string,message:s.message}),t.dirty()):Jr.assertNever(s);var r,a;return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:Da.invalid_string,...ns.errToObj(n)})}_addCheck(e){return new As({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...ns.errToObj(e)})}url(e){return this._addCheck({kind:"url",...ns.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...ns.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...ns.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...ns.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...ns.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...ns.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...ns.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...ns.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...ns.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...ns.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...ns.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...ns.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...ns.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...ns.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...ns.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...ns.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...ns.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...ns.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...ns.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...ns.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...ns.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...ns.errToObj(t)})}nonempty(e){return this.min(1,ns.errToObj(e))}trim(){return new As({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new As({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new As({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isCIDR(){return!!this._def.checks.find((e=>"cidr"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get isBase64url(){return!!this._def.checks.find((e=>"base64url"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Ts(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,a=n>r?n:r;return parseInt(e.toFixed(a).replace(".",""))%parseInt(t.toFixed(a).replace(".",""))/Math.pow(10,a)}As.create=e=>{var t;return new As({checks:[],typeName:wi.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...os(e)})};class Rs extends cs{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==Ma.number){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.number,received:t.parsedType}),Ga}let t;const n=new Wa;for(const r of this._def.checks)"int"===r.kind?Jr.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty()):"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"multipleOf"===r.kind?0!==Ts(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.not_finite,message:r.message}),n.dirty()):Jr.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,ns.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ns.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ns.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ns.toString(t))}setLimit(e,t,n,r){return new Rs({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:ns.toString(r)}]})}_addCheck(e){return new Rs({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:ns.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ns.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ns.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ns.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ns.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ns.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:ns.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ns.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ns.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&Jr.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Rs.create=e=>new Rs({checks:[],typeName:wi.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...os(e)});class js extends cs{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(t){return this._getInvalidInput(e)}if(this._getType(e)!==Ma.bigint)return this._getInvalidInput(e);let t;const n=new Wa;for(const r of this._def.checks)"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),Ha(t,{code:Da.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):Jr.assertNever(r);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.bigint,received:t.parsedType}),Ga}gte(e,t){return this.setLimit("min",e,!0,ns.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ns.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ns.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ns.toString(t))}setLimit(e,t,n,r){return new js({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:ns.toString(r)}]})}_addCheck(e){return new js({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ns.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ns.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ns.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ns.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ns.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}js.create=e=>{var t;return new js({checks:[],typeName:wi.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...os(e)})};class Ns extends cs{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==Ma.boolean){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.boolean,received:t.parsedType}),Ga}return Va(e.data)}}Ns.create=e=>new Ns({typeName:wi.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...os(e)});class Cs extends cs{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==Ma.date){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.date,received:t.parsedType}),Ga}if(isNaN(e.data.getTime()))return Ha(this._getOrReturnCtx(e),{code:Da.invalid_date}),Ga;const t=new Wa;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),Ha(n,{code:Da.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):Jr.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Cs({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:ns.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:ns.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Cs.create=e=>new Cs({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:wi.ZodDate,...os(e)});class Ls extends cs{_parse(e){if(this._getType(e)!==Ma.symbol){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.symbol,received:t.parsedType}),Ga}return Va(e.data)}}Ls.create=e=>new Ls({typeName:wi.ZodSymbol,...os(e)});class Ms extends cs{_parse(e){if(this._getType(e)!==Ma.undefined){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.undefined,received:t.parsedType}),Ga}return Va(e.data)}}Ms.create=e=>new Ms({typeName:wi.ZodUndefined,...os(e)});class Us extends cs{_parse(e){if(this._getType(e)!==Ma.null){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.null,received:t.parsedType}),Ga}return Va(e.data)}}Us.create=e=>new Us({typeName:wi.ZodNull,...os(e)});class Ds extends cs{constructor(){super(...arguments),this._any=!0}_parse(e){return Va(e.data)}}Ds.create=e=>new Ds({typeName:wi.ZodAny,...os(e)});class Fs extends cs{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Va(e.data)}}Fs.create=e=>new Fs({typeName:wi.ZodUnknown,...os(e)});class Bs extends cs{_parse(e){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.never,received:t.parsedType}),Ga}}Bs.create=e=>new Bs({typeName:wi.ZodNever,...os(e)});class zs extends cs{_parse(e){if(this._getType(e)!==Ma.undefined){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.void,received:t.parsedType}),Ga}return Va(e.data)}}zs.create=e=>new zs({typeName:wi.ZodVoid,...os(e)});class Zs extends cs{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==Ma.array)return Ha(t,{code:Da.invalid_type,expected:Ma.array,received:t.parsedType}),Ga;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,a=t.data.length<r.exactLength.value;(e||a)&&(Ha(t,{code:e?Da.too_big:Da.too_small,minimum:a?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(Ha(t,{code:Da.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(Ha(t,{code:Da.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new ss(t,e,t.path,n))))).then((e=>Wa.mergeArray(n,e)));const a=[...t.data].map(((e,n)=>r.type._parseSync(new ss(t,e,t.path,n))));return Wa.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new Zs({...this._def,minLength:{value:e,message:ns.toString(t)}})}max(e,t){return new Zs({...this._def,maxLength:{value:e,message:ns.toString(t)}})}length(e,t){return new Zs({...this._def,exactLength:{value:e,message:ns.toString(t)}})}nonempty(e){return this.min(1,e)}}function qs(e){if(e instanceof Hs){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=li.create(qs(r))}return new Hs({...e._def,shape:()=>t})}return e instanceof Zs?new Zs({...e._def,type:qs(e.element)}):e instanceof li?li.create(qs(e.unwrap())):e instanceof ui?ui.create(qs(e.unwrap())):e instanceof Xs?Xs.create(e.items.map((e=>qs(e)))):e}Zs.create=(e,t)=>new Zs({type:e,minLength:null,maxLength:null,exactLength:null,typeName:wi.ZodArray,...os(t)});class Hs extends cs{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=Jr.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==Ma.object){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.object,received:t.parsedType}),Ga}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:a}=this._getCached(),s=[];if(!(this._def.catchall instanceof Bs&&"strip"===this._def.unknownKeys))for(const e in n.data)a.includes(e)||s.push(e);const i=[];for(const e of a){const t=r[e],a=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new ss(n,a,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof Bs){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)s.length>0&&(Ha(n,{code:Da.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const r=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new ss(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of i){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>Wa.mergeObjectSync(t,e))):Wa.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return ns.errToObj,new Hs({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,a,s,i;const o=null!==(s=null===(a=(r=this._def).errorMap)||void 0===a?void 0:a.call(r,t,n).message)&&void 0!==s?s:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(i=ns.errToObj(e).message)&&void 0!==i?i:o}:{message:o}}}:{}})}strip(){return new Hs({...this._def,unknownKeys:"strip"})}passthrough(){return new Hs({...this._def,unknownKeys:"passthrough"})}extend(e){return new Hs({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Hs({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:wi.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Hs({...this._def,catchall:e})}pick(e){const t={};return Jr.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new Hs({...this._def,shape:()=>t})}omit(e){const t={};return Jr.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new Hs({...this._def,shape:()=>t})}deepPartial(){return qs(this)}partial(e){const t={};return Jr.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new Hs({...this._def,shape:()=>t})}required(e){const t={};return Jr.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof li;)e=e._def.innerType;t[n]=e}})),new Hs({...this._def,shape:()=>t})}keyof(){return ai(Jr.objectKeys(this.shape))}}Hs.create=(e,t)=>new Hs({shape:()=>e,unknownKeys:"strip",catchall:Bs.create(),typeName:wi.ZodObject,...os(t)}),Hs.strictCreate=(e,t)=>new Hs({shape:()=>e,unknownKeys:"strict",catchall:Bs.create(),typeName:wi.ZodObject,...os(t)}),Hs.lazycreate=(e,t)=>new Hs({shape:e,unknownKeys:"strip",catchall:Bs.create(),typeName:wi.ZodObject,...os(t)});class Ws extends cs{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new Fa(e.ctx.common.issues)));return Ha(t,{code:Da.invalid_union,unionErrors:n}),Ga}));{let e;const r=[];for(const a of n){const n={...t,common:{...t.common,issues:[]},parent:null},s=a._parseSync({data:t.data,path:t.path,parent:n});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=r.map((e=>new Fa(e)));return Ha(t,{code:Da.invalid_union,unionErrors:a}),Ga}}get options(){return this._def.options}}Ws.create=(e,t)=>new Ws({options:e,typeName:wi.ZodUnion,...os(t)});const Gs=e=>e instanceof ni?Gs(e.schema):e instanceof ci?Gs(e.innerType()):e instanceof ri?[e.value]:e instanceof si?e.options:e instanceof ii?Jr.objectValues(e.enum):e instanceof di?Gs(e._def.innerType):e instanceof Ms?[void 0]:e instanceof Us?[null]:e instanceof li?[void 0,...Gs(e.unwrap())]:e instanceof ui?[null,...Gs(e.unwrap())]:e instanceof mi||e instanceof yi?Gs(e.unwrap()):e instanceof hi?Gs(e._def.innerType):[];class Js extends cs{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Ma.object)return Ha(t,{code:Da.invalid_type,expected:Ma.object,received:t.parsedType}),Ga;const n=this.discriminator,r=t.data[n],a=this.optionsMap.get(r);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(Ha(t,{code:Da.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),Ga)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=Gs(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const a of t){if(r.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);r.set(a,n)}}return new Js({typeName:wi.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...os(n)})}}function Vs(e,t){const n=Ua(e),r=Ua(t);if(e===t)return{valid:!0,data:e};if(n===Ma.object&&r===Ma.object){const n=Jr.objectKeys(t),r=Jr.objectKeys(e).filter((e=>-1!==n.indexOf(e))),a={...e,...t};for(const n of r){const r=Vs(e[n],t[n]);if(!r.valid)return{valid:!1};a[n]=r.data}return{valid:!0,data:a}}if(n===Ma.array&&r===Ma.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const a=Vs(e[r],t[r]);if(!a.valid)return{valid:!1};n.push(a.data)}return{valid:!0,data:n}}return n===Ma.date&&r===Ma.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class Ks extends cs{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(Ka(e)||Ka(r))return Ga;const a=Vs(e.value,r.value);return a.valid?((Xa(e)||Xa(r))&&t.dirty(),{status:t.value,value:a.data}):(Ha(n,{code:Da.invalid_intersection_types}),Ga)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Ks.create=(e,t,n)=>new Ks({left:e,right:t,typeName:wi.ZodIntersection,...os(n)});class Xs extends cs{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Ma.array)return Ha(n,{code:Da.invalid_type,expected:Ma.array,received:n.parsedType}),Ga;if(n.data.length<this._def.items.length)return Ha(n,{code:Da.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Ga;!this._def.rest&&n.data.length>this._def.items.length&&(Ha(n,{code:Da.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new ss(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>Wa.mergeArray(t,e))):Wa.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Xs({...this._def,rest:e})}}Xs.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Xs({items:e,typeName:wi.ZodTuple,rest:null,...os(t)})};class Qs extends cs{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Ma.object)return Ha(n,{code:Da.invalid_type,expected:Ma.object,received:n.parsedType}),Ga;const r=[],a=this._def.keyType,s=this._def.valueType;for(const e in n.data)r.push({key:a._parse(new ss(n,e,n.path,e)),value:s._parse(new ss(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?Wa.mergeObjectAsync(t,r):Wa.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new Qs(t instanceof cs?{keyType:e,valueType:t,typeName:wi.ZodRecord,...os(n)}:{keyType:As.create(),valueType:e,typeName:wi.ZodRecord,...os(t)})}}class Ys extends cs{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Ma.map)return Ha(n,{code:Da.invalid_type,expected:Ma.map,received:n.parsedType}),Ga;const r=this._def.keyType,a=this._def.valueType,s=[...n.data.entries()].map((([e,t],s)=>({key:r._parse(new ss(n,e,n.path,[s,"key"])),value:a._parse(new ss(n,t,n.path,[s,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of s){const r=await n.key,a=await n.value;if("aborted"===r.status||"aborted"===a.status)return Ga;"dirty"!==r.status&&"dirty"!==a.status||t.dirty(),e.set(r.value,a.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of s){const r=n.key,a=n.value;if("aborted"===r.status||"aborted"===a.status)return Ga;"dirty"!==r.status&&"dirty"!==a.status||t.dirty(),e.set(r.value,a.value)}return{status:t.value,value:e}}}}Ys.create=(e,t,n)=>new Ys({valueType:t,keyType:e,typeName:wi.ZodMap,...os(n)});class ei extends cs{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Ma.set)return Ha(n,{code:Da.invalid_type,expected:Ma.set,received:n.parsedType}),Ga;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(Ha(n,{code:Da.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(Ha(n,{code:Da.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const a=this._def.valueType;function s(e){const n=new Set;for(const r of e){if("aborted"===r.status)return Ga;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map(((e,t)=>a._parse(new ss(n,e,n.path,t))));return n.common.async?Promise.all(i).then((e=>s(e))):s(i)}min(e,t){return new ei({...this._def,minSize:{value:e,message:ns.toString(t)}})}max(e,t){return new ei({...this._def,maxSize:{value:e,message:ns.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}ei.create=(e,t)=>new ei({valueType:e,minSize:null,maxSize:null,typeName:wi.ZodSet,...os(t)});class ti extends cs{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Ma.function)return Ha(t,{code:Da.invalid_type,expected:Ma.function,received:t.parsedType}),Ga;function n(e,n){return qa({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Za(),Ba].filter((e=>!!e)),issueData:{code:Da.invalid_arguments,argumentsError:n}})}function r(e,n){return qa({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Za(),Ba].filter((e=>!!e)),issueData:{code:Da.invalid_return_type,returnTypeError:n}})}const a={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof oi){const e=this;return Va((async function(...t){const i=new Fa([]),o=await e._def.args.parseAsync(t,a).catch((e=>{throw i.addIssue(n(t,e)),i})),c=await Reflect.apply(s,this,o);return await e._def.returns._def.type.parseAsync(c,a).catch((e=>{throw i.addIssue(r(c,e)),i}))}))}{const e=this;return Va((function(...t){const i=e._def.args.safeParse(t,a);if(!i.success)throw new Fa([n(t,i.error)]);const o=Reflect.apply(s,this,i.data),c=e._def.returns.safeParse(o,a);if(!c.success)throw new Fa([r(o,c.error)]);return c.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new ti({...this._def,args:Xs.create(e).rest(Fs.create())})}returns(e){return new ti({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new ti({args:e||Xs.create([]).rest(Fs.create()),returns:t||Fs.create(),typeName:wi.ZodFunction,...os(n)})}}class ni extends cs{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ni.create=(e,t)=>new ni({getter:e,typeName:wi.ZodLazy,...os(t)});class ri extends cs{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return Ha(t,{received:t.data,code:Da.invalid_literal,expected:this._def.value}),Ga}return{status:"valid",value:e.data}}get value(){return this._def.value}}function ai(e,t){return new si({values:e,typeName:wi.ZodEnum,...os(t)})}ri.create=(e,t)=>new ri({value:e,typeName:wi.ZodLiteral,...os(t)});class si extends cs{constructor(){super(...arguments),rs.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return Ha(t,{expected:Jr.joinValues(n),received:t.parsedType,code:Da.invalid_type}),Ga}if(es(this,rs,"f")||ts(this,rs,new Set(this._def.values),"f"),!es(this,rs,"f").has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return Ha(t,{received:t.data,code:Da.invalid_enum_value,options:n}),Ga}return Va(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return si.create(e,{...this._def,...t})}exclude(e,t=this._def){return si.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}rs=new WeakMap,si.create=ai;class ii extends cs{constructor(){super(...arguments),as.set(this,void 0)}_parse(e){const t=Jr.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==Ma.string&&n.parsedType!==Ma.number){const e=Jr.objectValues(t);return Ha(n,{expected:Jr.joinValues(e),received:n.parsedType,code:Da.invalid_type}),Ga}if(es(this,as,"f")||ts(this,as,new Set(Jr.getValidEnumValues(this._def.values)),"f"),!es(this,as,"f").has(e.data)){const e=Jr.objectValues(t);return Ha(n,{received:n.data,code:Da.invalid_enum_value,options:e}),Ga}return Va(e.data)}get enum(){return this._def.values}}as=new WeakMap,ii.create=(e,t)=>new ii({values:e,typeName:wi.ZodNativeEnum,...os(t)});class oi extends cs{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Ma.promise&&!1===t.common.async)return Ha(t,{code:Da.invalid_type,expected:Ma.promise,received:t.parsedType}),Ga;const n=t.parsedType===Ma.promise?t.data:Promise.resolve(t.data);return Va(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}oi.create=(e,t)=>new oi({type:e,typeName:wi.ZodPromise,...os(t)});class ci extends cs{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===wi.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,a={addIssue:e=>{Ha(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),"preprocess"===r.type){const e=r.transform(n.data,a);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return Ga;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?Ga:"dirty"===r.status||"dirty"===t.value?Ja(r.value):r}));{if("aborted"===t.value)return Ga;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?Ga:"dirty"===r.status||"dirty"===t.value?Ja(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,a);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?Ga:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?Ga:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Qa(e))return e;const s=r.transform(e.value,a);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>Qa(e)?Promise.resolve(r.transform(e.value,a)).then((e=>({status:t.value,value:e}))):e))}Jr.assertNever(r)}}ci.create=(e,t,n)=>new ci({schema:e,typeName:wi.ZodEffects,effect:t,...os(n)}),ci.createWithPreprocess=(e,t,n)=>new ci({schema:t,effect:{type:"preprocess",transform:e},typeName:wi.ZodEffects,...os(n)});class li extends cs{_parse(e){return this._getType(e)===Ma.undefined?Va(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}li.create=(e,t)=>new li({innerType:e,typeName:wi.ZodOptional,...os(t)});class ui extends cs{_parse(e){return this._getType(e)===Ma.null?Va(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ui.create=(e,t)=>new ui({innerType:e,typeName:wi.ZodNullable,...os(t)});class di extends cs{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===Ma.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}di.create=(e,t)=>new di({innerType:e,typeName:wi.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...os(t)});class hi extends cs{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Ya(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new Fa(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new Fa(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}hi.create=(e,t)=>new hi({innerType:e,typeName:wi.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...os(t)});class pi extends cs{_parse(e){if(this._getType(e)!==Ma.nan){const t=this._getOrReturnCtx(e);return Ha(t,{code:Da.invalid_type,expected:Ma.nan,received:t.parsedType}),Ga}return{status:"valid",value:e.data}}}pi.create=e=>new pi({typeName:wi.ZodNaN,...os(e)});const fi=Symbol("zod_brand");class mi extends cs{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class gi extends cs{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Ga:"dirty"===e.status?(t.dirty(),Ja(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Ga:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new gi({in:e,out:t,typeName:wi.ZodPipeline})}}class yi extends cs{_parse(e){const t=this._def.innerType._parse(e),n=e=>(Qa(e)&&(e.value=Object.freeze(e.value)),e);return Ya(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function bi(e,t){const n="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof n?{message:n}:n}function _i(e,t={},n){return e?Ds.create().superRefine(((r,a)=>{var s,i;const o=e(r);if(o instanceof Promise)return o.then((e=>{var s,i;if(!e){const e=bi(t,r),o=null===(i=null!==(s=e.fatal)&&void 0!==s?s:n)||void 0===i||i;a.addIssue({code:"custom",...e,fatal:o})}}));if(!o){const e=bi(t,r),o=null===(i=null!==(s=e.fatal)&&void 0!==s?s:n)||void 0===i||i;a.addIssue({code:"custom",...e,fatal:o})}})):Ds.create()}yi.create=(e,t)=>new yi({innerType:e,typeName:wi.ZodReadonly,...os(t)});const vi={object:Hs.lazycreate};var wi;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(wi||(wi={}));const ki=As.create,xi=Rs.create,Ei=pi.create,Oi=js.create,Si=Ns.create,$i=Cs.create,Ii=Ls.create,Pi=Ms.create,Ai=Us.create,Ti=Ds.create,Ri=Fs.create,ji=Bs.create,Ni=zs.create,Ci=Zs.create,Li=Hs.create,Mi=Hs.strictCreate,Ui=Ws.create,Di=Js.create,Fi=Ks.create,Bi=Xs.create,zi=Qs.create,Zi=Ys.create,qi=ei.create,Hi=ti.create,Wi=ni.create,Gi=ri.create,Ji=si.create,Vi=ii.create,Ki=oi.create,Xi=ci.create,Qi=li.create,Yi=ui.create,eo=ci.createWithPreprocess,to=gi.create,no={string:e=>As.create({...e,coerce:!0}),number:e=>Rs.create({...e,coerce:!0}),boolean:e=>Ns.create({...e,coerce:!0}),bigint:e=>js.create({...e,coerce:!0}),date:e=>Cs.create({...e,coerce:!0})},ro=Ga;var ao,so=Object.freeze({__proto__:null,defaultErrorMap:Ba,setErrorMap:function(e){za=e},getErrorMap:Za,makeIssue:qa,EMPTY_PATH:[],addIssueToContext:Ha,ParseStatus:Wa,INVALID:Ga,DIRTY:Ja,OK:Va,isAborted:Ka,isDirty:Xa,isValid:Qa,isAsync:Ya,get util(){return Jr},get objectUtil(){return Vr},ZodParsedType:Ma,getParsedType:Ua,ZodType:cs,datetimeRegex:$s,ZodString:As,ZodNumber:Rs,ZodBigInt:js,ZodBoolean:Ns,ZodDate:Cs,ZodSymbol:Ls,ZodUndefined:Ms,ZodNull:Us,ZodAny:Ds,ZodUnknown:Fs,ZodNever:Bs,ZodVoid:zs,ZodArray:Zs,ZodObject:Hs,ZodUnion:Ws,ZodDiscriminatedUnion:Js,ZodIntersection:Ks,ZodTuple:Xs,ZodRecord:Qs,ZodMap:Ys,ZodSet:ei,ZodFunction:ti,ZodLazy:ni,ZodLiteral:ri,ZodEnum:si,ZodNativeEnum:ii,ZodPromise:oi,ZodEffects:ci,ZodTransformer:ci,ZodOptional:li,ZodNullable:ui,ZodDefault:di,ZodCatch:hi,ZodNaN:pi,BRAND:fi,ZodBranded:mi,ZodPipeline:gi,ZodReadonly:yi,custom:_i,Schema:cs,ZodSchema:cs,late:vi,get ZodFirstPartyTypeKind(){return wi},coerce:no,any:Ti,array:Ci,bigint:Oi,boolean:Si,date:$i,discriminatedUnion:Di,effect:Xi,enum:Ji,function:Hi,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>_i((t=>t instanceof e),t),intersection:Fi,lazy:Wi,literal:Gi,map:Zi,nan:Ei,nativeEnum:Vi,never:ji,null:Ai,nullable:Yi,number:xi,object:Li,oboolean:()=>Si().optional(),onumber:()=>xi().optional(),optional:Qi,ostring:()=>ki().optional(),pipeline:to,preprocess:eo,promise:Ki,record:zi,set:qi,strictObject:Mi,string:ki,symbol:Ii,transformer:Xi,tuple:Bi,undefined:Pi,union:Ui,unknown:Ri,void:Ni,NEVER:ro,ZodIssueCode:Da,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:Fa}),io=n(88981),oo={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},co=new Uint8Array(16);function lo(){if(!ao&&!(ao="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ao(co)}for(var uo=[],ho=0;ho<256;++ho)uo.push((ho+256).toString(16).slice(1));var po=function(e,t,n){if(oo.randomUUID&&!t&&!e)return oo.randomUUID();var r=(e=e||{}).random||(e.rng||lo)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(var a=0;a<16;++a)t[n+a]=r[a];return t}return function(e,t=0){return(uo[e[t+0]]+uo[e[t+1]]+uo[e[t+2]]+uo[e[t+3]]+"-"+uo[e[t+4]]+uo[e[t+5]]+"-"+uo[e[t+6]]+uo[e[t+7]]+"-"+uo[e[t+8]]+uo[e[t+9]]+"-"+uo[e[t+10]]+uo[e[t+11]]+uo[e[t+12]]+uo[e[t+13]]+uo[e[t+14]]+uo[e[t+15]]).toLowerCase()}(r)},fo=n(73290);const mo=(...e)=>fetch(...e),go=Symbol.for("ls:fetch_implementation"),yo=e=>async(...t)=>{if(e||"true"===tc("DEBUG")){const[e,n]=t;console.log(`â†’ ${n?.method||"GET"} ${e}`)}const n=await(globalThis[go]??mo)(...t);return(e||"true"===tc("DEBUG"))&&console.log(`â† ${n.status} ${n.statusText} ${n.url}`),n},bo=[400,401,403,404,405,406,407,408],_o=[409];class vo{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.debug=e.debug,this.queue=new fo.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>io((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(bo.includes(+r))throw e;if(_o.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>yo(this.debug)(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function wo(e){return"function"==typeof e?._getType}function ko(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var xo=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,Eo=function(e){return"string"==typeof e&&xo.test(e)};function Oo(e,t){if(!Eo(e))throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);return e}const So={};function $o(e){So[e]||(console.warn(e),So[e]=!0)}function Io(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,n]=e.split(":"),r=n||"latest";if(t.includes("/")){const[n,a]=t.split("/",2);if(!n||!a)throw new Error(`Invalid identifier format: ${e}`);return[n,a,r]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}n(61134);class Po extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function Ao(e,t,n){let r;if(e.ok)return void(n&&(r=await e.text()));r=await e.text();const a=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${r}`;if(409===e.status)throw new Po(a);throw new Error(a)}var To="[...]",Ro={result:"[Circular]"},jo=[],No=[];const Co=new TextEncoder;function Lo(e){return Co.encode(e)}function Mo(e,t,n,r){try{return Lo(JSON.stringify(e,t,n))}catch(a){if(!a.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),Lo("[Unserializable]");let s;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),void 0===r&&(r={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),Do(e,"",0,[],void 0,0,r);try{s=0===No.length?JSON.stringify(e,t,n):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,n){if(No.length>0)for(var r=0;r<No.length;r++){var a=No[r];if(a[1]===t&&a[0]===n){n=a[2],No.splice(r,1);break}}return e.call(this,t,n)}}(t),n)}catch(e){return Lo("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==jo.length;){const e=jo.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return Lo(s)}}function Uo(e,t,n,r){var a=Object.getOwnPropertyDescriptor(r,n);void 0!==a.get?a.configurable?(Object.defineProperty(r,n,{value:e}),jo.push([r,n,t,a])):No.push([t,n,e]):(r[n]=e,jo.push([r,n,t]))}function Do(e,t,n,r,a,s,i){var o;if(s+=1,"object"==typeof e&&null!==e){for(o=0;o<r.length;o++)if(r[o]===e)return void Uo(Ro,e,t,a);if(void 0!==i.depthLimit&&s>i.depthLimit)return void Uo(To,e,t,a);if(void 0!==i.edgesLimit&&n+1>i.edgesLimit)return void Uo(To,e,t,a);if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Do(e[o],o,o,r,e,s,i);else{var c=Object.keys(e);for(o=0;o<c.length;o++){var l=c[o];Do(e[l],l,o,r,e,s,i)}}r.pop()}}function Fo(e){const t=Yo(),n=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,a]of Object.entries(e))!r.startsWith("LANGCHAIN_")&&!r.startsWith("LANGSMITH_")||"string"!=typeof a||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=a:t[r]=a);return t}(),r=e.extra??{},a=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...a}},e}function Bo(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const zo=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};function Zo(e){return"number"==typeof e?Number(e.toFixed(4)):e}class qo{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const n=new Promise((e=>{t=e})),r=Mo(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:n,size:r}),this.sizeBytes+=r,n}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),n+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),n+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}class Ho{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new qo}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===ec("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===ec("LANGSMITH_DEBUG")});const t=Ho.getDefaultClientConfig();if(this.tracingSampleRate=(e=>{const t=e?.toString()??tc("TRACING_SAMPLING_RATE");if(void 0===t)return;const n=parseFloat(t);if(n<0||n>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${n}`);return n})(e.tracingSamplingRate),this.apiUrl=Bo(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Bo(e.apiKey??t.apiKey),this.webUrl=Bo(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new vo({...e.callerOptions??{},debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.batchIngestCaller=new vo({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:zo,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=tc("API_KEY");return{apiUrl:tc("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===tc("HIDE_INPUTS"),hideOutputs:"true"===tc("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(()=>{const e=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===e||"127.0.0.1"===e||"::1"===e})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Go}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,a=await this.caller.call(yo(this.debug),r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(a,`Failed to fetch ${e}`),a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let r=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));const s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(yo(this.debug),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(i,`Failed to fetch ${e}`);const o=n?n(await i.json()):await i.json();if(0===o.length)break;if(yield o,o.length<a)break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const a=t?{...t}:{};for(;;){const t=await this.caller.call(yo(this.debug),`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)}),s=await t.json();if(!s)break;if(!s[r])break;yield s[r];const i=s.cursors;if(!i)break;if(!i.next)break;a.cursor=i.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.filteredPostUuids.has(n.id)?this.filteredPostUuids.delete(n.id):t.push(n);return t}{const t=[];for(const n of e){const e=n.trace_id??n.id;this.filteredPostUuids.has(e)||(n.id===e?this._shouldSample()?t.push(n):this.filteredPostUuids.add(e):t.push(n))}return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??20971520}async _getMultiPartSupport(){const e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[n,r]=this.autoBatchQueue.pop(e);if(!n.length){r();break}const a=this._processBatch(n,r).catch(console.error);t.push(a)}return Promise.all(t)}async _processBatch(e,t){if(e.length)try{const t={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},n=await this._ensureServerInfo();n?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}else t()}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=Fo(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const n=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>n&&this.drainAutoBatchQueue(n),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(n)}),this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await yo(this.debug)(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(2500),...this.fetchOptions});await Ao(e,"get server info");const t=await e.json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(t,null,2)+"\n"),t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=await this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const a=Fo(r),s=await this.caller.call(yo(this.debug),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:Mo(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(s,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=await Promise.all(e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[]),r=await Promise.all(t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[]);if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const a={post:n,patch:r};if(!a.post.length&&!a.patch.length)return;const s={post:[],patch:[]};for(const e of["post","patch"]){const t=e,n=a[t].reverse();let r=n.pop();for(;void 0!==r;)s[t].push(r),r=n.pop()}(s.post.length>0||s.patch.length>0)&&await this._postBatchIngestRuns(Mo(s))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(yo(this.debug),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(n,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const n={};let r=[];for(const t of e??[]){const e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(n[e.id]=e.attachments),delete e.attachments,r.push(e)}let a=[];for(const e of t??[])a.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==r.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==a.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(r.length>0&&a.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of a)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);r=Object.values(e),a=t}if(0===r.length&&0===a.length)return;const s=[],i=[];for(const[e,t]of[["post",r],["patch",a]])for(const r of t){const{inputs:t,outputs:a,events:o,attachments:c,...l}=r,u={inputs:t,outputs:a,events:o},d=Mo(l);i.push({name:`${e}.${l.id}`,payload:new Blob([d],{type:`application/json; length=${d.length}`})});for(const[t,n]of Object.entries(u)){if(void 0===n)continue;const r=Mo(n);i.push({name:`${e}.${l.id}.${t}`,payload:new Blob([r],{type:`application/json; length=${r.length}`})})}if(void 0!==l.id){const e=n[l.id];if(e){delete n[l.id];for(const[t,n]of Object.entries(e)){let e,r;Array.isArray(n)?[e,r]=n:(e=n.mimeType,r=n.data),t.includes(".")?console.warn(`Skipping attachment '${t}' for run ${l.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):i.push({name:`attachment.${l.id}.${t}`,payload:new Blob([r],{type:`${e}; length=${r.byteLength}`})})}}}s.push(`trace=${l.trace_id},id=${l.id}`)}await this._sendMultipartRequest(i,s.join("; "))}async _sendMultipartRequest(e,t){try{const t="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),n=[];for(const r of e)n.push(new Blob([`--${t}\r\n`])),n.push(new Blob([`Content-Disposition: form-data; name="${r.name}"\r\n`,`Content-Type: ${r.payload.type}\r\n\r\n`])),n.push(r.payload),n.push(new Blob(["\r\n"]));n.push(new Blob([`--${t}--\r\n`]));const r=new Blob(n),a=await r.arrayBuffer(),s=await this.batchIngestCaller.call(yo(this.debug),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${t}`},body:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(s,"ingest multipart runs",!0)}catch(e){console.warn(`${e.message.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){Oo(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:n}).catch(console.error):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(yo(this.debug),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:Mo(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(a,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Oo(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;e=t.session_id?t.session_id:n?.projectName?(await this.readProject({projectName:n?.projectName})).id:n?.projectId?n?.projectId:(await this.readProject({projectName:tc("PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:a,referenceExampleId:s,startTime:i,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));b.push(...t)}const _={session:b.length?b:null,run_type:l,reference_example:s,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:r,start_time:i?i.toISOString():null,error:u,id:d,limit:g,trace:a,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let v=0;for await(const e of this._getCursorPaginatedList("/runs/query",_))if(g){if(v>=g)break;if(e.length+v>g){const t=e.slice(0,g-v);yield*t;break}v+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:n,runType:r,projectNames:a,projectIds:s,referenceExampleIds:i,startTime:o,endTime:c,error:l,query:u,filter:d,traceFilter:h,treeFilter:p,isRoot:f,dataSourceType:m}){let g=s||[];a&&(g=[...s||[],...await Promise.all(a.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const y={id:e,trace:t,parent_run:n,run_type:r,session:g,reference_example:i,start_time:o,end_time:c,error:l,query:u,filter:d,trace_filter:h,tree_filter:p,is_root:f,data_source_type:m},b=Object.fromEntries(Object.entries(y).filter((([e,t])=>void 0!==t))),_=await this.caller.call(yo(this.debug),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _.json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||po()};Oo(e);const r=await this.caller.call(yo(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();if(null===a||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Oo(e);const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(t,"unshare run",!0)}async readRunSharedLink(e){Oo(e);const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);Oo(e);const r=await this.caller.call(yo(this.debug),`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Oo(e);const n=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};Oo(e);const r=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Oo(e);const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(t,"unshare dataset",!0)}async readSharedDataset(e){Oo(e);const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const r=new URLSearchParams;Object.entries(n).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>r.append(e,t))):r.append(e,t)}));const a=await this.caller.call(yo(this.debug),`${this.apiUrl}/public/${e}/examples?${r.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await a.json();if(!a.ok){if("detail"in s)throw new Error(`Failed to list shared examples.\nStatus: ${a.status}\nMessage: ${s.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`)}return s.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:a=null,referenceDatasetId:s=null}){const i=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${i}`,c=a||{};n&&(c.metadata=n);const l={name:e,extra:c,description:t};null!==s&&(l.reference_dataset_id=s);const u=await this.caller.call(yo(this.debug),o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(u,"create project"),await u.json()}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:a=null,endTime:s=null}){const i=`${this.apiUrl}/sessions/${e}`;let o=a;r&&(o={...o||{},metadata:r});const c={name:t,extra:o,description:n,end_time:s?new Date(s).toISOString():null},l=await this.caller.call(yo(this.debug),i,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Oo(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const a=await this.caller.call(yo(this.debug),`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await a.json();return!!a.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Oo(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}void 0!==n&&a.append("include_stats",n.toString());const s=await this._get(r,a);let i;if(Array.isArray(s)){if(0===s.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:a,referenceFree:s,metadata:i}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==n&&o.append("name_contains",n),void 0!==r)o.append("reference_dataset",r);else if(void 0!==a){const e=await this.readDataset({datasetName:a});o.append("reference_dataset",e.id)}void 0!==s&&o.append("reference_free",s.toString()),void 0!==i&&o.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,Oo(n);const r=await this.caller.call(yo(this.debug),`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(r,`delete session ${n} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:a,dataType:s,name:i}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach((e=>{c.append("input_keys",e)})),r.forEach((e=>{c.append("output_keys",e)})),a&&c.append("description",a),s&&c.append("data_type",s),i&&c.append("name",i);const l=await this.caller.call(yo(this.debug),o,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(l,"upload CSV"),await l.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:r,outputsSchema:a,metadata:s}={}){const i={name:e,description:t,extra:s?{metadata:s}:void 0};n&&(i.data_type=n),r&&(i.inputs_schema_definition=r),a&&(i.outputs_schema_definition=a);const o=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(o,"create dataset"),await o.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)Oo(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const a=await this._get(n,r);let s;if(Array.isArray(a)){if(0===a.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=a[0]}else s=a;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let a=e;if(void 0===a&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:t})).id);const s=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide either datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:a,metadata:s}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==a&&i.append("name_contains",a),void 0!==s&&i.append("metadata",JSON.stringify(s));for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:n,...r}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:n})).id;Oo(a);const s=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(s,"update dataset"),await s.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:n,asOf:r,tag:a}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:n})).id;Oo(s);const i=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:"string"==typeof r?r:r.toISOString(),tag:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(i,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");Oo(r),n+=`/${r}`;const a=await this.caller.call(yo(this.debug),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(a,`delete ${n}`),await a.json()}async indexDataset({datasetId:e,datasetName:t,tag:n}){let r=e;if(!r&&!t)throw new Error("Must provide either datasetName or datasetId");if(r&&t)throw new Error("Must provide either datasetName or datasetId, not both");r||(r=(await this.readDataset({datasetName:t})).id),Oo(r);const a={tag:n},s=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${r}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(s,"index dataset"),await s.json()}async similarExamples(e,t,n,{filter:r}={}){const a={limit:n,inputs:e};void 0!==r&&(a.filter=r),Oo(t);const s=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(s,"fetch similar examples"),(await s.json()).examples}async createExample(e,t,n){if(Wo(e)&&(void 0!==t||void 0!==n))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let r=t?n?.datasetId:e.dataset_id;const a=t?n?.datasetName:e.dataset_name;if(void 0===r&&void 0===a)throw new Error("Must provide either datasetName or datasetId");if(void 0!==r&&void 0!==a)throw new Error("Must provide either datasetName or datasetId, not both");void 0===r&&(r=(await this.readDataset({datasetName:a})).id);const s=(t?n?.createdAt:e.created_at)||new Date;let i;i=Wo(e)?e:{inputs:e,outputs:t,created_at:s?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const o=await this._uploadExamplesMultipart(r,[i]);return await this.readExample(o.example_ids?.[0]??po())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];const t=e;let n=t[0].dataset_id;const r=t[0].dataset_name;if(void 0===n&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===n&&(n=(await this.readDataset({datasetName:r})).id);const a=await this._uploadExamplesMultipart(n,t);return await Promise.all(a.example_ids.map((e=>this.readExample(e))))}const{inputs:t,outputs:n,metadata:r,splits:a,sourceRunIds:s,useSourceRunIOs:i,useSourceRunAttachments:o,attachments:c,exampleIds:l,datasetId:u,datasetName:d}=e;if(void 0===t)throw new Error("Must provide inputs when using legacy parameters");let h=u;const p=d;if(void 0===h&&void 0===p)throw new Error("Must provide either datasetName or datasetId");if(void 0!==h&&void 0!==p)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===h){const e=await this.readDataset({datasetName:p});h=e.id}const f=t.map(((e,t)=>({dataset_id:h,inputs:e,outputs:n?.[t],metadata:r?.[t],split:a?.[t],id:l?.[t],attachments:c?.[t],source_run_id:s?.[t],use_source_run_io:i?.[t],use_source_run_attachments:o?.[t]}))),m=await this._uploadExamplesMultipart(h,f);return await Promise.all(m.example_ids.map((e=>this.readExample(e))))}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>wo(e)?ko(e):e)),a=wo(t)?ko(t):t;return this.createExample({input:r},{output:a},n)}async readExample(e){Oo(e);const t=`/examples/${e}`,n=await this._get(t),{attachment_urls:r,...a}=n,s=a;return r&&(s.attachments=Object.entries(r).reduce(((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url,mime_type:n.mime_type},e)),{})),s}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:a,inlineS3Urls:s,metadata:i,limit:o,offset:c,filter:l,includeAttachments:u}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const h=new URLSearchParams({dataset:d}),p=r?"string"==typeof r?r:r?.toISOString():void 0;p&&h.append("as_of",p);const f=s??!0;if(h.append("inline_s3_urls",f.toString()),void 0!==n)for(const e of n)h.append("id",e);if(void 0!==a)for(const e of a)h.append("splits",e);if(void 0!==i){const e=JSON.stringify(i);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==c&&h.append("offset",c.toString()),void 0!==l&&h.append("filter",l),!0===u&&["attachment_urls","outputs","metadata"].forEach((e=>h.append("select",e)));let m=0;for await(const e of this._getPaginated("/examples",h)){for(const t of e){const{attachment_urls:e,...n}=t,r=n;e&&(r.attachments=Object.entries(e).reduce(((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url,mime_type:n.mime_type||void 0},e)),{})),yield r,m++}if(void 0!==o&&m>=o)break}}async deleteExample(e){Oo(e);const t=`/examples/${e}`,n=await this.caller.call(yo(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(n,`delete ${t}`),await n.json()}async updateExample(e,t){let n,r,a;return n=t?e:e.id,Oo(n),r=t?{id:n,...t}:e,a=void 0!==r.dataset_id?r.dataset_id:(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(a,[r])}async updateExamples(e){let t;return t=void 0===e[0].dataset_id?(await this.readExample(e[0].id)).dataset_id:e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:n,tag:r}){let a;if(a=e||(await this.readDataset({datasetName:t})).id,Oo(a),n&&r||!n&&!r)throw new Error("Exactly one of asOf and tag must be specified.");const s=new URLSearchParams;void 0!==n&&s.append("as_of","string"==typeof n?n:n.toISOString()),void 0!==r&&s.append("tag",r);const i=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${a}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(i,"read dataset version"),await i.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");r=void 0===e?(await this.readDataset({datasetName:t})).id:e,Oo(r);const a=new URLSearchParams,s=n?"string"==typeof n?n:n?.toISOString():void 0;return s&&a.append("as_of",s),await this._get(`/datasets/${r}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:r,remove:a=!1}){let s;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");s=void 0===e?(await this.readDataset({datasetName:t})).id:e,Oo(s);const i={split_name:n,examples:r.map((e=>(Oo(e),e))),remove:a},o=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(o,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:a}={loadChildRuns:!1}){let s;if($o("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)s=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(a=await this.readExample(s.reference_example_id));const i=await t.evaluateRun(s,a),[o,c]=await this._logEvaluationFeedback(i,s,n);return c[0]}async createFeedback(e,t,{score:n,value:r,correction:a,comment:s,sourceInfo:i,feedbackSourceType:o="api",sourceRunId:c,feedbackId:l,feedbackConfig:u,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const p={type:o??"api",metadata:i??{}};void 0===c||void 0===p?.metadata||p.metadata.__run||(p.metadata.__run={run_id:c}),void 0!==p?.metadata&&void 0!==p.metadata.__run?.run_id&&Oo(p.metadata.__run.run_id);const f={id:l??po(),run_id:e,key:t,score:Zo(n),value:r,correction:a,comment:s,feedback_source:p,comparative_experiment_id:h,feedbackConfig:u,session_id:d},m=`${this.apiUrl}/feedback`,g=await this.caller.call(yo(this.debug),m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(g,"create feedback",!0),f}async updateFeedback(e,{score:t,value:n,correction:r,comment:a}){const s={};null!=t&&(s.score=Zo(t)),null!=n&&(s.value=n),null!=r&&(s.correction=r),null!=a&&(s.comment=a),Oo(e);const i=await this.caller.call(yo(this.debug),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(i,"update feedback",!0)}async readFeedback(e){Oo(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Oo(e);const t=`/feedback/${e}`,n=await this.caller.call(yo(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(n,`delete ${t}`),await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const a={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3};const s=await this.caller.call(yo(this.debug),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await s.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:a,metadata:s,id:i}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:i,name:e,experiment_ids:t,reference_dataset_id:n,description:a,created_at:(r??new Date)?.toISOString(),extra:{}};s&&(o.extra.metadata=s);const c=await this.caller.call(yo(this.debug),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){Oo(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:Array.isArray(e)?e:[e],t}async _logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e),a=[];for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let s=null;e.targetRunId?s=e.targetRunId:t&&(s=t.id),a.push(await this.createFeedback(s,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,a]}async logEvaluationFeedback(e,t,n){const[r]=await this._logEvaluationFeedback(e,t,n);return r}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:r,limit:a}=e,s=new URLSearchParams;t&&t.forEach(((e,t)=>{Oo(e,`queueIds[${t}]`),s.append("ids",e)})),n&&s.append("name",n),r&&s.append("name_contains",r),s.append("limit",(void 0!==a?Math.min(a,100):100).toString());let i=0;for await(const e of this._getPaginated("/annotation-queues",s))if(yield*e,i++,void 0!==a&&i>=a)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:r}=e,a={name:t,description:n,id:r||po()},s=await this.caller.call(yo(this.debug),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(s,"create annotation queue"),await s.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:n,description:r}=t,a=await this.caller.call(yo(this.debug),`${this.apiUrl}/annotation-queues/${Oo(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:n,description:r}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(a,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/annotation-queues/${Oo(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const n=await this.caller.call(yo(this.debug),`${this.apiUrl}/annotation-queues/${Oo(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>Oo(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(n,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${Oo(e,"queueId")}/run`,r=await this.caller.call(yo(this.debug),`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(r,"get run from annotation queue"),await r.json()}async deleteRunFromAnnotationQueue(e,t){const n=await this.caller.call(yo(this.debug),`${this.apiUrl}/annotation-queues/${Oo(e,"queueId")}/runs/${Oo(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(n,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/annotation-queues/${Oo(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${n.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(yo(this.debug),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(!t.ok){const e="string"==typeof n.detail?n.detail:JSON.stringify(n.detail),r=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw r.statusCode=t.status,r}if(0!==n.commits.length)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,r,a]=Io(e),s=await this.caller.call(yo(this.debug),`${this.apiUrl}/likes/${n}/${r}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(s,(t?"like":"unlike")+" prompt"),await s.json()}async _getPromptUrl(e){const[t,n,r]=Io(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==r?`${this.getHostUrl()}/prompts/${n}/${r.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${e.id}`}return"latest"!==r?`${this.getHostUrl()}/hub/${t}/${n}/${r.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,n,r]=Io(e),a=await this.caller.call(yo(this.debug),`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===a.status)return null;await Ao(a,"get prompt");const s=await a.json();return s.repo?s.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[r,a,s]=Io(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("create a prompt",r);const i={repo_handle:a,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=await this.caller.call(yo(this.debug),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(o,"create prompt");const{repo:c}=await o.json();return c}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a,s]=Io(e),i="latest"!==n?.parentCommitHash&&n?.parentCommitHash?n?.parentCommitHash:await this._getLatestCommitHash(`${r}/${a}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:i},c=await this.caller.call(yo(this.debug),`${this.apiUrl}/commits/${r}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(c,"create commit");const l=await c.json();return this._getPromptUrl(`${r}/${a}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const e of t){const t=e.id,r=Mo({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}}),a=new Blob([r],{type:"application/json"});if(n.append(t,a),e.inputs){const r=Mo(e.inputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,a)}if(e.outputs){const r=Mo(e.outputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,a)}if(e.attachments)for(const[r,a]of Object.entries(e.attachments)){let e,s;Array.isArray(a)?[e,s]=a:(e=a.mimeType,s=a.data);const i=new Blob([s],{type:`${e}; length=${s.byteLength}`});n.append(`${t}.attachment.${r}`,i)}if(e.attachments_operations){const r=Mo(e.attachments_operations),a=new Blob([r],{type:"application/json"});n.append(`${t}.attachments_operations`,a)}}const r=e??t[0]?.dataset_id,a=await this.caller.call(yo(this.debug),`${this.apiUrl}/v1/platform/datasets/${r}/examples`,{method:"PATCH",headers:this.headers,body:n});return await a.json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const e of t){const t=(e.id??po()).toString(),r=Mo({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}}),a=new Blob([r],{type:"application/json"});if(n.append(t,a),e.inputs){const r=Mo(e.inputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,a)}if(e.outputs){const r=Mo(e.outputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,a)}if(e.attachments)for(const[r,a]of Object.entries(e.attachments)){let e,s;Array.isArray(a)?[e,s]=a:(e=a.mimeType,s=a.data);const i=new Blob([s],{type:`${e}; length=${s.byteLength}`});n.append(`${t}.attachment.${r}`,i)}}const r=await this.caller.call(yo(this.debug),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:n});return await Ao(r,"upload examples"),await r.json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r]=Io(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const a={};if(void 0!==t?.description&&(a.description=t.description),void 0!==t?.readme&&(a.readme=t.readme),void 0!==t?.tags&&(a.tags=t.tags),void 0!==t?.isPublic&&(a.is_public=t.isPublic),void 0!==t?.isArchived&&(a.is_archived=t.isArchived),0===Object.keys(a).length)throw new Error("No valid update options provided");const s=await this.caller.call(yo(this.debug),`${this.apiUrl}/repos/${n}/${r}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Ao(s,"update prompt"),s.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,r]=Io(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const a=await this.caller.call(yo(this.debug),`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async pullPromptCommit(e,t){const[n,r,a]=Io(e),s=await this.caller.call(yo(this.debug),`${this.apiUrl}/commits/${n}/${r}/${a}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Ao(s,"pull prompt commit");const i=await s.json();return{owner:n,repo:r,commit_hash:i.commit_hash,manifest:i.manifest,examples:i.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:r}=t,[a,s]=this.parseTokenOrUrl(e,n),i=new Ho({apiUrl:a,apiKey:"placeholder"}),o=await i.readSharedDataset(s),c=r||o.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch(e){}const l=await i.listSharedExamples(s),u=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map((e=>e.inputs)),outputs:l.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,n=2,r="dataset"){try{return Oo(e),[t,e]}catch(e){}try{const a=new URL(e).pathname.split("/").filter((e=>""!==e));if(a.length>=n)return[t,a[a.length-n]];throw new Error(`Invalid public ${r} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${r} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map((({itemPromise:e})=>e)),this.batchIngestCaller.queue.onIdle()])}}function Wo(e){return"dataset_id"in e||"dataset_name"in e}const Go="0.3.21";let Jo;const Vo=()=>"undefined"!=typeof Deno,Ko=()=>Jo||(Jo="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Vo()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Vo()?"deno":"other":"node",Jo);let Xo,Qo;function Yo(){if(void 0===Xo){const e=Ko(),t=function(){if(void 0!==Qo)return Qo;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=ec(n);void 0!==e&&(t[n]=e)}return Qo=t,t}();Xo={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:Go,...t}}return Xo}function ec(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function tc(e){return ec(`LANGSMITH_${e}`)||ec(`LANGCHAIN_${e}`)}const nc=Symbol.for("lc:context_variables");class rc{constructor(e,t,n){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=n}static fromHeader(e){const t=e.split(",");let n,r={},a=[];for(const e of t){const[t,s]=e.split("="),i=decodeURIComponent(s);"langsmith-metadata"===t?r=JSON.parse(i):"langsmith-tags"===t?a=i.split(","):"langsmith-project"===t&&(n=i)}return new rc(r,a,n)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class ac{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),sc(e))return void Object.assign(this,{...e});const t=ac.getDefaultConfig(),{metadata:n,...r}=e,a=r.client??ac.getSharedClient(),s={...n,...r?.extra?.metadata};if(r.extra={...r.extra,metadata:s},Object.assign(this,{...t,...r,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const e=function(e,t,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}}static getDefaultConfig(){return{id:po(),run_type:"chain",project_name:tc("PROJECT")??ec("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:ec("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:ec("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return ac.sharedClient||(ac.sharedClient=new Ho),ac.sharedClient}createChild(e){const t=this.child_execution_order+1,n=new ac({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});nc in this&&(n[nc]=this[nc]);const r=Symbol.for("lc:child_config"),a=e.extra?.[r]??this.extra[r];if(void 0!==(s=a)&&"object"==typeof s.callbacks&&(oc(s.callbacks?.handlers)||oc(s.callbacks))){const e={...a},t=function(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:n.id}),t.handlers?.find(ic)?.updateFromRunTree?.(n),e.callbacks=t),n.extra[r]=e}var s;const i=new Set;let o=this;for(;null!=o&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(n),n}async end(e,t,n=Date.now(),r){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,r&&Object.keys(r).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...r}}:{metadata:r})}_convertToCreate(e,t,n=!0){const r=e.extra??{};if(r.runtime||(r.runtime={}),t)for(const[e,n]of Object.entries(t))r.runtime[e]||(r.runtime[e]=n);let a,s;return n?(s=e.parent_run?.id,a=[]):(a=e.child_runs.map((e=>this._convertToCreate(e,t,n))),s=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:r,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:s,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=Yo(),n=await this._convertToCreate(this,t,!0);if(await this.client.createRun(n),!e){$o("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(){try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:(new Date).toISOString(),message:e}):this.events.push({...e,time:e.time??(new Date).toISOString()})}static fromRunnableConfig(e,t){const n=e?.callbacks;let r,a,s,i=!!["TRACING_V2","TRACING"].find((e=>"true"===tc(e)));if(n){const e=n?.getParentRunId?.()??"",t=n?.handlers?.find((e=>"langchain_tracer"==e?.name));r=t?.getRun?.(e),a=t?.projectName,s=t?.client,i=i||!!t}return r?new ac({name:r.name,id:r.id,trace_id:r.trace_id,dotted_order:r.dotted_order,client:s,tracingEnabled:i,project_name:a,tags:[...new Set((r?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...r?.extra?.metadata,...e?.metadata}}}).createChild(t):new ac({...t,client:s,tracingEnabled:i,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const n="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,r=n["langsmith-trace"];if(!r||"string"!=typeof r)return;const a=r.trim(),s=a.split(".").map((e=>{const[t,n]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:n}})),i=s[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:i,dotted_order:a};if(n.baggage&&"string"==typeof n.baggage){const e=rc.fromHeader(n.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name}return new ac(o)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new rc(this.extra?.metadata,this.tags,this.project_name).toHeader()};if(e)for(const[n,r]of Object.entries(t))e.set(n,r);return t}}function sc(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function ic(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function oc(e){return Array.isArray(e)&&e.some((e=>ic(e)))}Object.defineProperty(ac,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});const cc=Symbol.for("ls:tracing_async_local_storage"),lc=new class{getStore(){}run(e,t){return t()}},uc=new class{getInstance(){return globalThis[cc]??lc}initializeGlobalInstance(e){void 0===globalThis[cc]&&(globalThis[cc]=e)}};function dc(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root");const hc=Object.prototype.hasOwnProperty;function pc(e,t){return hc.call(e,t)}function fc(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)pc(e,n)&&t.push(n);return t}function mc(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function gc(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function yc(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function bc(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(bc(e[t]))return!0}else if("object"==typeof e){const n=fc(e),r=n.length;for(var t=0;t<r;t++)if(bc(e[n[t]]))return!0}return!1}function _c(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class vc extends Error{constructor(e,t,n,r,a){super(_c(e,{name:t,index:n,operation:r,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=_c(e,{name:t,index:n,operation:r,tree:a})}}const wc=vc,kc=mc,xc={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=Oc(n,this.path);r&&(r=mc(r));const a=Sc(n,{op:"remove",path:this.from}).removed;return Sc(n,{op:"add",path:this.path,value:a}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=Oc(n,this.from);return Sc(n,{op:"add",path:this.path,value:mc(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Tc(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var Ec={add:function(e,t,n){return gc(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:xc.move,copy:xc.copy,test:xc.test,_get:xc._get};function Oc(e,t){if(""==t)return e;var n={op:"_get",path:t};return Sc(e,n),n.value}function Sc(e,t,n=!1,r=!0,a=!0,s=0){if(n&&("function"==typeof n?n(t,0,e,t.path):Pc(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=Oc(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=Tc(e,t.value),!1===r.test)throw new wc("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new wc("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,t,e);return r}{r||(e=mc(e));const i=(t.path||"").split("/");let o,c,l,u=e,d=1,h=i.length;for(l="function"==typeof n?n:Pc;;){if(c=i[d],c&&-1!=c.indexOf("~")&&(c=c.replace(/~1/g,"/").replace(/~0/g,"~")),a&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==i[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===u[c]?o=i.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&l(t,0,e,o)),d++,Array.isArray(u)){if("-"===c)c=u.length;else{if(n&&!gc(c))throw new wc("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,t,e);gc(c)&&(c=~~c)}if(d>=h){if(n&&"add"===t.op&&c>u.length)throw new wc("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,t,e);const r=Ec[t.op].call(t,u,c,e);if(!1===r.test)throw new wc("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r}}else if(d>=h){const n=xc[t.op].call(t,u,c,e);if(!1===n.test)throw new wc("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return n}if(u=u[c],n&&d<h&&(!u||"object"!=typeof u))throw new wc("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,t,e)}}}function $c(e,t,n,r=!0,a=!0){if(n&&!Array.isArray(t))throw new wc("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=mc(e));const s=new Array(t.length);for(let r=0,i=t.length;r<i;r++)s[r]=Sc(e,t[r],n,!0,a,r),e=s[r].newDocument;return s.newDocument=e,s}function Ic(e,t,n){const r=Sc(e,t);if(!1===r.test)throw new wc("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function Pc(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new wc("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!xc[e.op])throw new wc("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new wc("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new wc('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new wc("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new wc("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&bc(e.value))throw new wc("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var a=e.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new wc("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new wc("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var i=Ac([{op:"_get",path:e.from,value:void 0}],n);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new wc("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function Ac(e,t,n){try{if(!Array.isArray(e))throw new wc("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)$c(mc(t),mc(e),n||!0);else{n=n||Pc;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof wc)return e;throw e}}function Tc(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,a,s=Array.isArray(e),i=Array.isArray(t);if(s&&i){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!Tc(e[n],t[n]))return!1;return!0}if(s!=i)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!Tc(e[a=o[n]],t[a]))return!1;return!0}return e!=e&&t!=t}function Rc(e,t,n,r,a){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var s=fc(t),i=fc(e),o=!1,c=i.length-1;c>=0;c--){var l=e[d=i[c]];if(!pc(t,d)||void 0===t[d]&&void 0!==l&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(a&&n.push({op:"test",path:r+"/"+yc(d),value:mc(l)}),n.push({op:"remove",path:r+"/"+yc(d)}),o=!0):(a&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var u=t[d];"object"==typeof l&&null!=l&&"object"==typeof u&&null!=u&&Array.isArray(l)===Array.isArray(u)?Rc(l,u,n,r+"/"+yc(d),a):l!==u&&(a&&n.push({op:"test",path:r+"/"+yc(d),value:mc(l)}),n.push({op:"replace",path:r+"/"+yc(d),value:mc(u)}))}}if(o||s.length!=i.length)for(c=0;c<s.length;c++){var d;pc(e,d=s[c])||void 0===t[d]||n.push({op:"add",path:r+"/"+yc(d),value:mc(t[d])})}}}function jc(e,t,n=!1){var r=[];return Rc(e,t,r,"",n),r}new WeakMap;const Nc=()=>"undefined"!=typeof Deno;let Cc;async function Lc(){if(void 0===Cc){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Nc()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Nc()?"deno":"other":"node",e})();Cc={library:"langchain-js",runtime:e}}return Cc}function Mc(e){try{return"undefined"!=typeof process?process.env?.[e]:Nc()?Deno?.env.get(e):void 0}catch(e){return}}class Uc{}function Dc(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}class Fc extends Uc{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ta(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===Mc("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return na.prototype.toJSON.call(this)}toJSONNotImplemented(){return na.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Fc{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:po()}),Object.assign(this,e)}}}}const Bc=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers};function zc(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function Zc(e){return"function"==typeof e._addRunToRunMap}class qc extends Fc{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;return this.runMap.set(n.id,n),n}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,r,a,s,i,o){const c=this._getExecutionOrder(r),l=Date.now(),u=i?{...a,metadata:i}:a,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:s||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,n,r,a,s,i,o){const c=this.runMap.get(n)??this._createRunForLLMStart(e,t,n,r,a,s,i,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,n,r,a,s,i,o){const c=this._getExecutionOrder(r),l=Date.now(),u=i?{...a,metadata:i}:a,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:s||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,n,r,a,s,i,o){const c=this.runMap.get(n)??this._createRunForChatModelStart(e,t,n,r,a,s,i,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t,n,r,a){const s=this.runMap.get(t);if(!s||"llm"!==s?.run_type)throw new Error("No LLM run to end.");return s.end_time=Date.now(),s.outputs=e,s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),s.extra={...s.extra,...a},await(this.onLLMEnd?.(s)),await this._endTrace(s),s}async handleLLMError(e,t,n,r,a){const s=this.runMap.get(t);if(!s||"llm"!==s?.run_type)throw new Error("No LLM run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),s.extra={...s.extra,...a},await(this.onLLMError?.(s)),await this._endTrace(s),s}_createRunForChainStart(e,t,n,r,a,s,i,o){const c=this._getExecutionOrder(r),l=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:i??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleChainStart(e,t,n,r,a,s,i,o){const c=this.runMap.get(n)??this._createRunForChainStart(e,t,n,r,a,s,i,o);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,n,r,a){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=zc(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==a?.inputs&&(s.inputs=zc(a.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,n,r,a){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==a?.inputs&&(s.inputs=zc(a.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}_createRunForToolStart(e,t,n,r,a,s,i){const o=this._getExecutionOrder(r),c=Date.now(),l={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,n,r,a,s,i){const o=this.runMap.get(n)??this._createRunForToolStart(e,t,n,r,a,s,i);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}_createRunForRetrieverStart(e,t,n,r,a,s,i){const o=this._getExecutionOrder(r),c=Date.now(),l={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,n,r,a,s,i){const o=this.runMap.get(n)??this._createRunForRetrieverStart(e,t,n,r,a,s,i);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,a,s){const i=this.runMap.get(n);if(!i||"llm"!==i?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return i.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await(this.onLLMNewToken?.(i,e,{chunk:s?.chunk})),i}}var Hc=n(49418);function Wc(e,t){return`${e.open}${t}${e.close}`}function Gc(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function Jc(e){return"string"==typeof e?e.trim():null==e?e:Gc(e,e.toString())}function Vc(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:Kc}=Hc;class Xc extends qc{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?Wc(Hc.bold,r):r})).join(" > ");return Wc(Kc.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Gc(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.cyan,"[chain/end]")} [${t}] [${Vc(e)}] Exiting Chain run with output: ${Gc(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.red,"[chain/error]")} [${t}] [${Vc(e)}] Chain run errored with error: ${Gc(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${Wc(Kc.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Gc(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.cyan,"[llm/end]")} [${t}] [${Vc(e)}] Exiting LLM run with output: ${Gc(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.red,"[llm/error]")} [${t}] [${Vc(e)}] LLM run errored with error: ${Gc(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Jc(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.cyan,"[tool/end]")} [${t}] [${Vc(e)}] Exiting Tool run with output: "${Jc(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.red,"[tool/error]")} [${t}] [${Vc(e)}] Tool run errored with error: ${Gc(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Gc(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.cyan,"[retriever/end]")} [${t}] [${Vc(e)}] Exiting Retriever run with output: ${Gc(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Wc(Kc.red,"[retriever/error]")} [${t}] [${Vc(e)}] Retriever run errored with error: ${Gc(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${Wc(Kc.blue,"[agent/action]")} [${n}] Agent selected action: ${Gc(t.actions[t.actions.length-1],"[action]")}`)}}let Qc;const Yc=()=>{if(void 0===Qc){const e="false"===Mc("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};Qc=new Ho(e)}return Qc};class el extends qc{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??Mc("LANGCHAIN_PROJECT")??Mc("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??Yc();const a=el.getTraceableRunTree();a&&this.updateFromRunTree(a)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Lc()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra,session_name:this.projectName};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const n=new Set;for(;t.parent_run&&!n.has(t.id)&&(n.add(t.id),t.parent_run);)t=t.parent_run;n.clear();const r=[t];for(;r.length>0;){const e=r.shift();e&&!n.has(e.id)&&(n.add(e.id),this.runMap.set(e.id,e),e.child_runs&&r.push(...e.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},n=[];for(const[e,r]of this.runMap){const a=new ac({...r,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[e]=a,n.push([e,r.dotted_order])}n.sort(((e,t)=>e[1]&&t[1]?e[1].localeCompare(t[1]):0));for(const[e]of n){const n=this.runMap.get(e),r=t[e];if(n&&r&&n.parent_run_id){const e=t[n.parent_run_id];e&&(e.child_runs.push(r),r.parent_run=e)}}return t[e]}static getTraceableRunTree(){try{return(()=>{const e=uc.getInstance().getStore();if(!sc(e))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function and that tracing is enabled."].join("\n"));return e})()}catch{return}}}const tl=Symbol.for("ls:tracing_async_local_storage"),nl=Symbol.for("lc:context_variables"),rl=()=>globalThis[tl];let al;async function sl(e,t){if(!0===t){const t=rl();void 0!==t?await t.run(void 0,(async()=>e())):await e()}else void 0===al&&(al=new(0,fo.default)({autoStart:!0,concurrency:1})),al.add((async()=>{const t=rl();void 0!==t?await t.run(void 0,(async()=>e())):await e()}))}function il(e){const t=rl();if(void 0===t)return;const n=t.getStore();return n?.[nl]?.[e]}const ol=Symbol("lc:configure_hooks");class cl{setHandler(e){return this.setHandlers([e])}}class ll{constructor(e,t,n,r,a,s,i,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>sl((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleCustomEvent(e,t,n,r,a){await Promise.all(this.handlers.map((n=>sl((async()=>{try{await(n.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}}class ul extends ll{getChild(e){const t=new fl(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class dl extends ll{async handleLLMNewToken(e,t,n,r,a,s){await Promise.all(this.handlers.map((n=>sl((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}async handleLLMError(e,t,n,r,a){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e,t,n,r,a){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class hl extends ll{getChild(e){const t=new fl(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,a){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,a){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class pl extends ll{getChild(e){const t=new fl(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>sl((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class fl extends cl{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const s=0===r&&n?n:po();return await Promise.all(this.handlers.map((n=>{if(!n.ignoreLLM)return Zc(n)&&n._createRunForLLMStart(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o),sl((async()=>{try{await(n.handleLLMStart?.(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new dl(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,n=void 0,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const s=0===r&&n?n:po();return await Promise.all(this.handlers.map((n=>{if(!n.ignoreLLM)return Zc(n)&&n._createRunForChatModelStart(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o),sl((async()=>{try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o));else if(n.handleLLMStart){const r=Ca(t);await(n.handleLLMStart?.(e,[r],s,this._parentRunId,a,this.tags,this.metadata,o))}}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new dl(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,n=po(),r=void 0,a=void 0,s=void 0,i=void 0){return await Promise.all(this.handlers.map((a=>{if(!a.ignoreChain)return Zc(a)&&a._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,r,i),sl((async()=>{try{await(a.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,r,i))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)}))),new hl(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=po(),r=void 0,a=void 0,s=void 0,i=void 0){return await Promise.all(this.handlers.map((r=>{if(!r.ignoreAgent)return Zc(r)&&r._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,i),sl((async()=>{try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new pl(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=po(),r=void 0,a=void 0,s=void 0,i=void 0){return await Promise.all(this.handlers.map((r=>{if(!r.ignoreRetriever)return Zc(r)&&r._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,i),sl((async()=>{try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new ul(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,r,a){await Promise.all(this.handlers.map((r=>sl((async()=>{if(!r.ignoreCustomEvent)try{await(r.handleCustomEvent?.(e,t,n,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new fl(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){const t=new this;return t.addHandler(new class extends Fc{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:po()}),Object.assign(this,e)}}),t}static configure(e,t,n,r,a,s,i){return this._configureSync(e,t,n,r,a,s,i)}static _configureSync(e,t,n,r,a,s,i){let o;(e||t)&&(Array.isArray(e)||!e?(o=new fl,o.setHandlers(e?.map(ml)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(ml):t?.handlers,!1));const c="true"===Mc("LANGCHAIN_VERBOSE")||i?.verbose,l=el.getTraceableRunTree()?.tracingEnabled||!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===Mc(e))),u=l||(Mc("LANGCHAIN_TRACING")??!1);if(c||u){if(o||(o=new fl),c&&!o.handlers.some((e=>e.name===Xc.prototype.name))){const e=new Xc;o.addHandler(e,!0)}if(u&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&l){const e=new el;o.addHandler(e,!0),o._parentRunId=el.getTraceableRunTree()?.id??o._parentRunId}}for(const{contextVar:e,inheritable:t=!0,handlerClass:n,envVar:r}of il(ol)||[]){const a=r&&"true"===Mc(r)&&n;let s;const i=void 0!==e?il(e):void 0;i&&Bc(i)?s=i:a&&(s=new n({})),void 0!==s&&(o||(o=new fl),o.handlers.some((e=>e.name===s.name))||o.addHandler(s,t))}return(n||r)&&o&&(o.addTags(n??[]),o.addTags(r??[],!1)),(a||s)&&o&&(o.addMetadata(a??{}),o.addMetadata(s??{},!1)),o}}function ml(e){return"name"in e?e:Fc.fromMethods(e)}const gl=new class{getStore(){}run(e,t){return t()}enterWith(e){}},yl=Symbol.for("lc:child_config"),bl=new class{getInstance(){return rl()??gl}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[yl]}runWithConfig(e,t,n){const r=fl._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),a=this.getInstance(),s=a.getStore(),i=r?.getParentRunId(),o=r?.handlers?.find((e=>"langchain_tracer"===e?.name));let c;return o&&i?c=o.convertToRunTree(i):n||(c=new ac({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[yl]:e}),void 0!==s&&void 0!==s[nl]&&(void 0===c&&(c={}),c[nl]=s[nl]),a.run(c,t)}initializeGlobalInstance(e){void 0===rl()&&(e=>{globalThis[tl]=e})(e)}};async function _l(e){return fl._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function vl(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=n.timeout:void 0!==n.timeout&&(t.timeout=Math.min(t.timeout,n.timeout));else if("signal"===e)void 0===t.signal?t.signal=n.signal:void 0!==n.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,n.signal]):t.signal=n.signal);else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(ml(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(ml(t),!0);t.callbacks=n}else t.callbacks=new fl(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}const wl=new Set(["string","number","boolean"]);function kl(e){const t=bl.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:r,...a}=t;n=Object.entries(a).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)}if(e&&(n=Object.entries(e).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)),n?.configurable)for(const e of Object.keys(n.configurable))wl.has(typeof n.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=n.configurable[e]);if(void 0!==n.timeout){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(n.timeout);void 0!==n.signal?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,e])):n.signal=e,delete n.timeout}return n}function xl(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:a,configurable:s,runId:i}={}){const o=kl(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==a&&(o.runName=a),void 0!==s&&(o.configurable={...o.configurable,...s}),void 0!==i&&delete o.runId,o}function El(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function Ol(e,t){if(void 0===t)return e;let n;return Promise.race([e.catch((e=>{if(!t?.aborted)throw e})),new Promise(((e,r)=>{n=()=>{r(new Error("Aborted"))},t.addEventListener("abort",n),t.aborted&&r(new Error("Aborted"))}))]).finally((()=>t.removeEventListener("abort",n)))}class Sl extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new Sl({start(e){return function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}()},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Sl({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function $l(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function Il(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=Il(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class Pl{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise(((t,n)=>{bl.runWithConfig(El(e.config),(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then((e=>t(void 0)),n)}),!0)}))}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?bl.runWithConfig(El(this.config),this.signal?async()=>Ol(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}class Al{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=$c({},t);return new Tl({ops:t,state:n[n.length-1].newDocument})}}class Tl extends Al{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=$c(this.state,e.ops);return new Tl({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=$c({},e.ops);return new Tl({ops:e.ops,state:t[t.length-1].newDocument})}}const Rl=e=>"log_stream_tracer"===e.name;async function jl(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function Nl(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class Cl extends qc{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Sl.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new Al({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new Al({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await jl(e,this._schemaFormat)),await this.writer.write(new Al({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await jl(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Nl(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new Al({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new Al({ops:[{op:"replace",path:"/final_output",value:await Nl(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let a;var s;void 0!==e.inputs.messages?(s=n?.chunk,a=void 0!==s&&void 0!==s.message?n?.chunk:new wa({id:`run-${e.id}`,content:t})):a=t;const i=new Al({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:a}]});await this.writer.write(i)}}const Ll="__run";class Ml{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Ml({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Ul extends Ml{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Ul({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Dl({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const Fl=e=>"event_stream_tracer"===e.name;class Bl extends qc{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Sl.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield n.value);function a(e,t){return"llm"===e&&"string"==typeof t?new Ml({text:t}):t}let s=this.tappedPromises.get(e);if(void 0===s){let i;s=new Promise((e=>{i=e})),this.tappedPromises.set(e,s);try{const s={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...s,data:{chunk:a(r.runType,n.value)}},r),yield n.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...s,data:{chunk:a(r.runType,e)}},r),yield e}finally{i()}}else{yield n.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);void 0!==n?n.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=Dl(e),n=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,r);const a=`on_${n}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,n){const r=this.runInfoMap.get(e.id);let a,s;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===r.runType)s="on_chat_model_stream",a=void 0===n?.chunk?new wa({content:t,id:`run-${e.id}`}):n.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);s="on_llm_stream",a=void 0===n?.chunk?new Ml({text:t}):n.chunk}await this.send({event:s,data:{chunk:a},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let n;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let a;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==a)break;a=e[0]?.message}n="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);a={generations:r?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end"}await this.sendEndEvent({event:n,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Dl(e),n=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let a={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(a={},r.inputs={}):void 0!==e.inputs.input?(a.input=e.inputs.input,r.inputs=e.inputs.input):(a.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${n}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(a.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:n,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Dl(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Dl(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const r=this.runInfoMap.get(n);if(void 0===r)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}const zl=[400,401,402,403,404,405,406,407,409],Zl=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&zl.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class ql{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Zl;const t=fo.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>io((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}class Hl extends qc{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function Wl(e){return!!e&&e.lc_runnable}class Gl{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}const Jl=Symbol("Let zodToJsonSchema decide on which parser to use"),Vl={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function Kl(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function Xl(e,t,n,r,a){e[t]=n,Kl(e,t,r,a)}function Ql(e,t){return xu(e.type._def,t)}function Yl(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>Yl(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return eu(e,t)}}const eu=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":Xl(n,"minimum",r.value,r.message,t);break;case"max":Xl(n,"maximum",r.value,r.message,t)}return n};let tu;const nu=/^[cC][^\s-]{8,}$/,ru=/^[0-9a-z]+$/,au=/^[0-9A-HJKMNP-TV-Z]{26}$/,su=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,iu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ou=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,cu=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,lu=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,uu=/^[a-zA-Z0-9_-]{21}$/,du=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function hu(e,t){const n={type:"string"};if(e.checks)for(const r of e.checks)switch(r.kind){case"min":Xl(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":Xl(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":mu(n,"email",r.message,t);break;case"format:idn-email":mu(n,"idn-email",r.message,t);break;case"pattern:zod":gu(n,su,r.message,t)}break;case"url":mu(n,"uri",r.message,t);break;case"uuid":mu(n,"uuid",r.message,t);break;case"regex":gu(n,r.regex,r.message,t);break;case"cuid":gu(n,nu,r.message,t);break;case"cuid2":gu(n,ru,r.message,t);break;case"startsWith":gu(n,RegExp(`^${pu(r.value,t)}`),r.message,t);break;case"endsWith":gu(n,RegExp(`${pu(r.value,t)}$`),r.message,t);break;case"datetime":mu(n,"date-time",r.message,t);break;case"date":mu(n,"date",r.message,t);break;case"time":mu(n,"time",r.message,t);break;case"duration":mu(n,"duration",r.message,t);break;case"length":Xl(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),Xl(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":gu(n,RegExp(pu(r.value,t)),r.message,t);break;case"ip":"v6"!==r.version&&mu(n,"ipv4",r.message,t),"v4"!==r.version&&mu(n,"ipv6",r.message,t);break;case"base64url":gu(n,lu,r.message,t);break;case"jwt":gu(n,du,r.message,t);break;case"cidr":"v6"!==r.version&&gu(n,iu,r.message,t),"v4"!==r.version&&gu(n,ou,r.message,t);break;case"emoji":gu(n,(void 0===tu&&(tu=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),tu),r.message,t);break;case"ulid":gu(n,au,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":mu(n,"binary",r.message,t);break;case"contentEncoding:base64":Xl(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":gu(n,cu,r.message,t)}break;case"nanoid":gu(n,uu,r.message,t)}return n}function pu(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let n=0;n<e.length;n++)fu.has(e[n])||(t+="\\"),t+=e[n];return t}(e):e}const fu=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function mu(e,t,n,r){e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Xl(e,"format",t,n,r)}function gu(e,t,n,r){e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:yu(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Xl(e,"pattern",yu(t,r),n,r)}function yu(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const n=e.flags.includes("i"),r=e.flags.includes("m"),a=e.flags.includes("s"),s=n?e.source.toLowerCase():e.source;let i="",o=!1,c=!1,l=!1;for(let e=0;e<s.length;e++)if(o)i+=s[e],o=!1;else{if(n)if(c){if(s[e].match(/[a-z]/)){l?(i+=s[e],i+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(i+=s[e],l=!0):i+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){i+=`[${s[e]}${s[e].toUpperCase()}]`;continue}if(r){if("^"===s[e]){i+="(^|(?<=[\r\n]))";continue}if("$"===s[e]){i+="($|(?=[\r\n]))";continue}}a&&"."===s[e]?i+=c?`${s[e]}\r\n`:`[${s[e]}\r\n]`:(i+=s[e],"\\"===s[e]?o=!0:c&&"]"===s[e]?c=!1:c||"["!==s[e]||(c=!0))}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function bu(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===wi.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:xu(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:t.rejectedAdditionalProperties};const n={type:"object",additionalProperties:xu(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===wi.ZodString&&e.keyType._def.checks?.length){const{type:r,...a}=hu(e.keyType._def,t);return{...n,propertyNames:a}}if(e.keyType?._def.typeName===wi.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===wi.ZodBranded&&e.keyType._def.type._def.typeName===wi.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...a}=Ql(e.keyType._def,t);return{...n,propertyNames:a}}return n}const _u={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},vu=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>xu(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function wu(e){try{return e.isOptional()}catch{return!0}}const ku=(e,t,n)=>{switch(t){case wi.ZodString:return hu(e,n);case wi.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",Kl(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?Xl(n,"minimum",r.value,r.message,t):Xl(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Xl(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Xl(n,"maximum",r.value,r.message,t):Xl(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Xl(n,"maximum",r.value,r.message,t));break;case"multipleOf":Xl(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case wi.ZodObject:return function(e,t){const n="openAi"===t.target,r={type:"object",properties:{}},a=[],s=e.shape();for(const e in s){let i=s[e];if(void 0===i||void 0===i._def)continue;let o=wu(i);o&&n&&(i instanceof li&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const c=xu(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==c&&(r.properties[e]=c,o||a.push(e))}a.length&&(r.required=a);const i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return xu(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(r.additionalProperties=i),r}(e,n);case wi.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?Xl(n,"minimum",r.value,r.message,t):Xl(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Xl(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Xl(n,"maximum",r.value,r.message,t):Xl(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Xl(n,"maximum",r.value,r.message,t));break;case"multipleOf":Xl(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case wi.ZodBoolean:return{type:"boolean"};case wi.ZodDate:return Yl(e,n);case wi.ZodUndefined:return{not:{}};case wi.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case wi.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==wi.ZodAny&&(n.items=xu(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Xl(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Xl(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Xl(n,"minItems",e.exactLength.value,e.exactLength.message,t),Xl(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case wi.ZodUnion:case wi.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return vu(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in _u&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=_u[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return vu(e,t)}(e,n);case wi.ZodIntersection:return function(e,t){const n=[xu(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),xu(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),a.length?{allOf:a,...r}:void 0}(e,n);case wi.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>xu(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:xu(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>xu(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case wi.ZodRecord:return bu(e,n);case wi.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case wi.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case wi.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case wi.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:_u[e.innerType._def.typeName],nullable:!0}:{type:[_u[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=xu(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=xu(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case wi.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return xu(e.innerType._def,t);const n=xu(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case wi.ZodMap:return function(e,t){return"record"===t.mapStrategy?bu(e,t):{type:"array",maxItems:125,items:{type:"array",items:[xu(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},xu(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case wi.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:xu(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Xl(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Xl(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case wi.ZodLazy:return()=>e.getter()._def;case wi.ZodPromise:return function(e,t){return xu(e.type._def,t)}(e,n);case wi.ZodNaN:case wi.ZodNever:return{not:{}};case wi.ZodEffects:return function(e,t){return"input"===t.effectStrategy?xu(e.schema._def,t):{}}(e,n);case wi.ZodAny:case wi.ZodUnknown:return{};case wi.ZodDefault:return function(e,t){return{...xu(e.innerType._def,t),default:e.defaultValue()}}(e,n);case wi.ZodBranded:return Ql(e,n);case wi.ZodReadonly:case wi.ZodCatch:return((e,t)=>xu(e.innerType._def,t))(e,n);case wi.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return xu(e.in._def,t);if("output"===t.pipeStrategy)return xu(e.out._def,t);const n=xu(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,xu(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case wi.ZodFunction:case wi.ZodVoid:case wi.ZodSymbol:default:return}};function xu(e,t,n=!1){const r=t.seen.get(e);if(t.override){const a=t.override?.(e,t,r,n);if(a!==Jl)return a}if(r&&!n){const e=Eu(r,t);if(void 0!==e)return e}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const s=ku(e,e.typeName,t),i="function"==typeof s?xu(s(),t):s;if(i&&Su(e,t,i),t.postProcess){const n=t.postProcess(i,e,t);return a.jsonSchema=i,n}return a.jsonSchema=i,i}const Eu=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:Ou(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Ou=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Su=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),$u=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...Vl,name:e}:{...Vl,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,r])=>({...e,[t]:xu(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??{}})),{}):void 0,a="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,s=xu(e._def,void 0===a?n:{...n,currentPath:[...n.basePath,n.definitionPath,a]},!1)??{},i="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==i&&(s.title=i);const o=void 0===a?r?{...s,[n.definitionPath]:r}:s:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,a].join("/"),[n.definitionPath]:{...r,[a]:s}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==n.target&&"openAi"!==n.target||(o.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===n.target&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o};function Iu(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const Pu=["*","_","`"];function Au(e,t){if(void 0!==e&&!Eo(e))return e;if(!Wl(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}}function Tu(e){return Wl(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...$u(e.data.schema),title:e.data.name}}}class Ru{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,n)=>{e[t.id]=Eo(t.id)?n:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...Tu(t)}))),edges:this.edges.map((t=>{const n={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(n.data=t.data),void 0!==t.conditional&&(n.conditional=t.conditional),n}))}}addNode(e,t,n){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const r=t??po(),a={id:r,data:e,name:Au(t,e),metadata:n};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:n,conditional:r};return this.edges.push(a),a}firstNode(){return ju(this)}lastNode(){return Nu(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map((e=>e.id)).every(Eo)&&(n="");const r=e=>n?`${n}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[r(e)]={...t,id:r(e)}}));const a=e.edges.map((e=>({...e,source:r(e.source),target:r(e.target)})));this.edges=[...this.edges,...a];const s=e.firstNode(),i=e.lastNode();return[s?{id:r(s.id),data:s.data}:void 0,i?{id:r(i.id),data:i.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&ju(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&Nu(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map((e=>[e.id,e.name]))),t=new Map;Object.values(e).forEach((e=>{t.set(e,(t.get(e)||0)+1)}));const n=n=>{const r=e[n];return Eo(n)&&1===t.get(r)?r:n};return new Ru({nodes:Object.fromEntries(Object.entries(this.nodes).map((([e,t])=>[n(e),{...t,id:n(e)}]))),edges:this.edges.map((e=>({...e,source:n(e.source),target:n(e.target)})))})}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:r={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},s=this.reid(),i=s.firstNode(),o=s.lastNode();return function(e,t,n){const{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=n??{};let l=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(i){const t="default",n={[t]:"{0}({1})"};void 0!==r&&(n[r]="{0}([{1}]):::first"),void 0!==a&&(n[a]="{0}([{1}]):::last");for(const[r,a]of Object.entries(e)){const e=a.name.split(":").pop()??"";let s=Pu.some((t=>e.startsWith(t)&&e.endsWith(t)))?`<p>${e}</p>`:e;Object.keys(a.metadata??{}).length&&(s+=`<hr/><small><em>${Object.entries(a.metadata??{}).map((([e,t])=>`${e} = ${t}`)).join("\n")}</em></small>`);const i=(n[r]??n[t]).replace("{0}",Iu(r)).replace("{1}",s);l+=`\t${i}\n`}}const u={};for(const e of t){const t=e.source.split(":"),n=e.target.split(":"),r=t.filter(((e,t)=>e===n[t])).join(":");u[r]||(u[r]=[]),u[r].push(e)}const d=new Set;function h(e,t){const n=1===e.length&&e[0].source===e[0].target;if(t&&!n){const e=t.split(":").pop();if(d.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),l+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:n,data:r,conditional:a}=t;let s="";if(void 0!==r){let e=r;const t=e.split(" ");t.length>c&&(e=Array.from({length:Math.ceil(t.length/c)},((e,n)=>t.slice(n*c,(n+1)*c).join(" "))).join("&nbsp;<br>&nbsp;")),s=a?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else s=a?" -.-> ":" --\x3e ";l+=`\t${Iu(e)}${s}${Iu(n)};\n`}for(const e in u)e.startsWith(`${t}:`)&&e!==t&&h(u[e],e);t&&!n&&(l+="\tend\n")}h(u[""]??[],"");for(const e in u)e.includes(":")||""===e||h(u[e],e);return i&&(l+=function(e){let t="";for(const[n,r]of Object.entries(e))t+=`\tclassDef ${n} ${r};\n`;return t}(s??{})),l}(s.nodes,s.edges,{firstNode:i?.id,lastNode:o?.id,withStyles:t,curveStyle:n,nodeColors:r,wrapLabelNWords:a})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:n="white"}=t??{};const r=btoa(e);void 0!==n&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const a=`https://mermaid.ink/img/${r}?bgColor=${n}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join("\n"));return await s.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function ju(e,t=[]){const n=new Set(e.edges.filter((e=>!t.includes(e.source))).map((e=>e.target))),r=[];for(const a of Object.values(e.nodes))t.includes(a.id)||n.has(a.id)||r.push(a);return 1===r.length?r[0]:void 0}function Nu(e,t=[]){const n=new Set(e.edges.filter((e=>!t.includes(e.target))).map((e=>e.source))),r=[];for(const a of Object.values(e.nodes))t.includes(a.id)||n.has(a.id)||r.push(a);return 1===r.length?r[0]:void 0}function Cu(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function Lu(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*Mu(e,t){for(;;){const{value:n,done:r}=bl.runWithConfig(El(e),t.next.bind(t),!0);if(r)break;yield n}}async function*Uu(e,t){const n=t[Symbol.asyncIterator]();for(;;){const{value:r,done:a}=await bl.runWithConfig(El(e),n.next.bind(t),!0);if(a)break;yield r}}function Du(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class Fu extends na{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Bu({bound:this,kwargs:e,config:{}})}map(){return new zu({bound:this})}withRetry(e){return new Zu({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Bu({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Ju({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(kl);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>kl(0===r?e:n)))}return Array.from({length:t},(()=>kl(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),a=r[0]?.maxConcurrency??n?.maxConcurrency,s=new ql({maxConcurrency:a,onFailedAttempt:e=>{throw e}}),i=e.map(((e,t)=>s.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=kl(t),r=new Pl({generator:this._streamIterator(e,n),config:n});return await r.setup,Sl.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=kl(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){const r=kl(n),a=await _l(r),s=await(a?.handleChainStart(this.toJSON(),Du(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let i;delete r.runId;try{const a=e.call(this,t,r,s);i=await Ol(a,n?.signal)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(Du(i,"output"))),i}async _batchWithConfig(e,t,n,r){const a=this._getOptionsList(n??{},t.length),s=await Promise.all(a.map(_l)),i=await Promise.all(s.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),Du(t[n],"input"),a[n].runId,a[n].runType,void 0,void 0,a[n].runName??this.getName()));return delete a[n].runId,r})));let o;try{const n=e.call(this,t,a,i,r);o=await Ol(n,a?.[0]?.signal)}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(Du(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,a,s=!0,i=!0;const o=kl(n),c=await _l(o);let l;try{const u=await async function(e,t,n,r,...a){const s=new Pl({generator:t,startSetup:n,signal:r}),i=await s.setup;return{output:e(s,i,...a),setup:i}}(t.bind(this),async function*(){for await(const t of e){if(s)if(void 0===r)r=t;else try{r=Il(r,t)}catch{r=void 0,s=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),n?.signal,o);delete o.runId,l=u.setup;const d=l?.handlers.find(Fl);let h=u.output;void 0!==d&&void 0!==l&&(h=d.tapOutputIterable(l.runId,h));const p=l?.handlers.find(Rl);void 0!==p&&void 0!==l&&(h=p.tapOutputIterable(l.runId,h));for await(const e of h)if(yield e,i)if(void 0===a)a=e;else try{a=Il(a,e)}catch{a=void 0,i=!1}}catch(e){throw await(l?.handleChainError(e,void 0,void 0,void 0,{inputs:Du(r,"input")})),e}await(l?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Du(r,"input")}))}getGraph(e){const t=new Ru,n=t.addNode({name:`${this.getName()}Input`,schema:so.any()}),r=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:so.any()});return t.addEdge(n,r),t.addEdge(r,a),t}pipe(e){return new qu({first:this,last:Vu(e)})}pick(e){return this.pipe(new Xu(e))}assign(e){return this.pipe(new Ku(new Hu({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:Il(n,t);yield*this._streamIterator(n,kl(t))}async*streamLog(e,t,n){const r=new Cl({...n,autoClose:!1,_schemaFormat:"original"}),a=kl(t);yield*this._streamLog(e,r,a)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.addHandler(t,!0),n.callbacks=e}const a=this.stream(e,n),s=async function(){try{const e=await a;for await(const n of e){const e=new Al({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await s}}streamEvents(e,t,n){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,n);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,n)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return Sl.fromReadableStream(n)}(r):Sl.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,n){const r=new Bl({...n,autoClose:!1}),a=kl(t),s=a.runId??po();a.runId=s;const i=a.callbacks;if(void 0===i)a.callbacks=[r];else if(Array.isArray(i))a.callbacks=i.concat(r);else{const e=i.copy();e.addHandler(r,!0),a.callbacks=e}const o=new AbortController,c=this,l=async function(){try{let n;t?.signal?"any"in AbortSignal?n=AbortSignal.any([o.signal,t.signal]):(n=t.signal,t.signal.addEventListener("abort",(()=>{o.abort()}),{once:!0})):n=o.signal;const i=await c.stream(e,{...a,signal:n}),l=r.tapOutputIterable(s,i);for await(const e of l)if(o.signal.aborted)break}finally{await r.finish()}}();let u,d=!1;try{for await(const t of r)d?(t.run_id===u&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,u=t.run_id,yield t)}finally{o.abort(),await l}}async*_streamEventsV1(e,t,n){let r,a=!1;const s=kl(t),i=s.tags??[],o=s.metadata??{},c=s.runName??this.getName(),l=new Cl({...n,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Gl({...n}),d=this._streamLog(e,l,s);for await(const t of d){if(r=r?r.concat(t):Tl.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:i,metadata:o,data:{input:e}};u.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),s=[...new Set(n)];for(const e of s){let t,n={};const a=r.state.logs[e];if(t=void 0===a.end_time?a.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==a.inputs&&(n.input=a.inputs);else if("end"===t)void 0!==a.inputs&&(n.input=a.inputs),n.output=a.final_output;else if("stream"===t){const e=a.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${a.name}"`);n={chunk:a.streamed_output[0]},a.streamed_output=[]}yield{event:`on_${a.type}_${t}`,name:a.name,run_id:a.id,tags:a.tags,metadata:a.metadata,data:n}}const{state:l}=r;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const n={event:`on_${l.type}_stream`,run_id:l.id,tags:i,metadata:o,name:c,data:t};u.includeEvent(n,l.type)&&(yield n)}}const h=r?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:i,metadata:o,data:{output:h.final_output}};u.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return Wl(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Bu({bound:this,config:{},configFactories:[r=>({callbacks:[new Hl({config:r,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return function(e,t){const n=t.name??e.getName(),r=t.description??t.schema?.description;return t.schema.constructor===so.ZodString?new Qu({name:n,description:r,schema:so.object({input:so.string()}).transform((e=>e.input)),bound:e}):new Qu({name:n,description:r,schema:t.schema,bound:e})}(this,e)}}class Bu extends Fu{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=vl(this.config,...e);return vl(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(kl(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(kl(e),this.kwargs)))):await this._mergeConfig(kl(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(kl(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(kl(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(kl(t),this.kwargs))}streamEvents(e,t,n){const r=this;return Sl.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig(kl(t),r.kwargs),version:t.version},n)}())}static isRunnableBinding(e){return e.bound&&Fu.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new Bu({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new Hl({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class zu extends Fu{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new zu({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,n){return this.bound.batch(e,xl(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new zu({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class Zu extends Bu{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return xl(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return io((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,r){const a={};try{await io((async s=>{const i=e.map(((e,t)=>t)).filter((e=>void 0===a[e.toString()]||a[e.toString()]instanceof Error)),o=i.map((t=>e[t])),c=i.map((e=>this._patchConfigForRetry(s,t?.[e],n?.[e]))),l=await super.batch(o,c,{...r,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],n=i[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),a[n.toString()]=t}if(u)throw u;return l}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(a).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>a[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class qu extends Fu{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=kl(t),r=await _l(n),a=await(r?.handleChainStart(this.toJSON(),Du(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let s,i=e;try{const e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){const s=e[r].invoke(i,xl(n,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${r+1}`)}));i=await Ol(s,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");s=await this.last.invoke(i,xl(n,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(Du(s,"output"))),s}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),a=await Promise.all(r.map(_l)),s=await Promise.all(a.map((async(t,n)=>{const a=await(t?.handleChainStart(this.toJSON(),Du(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,a})));let i=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(i,s.map(((t,n)=>{const a=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return xl(r[n],{callbacks:a})})),n);i=await Ol(t,r[0]?.signal)}}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(Du(i,"output"))))),i}async*_streamIterator(e,t){const n=await _l(t),{runId:r,...a}=t??{},s=await(n?.handleChainStart(this.toJSON(),Du(e,"input"),r,void 0,void 0,void 0,a?.runName)),i=[this.first,...this.middle,this.last];let o,c=!0;try{let n=i[0].transform(async function*(){yield e}(),xl(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<i.length;e+=1){const t=i[e];n=await t.transform(n,xl(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of n)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===o)o=e;else try{o=Il(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(Du(o,"output")))}getGraph(e){const t=new Ru;let n=null;return this.steps.forEach(((r,a)=>{const s=r.getGraph(e);0!==a&&s.trimFirstNode(),a!==this.steps.length-1&&s.trimLastNode(),t.extend(s);const i=s.firstNode();if(!i)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,i),n=s.lastNode()})),t}pipe(e){return qu.isRunnableSequence(e)?new qu({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new qu({first:this.first,middle:[...this.middle,this.last],last:Vu(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Fu.isRunnable(e)}static from([e,...t],n){let r={};return"string"==typeof n?r.name=n:void 0!==n&&(r=n),new qu({...r,first:Vu(e),middle:t.slice(0,-1).map(Vu),last:Vu(t[t.length-1])})}}class Hu extends Fu{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=Vu(n)}static from(e){return new Hu({steps:e})}async invoke(e,t){const n=kl(t),r=await _l(n),a=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const s={};try{const r=Object.entries(this.steps).map((async([t,r])=>{s[t]=await r.invoke(e,xl(n,{callbacks:a?.getChild(`map:key:${t}`)}))}));await Ol(Promise.all(r),t?.signal)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(s)),s}async*_transform(e,t,n){const r={...this.steps},a=$l(e,Object.keys(r).length),s=new Map(Object.entries(r).map((([e,r],s)=>{const i=r.transform(a[s],xl(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,i.next().then((t=>({key:e,gen:i,result:t})))]})));for(;s.size;){const e=Promise.race(s.values()),{key:t,result:r,gen:a}=await Ol(e,n?.signal);s.delete(t),r.done||(yield{[t]:r.value},s.set(t,a.next().then((e=>({key:t,gen:a,result:e})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=kl(t),r=new Pl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Sl.fromAsyncGenerator(r)}}class Wu extends Fu{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!dc(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),r=await _l(n);return Ol(this.func(xl(n,{callbacks:r}),e),n?.signal)}async*_streamIterator(e,t){const[n]=this._getOptionsList(t??{},1),r=await this.invoke(e,t);var a;if(Lu(r))for await(const e of r)n?.signal?.throwIfAborted(),yield e;else if(null!=(a=r)&&"object"==typeof a&&"next"in a&&"function"==typeof a.next)for(;;){n?.signal?.throwIfAborted();const e=r.next();if(e.done)break;yield e.value}else yield r}static from(e){return new Wu({func:e})}}class Gu extends Fu{static lc_name(){return"RunnableLambda"}constructor(e){if(dc(e.func))return Wu.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if(dc(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new Gu({func:e})}async _invoke(e,t,n){return new Promise(((r,a)=>{const s=xl(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});bl.runWithConfig(El(s),(async()=>{try{let n=await this.func(e,{...s});if(n&&Fu.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...s,recursionLimit:(s.recursionLimit??25)-1})}else if(Lu(n)){let e;for await(const r of Uu(s,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=Il(e,r)}catch(t){e=r}n=e}else if(Cu(n)){let e;for(const r of Mu(s,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=Il(e,r)}catch(t){e=r}n=e}r(n)}catch(e){a(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=Il(r,t)}catch(e){r=t}const a=xl(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}),s=await new Promise(((e,t)=>{bl.runWithConfig(El(a),(async()=>{try{const t=await this.func(r,{...a,config:a});e(t)}catch(e){t(e)}}))}));if(s&&Fu.isRunnable(s)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await s.stream(r,a);for await(const t of e)yield t}else if(Lu(s))for await(const e of Uu(a,s))n?.signal?.throwIfAborted(),yield e;else if(Cu(s))for(const e of Mu(a,s))n?.signal?.throwIfAborted(),yield e;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=kl(t),r=new Pl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Sl.fromAsyncGenerator(r)}}class Ju extends Fu{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=kl(t),r=await _l(n),{runId:a,...s}=n,i=await(r?.handleChainStart(this.toJSON(),Du(e,"input"),a,void 0,void 0,void 0,s?.runName)),o=xl(s,{callbacks:i?.getChild()});return await bl.runWithConfig(o,(async()=>{let t;for(const r of this.runnables()){n?.signal?.throwIfAborted();try{const t=await r.invoke(e,o);return await(i?.handleChainEnd(Du(t,"output"))),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(t)),t}))}async*_streamIterator(e,t){const n=kl(t),r=await _l(n),{runId:a,...s}=n,i=await(r?.handleChainStart(this.toJSON(),Du(e,"input"),a,void 0,void 0,void 0,s?.runName));let o,c,l;for(const t of this.runnables()){n?.signal?.throwIfAborted();const r=xl(s,{callbacks:i?.getChild()});try{c=Uu(r,await t.stream(e,r));break}catch(e){void 0===o&&(o=e)}}if(void 0===c){const e=o??new Error("No error stored at end of fallback.");throw await(i?.handleChainError(e)),e}try{for await(const e of c){yield e;try{l=void 0===l?l:Il(l,e)}catch(e){l=void 0}}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(Du(l,"output")))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),a=await Promise.all(r.map((e=>_l(e)))),s=await Promise.all(a.map((async(t,n)=>{const a=await(t?.handleChainStart(this.toJSON(),Du(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,a})));let i;for(const t of this.runnables()){r[0].signal?.throwIfAborted();try{const a=await t.batch(e,s.map(((e,t)=>xl(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(s.map(((e,t)=>e?.handleChainEnd(Du(a[t],"output"))))),a}catch(e){void 0===i&&(i=e)}}if(!i)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map((e=>e?.handleChainError(i)))),i}}function Vu(e){if("function"==typeof e)return new Gu({func:e});if(Fu.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=Vu(r);return new Hu({steps:t})}}class Ku extends Fu{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Hu&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[a,s]=$l(e),i=this.mapper.transform(s,xl(n,{callbacks:t?.getChild()})),o=i.next();for await(const e of a){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of i)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=kl(t),r=new Pl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Sl.fromAsyncGenerator(r)}}class Xu extends Fu{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=kl(t),r=new Pl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Sl.fromAsyncGenerator(r)}}class Qu extends Bu{constructor(e){super({bound:qu.from([Gu.from((async e=>{let t;if(Aa(e))try{t=await this.schema.parseAsync(e.args)}catch(t){throw new Ta("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t})).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}var Yu="object"==typeof window?window:{},ed="0123456789abcdef".split(""),td=[-2147483648,8388608,32768,128],nd=[24,16,8,0],rd=[];function ad(e){e?(rd[0]=rd[16]=rd[1]=rd[2]=rd[3]=rd[4]=rd[5]=rd[6]=rd[7]=rd[8]=rd[9]=rd[10]=rd[11]=rd[12]=rd[13]=rd[14]=rd[15]=0,this.blocks=rd):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}ad.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===Yu.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,a=0,s=e.length||0,i=this.blocks;a<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)for(r=this.start;a<s&&r<64;++a)i[r>>2]|=e[a]<<nd[3&r++];else for(r=this.start;a<s&&r<64;++a)(n=e.charCodeAt(a))<128?i[r>>2]|=n<<nd[3&r++]:n<2048?(i[r>>2]|=(192|n>>6)<<nd[3&r++],i[r>>2]|=(128|63&n)<<nd[3&r++]):n<55296||n>=57344?(i[r>>2]|=(224|n>>12)<<nd[3&r++],i[r>>2]|=(128|n>>6&63)<<nd[3&r++],i[r>>2]|=(128|63&n)<<nd[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++a)),i[r>>2]|=(240|n>>18)<<nd[3&r++],i[r>>2]|=(128|n>>12&63)<<nd[3&r++],i[r>>2]|=(128|n>>6&63)<<nd[3&r++],i[r>>2]|=(128|63&n)<<nd[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=i[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},ad.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=td[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},ad.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,a=this.h2,s=this.h3,i=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r&a|~r&s)+i+1518500249+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|~n&a)+s+1518500249+o[e+1]|0)<<5|s>>>27)+(i&(n=n<<30|n>>>2)|~i&r)+a+1518500249+o[e+2]|0)<<5|a>>>27)+(s&(i=i<<30|i>>>2)|~s&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(a&(s=s<<30|s>>>2)|~a&i)+n+1518500249+o[e+4]|0,a=a<<30|a>>>2;for(;e<40;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r^a^s)+i+1859775393+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^a)+s+1859775393+o[e+1]|0)<<5|s>>>27)+(i^(n=n<<30|n>>>2)^r)+a+1859775393+o[e+2]|0)<<5|a>>>27)+(s^(i=i<<30|i>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(a^(s=s<<30|s>>>2)^i)+n+1859775393+o[e+4]|0,a=a<<30|a>>>2;for(;e<60;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r&a|r&s|a&s)+i-1894007588+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|n&a|r&a)+s-1894007588+o[e+1]|0)<<5|s>>>27)+(i&(n=n<<30|n>>>2)|i&r|n&r)+a-1894007588+o[e+2]|0)<<5|a>>>27)+(s&(i=i<<30|i>>>2)|s&n|i&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(a&(s=s<<30|s>>>2)|a&i|s&i)+n-1894007588+o[e+4]|0,a=a<<30|a>>>2;for(;e<80;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r^a^s)+i-899497514+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^a)+s-899497514+o[e+1]|0)<<5|s>>>27)+(i^(n=n<<30|n>>>2)^r)+a-899497514+o[e+2]|0)<<5|a>>>27)+(s^(i=i<<30|i>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(a^(s=s<<30|s>>>2)^i)+n-899497514+o[e+4]|0,a=a<<30|a>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+a|0,this.h3=this.h3+s|0,this.h4=this.h4+i|0},ad.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,a=this.h4;return ed[e>>28&15]+ed[e>>24&15]+ed[e>>20&15]+ed[e>>16&15]+ed[e>>12&15]+ed[e>>8&15]+ed[e>>4&15]+ed[15&e]+ed[t>>28&15]+ed[t>>24&15]+ed[t>>20&15]+ed[t>>16&15]+ed[t>>12&15]+ed[t>>8&15]+ed[t>>4&15]+ed[15&t]+ed[n>>28&15]+ed[n>>24&15]+ed[n>>20&15]+ed[n>>16&15]+ed[n>>12&15]+ed[n>>8&15]+ed[n>>4&15]+ed[15&n]+ed[r>>28&15]+ed[r>>24&15]+ed[r>>20&15]+ed[r>>16&15]+ed[r>>12&15]+ed[r>>8&15]+ed[r>>4&15]+ed[15&r]+ed[a>>28&15]+ed[a>>24&15]+ed[a>>20&15]+ed[a>>16&15]+ed[a>>12&15]+ed[a>>8&15]+ed[a>>4&15]+ed[15&a]},ad.prototype.toString=ad.prototype.hex,ad.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,a>>24&255,a>>16&255,a>>8&255,255&a]},ad.prototype.array=ad.prototype.digest,ad.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const sd=(...e)=>{return t=e.join("_"),new ad(!0).update(t).hex();var t};class id{}const od=new Map;class cd extends id{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(sd(e,t))??null)}async update(e,t,n){this.cache.set(sd(e,t),n)}static global(){return new cd(od)}}class ld extends na{}class ud extends ld{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Oa(this.value)]}}class dd extends ld{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Ca(this.messages)}toChatMessages(){return this.messages}}var hd=n(67526),pd=Object.defineProperty;function fd(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let a=0;a<n.length-1;a++){const s=e.slice(n[a].start,n[a+1].end),i=t.get(s.join(","));null!=i&&(null==r||i<r[0])&&(r=[i,a])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var md,gd,yd=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...a]=t.split(" "),s=Number.parseInt(r,10);return a.forEach(((t,n)=>e[t]=s+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=hd.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),a=yd.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!i.has(e))):n);if(o.size>0){const t=yd.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;a.lastIndex=n,t=a.exec(e),null!=t&&!i.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?s.push(...fd(e,this.rankMap)):s.push(n)}if(null==t)break;let l=this.specialTokens[t[0]];s.push(l),c=t.index+t[0].length}return s}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const a=e[r],s=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=s&&(t.push(s),n+=s.length)}const r=new Uint8Array(n);let a=0;for(const e of t)r.set(e,a),a+=e.length;return this.textDecoder.decode(r)}},bd=yd;gd=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?pd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(bd,"symbol"!=typeof(md="specialTokenRegex")?md+"":md,gd);const _d={},vd=new ql({});function wd(e){return!("object"!=typeof e||!e||!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function))}class kd extends Fu{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class xd extends kd{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){const{cache:r,...a}=n;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache="object"==typeof r?r:r?cd.global():void 0,this.caller=new ql(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in _d||(_d[e]=vd.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new bd(e))).catch((t=>{throw delete _d[e],t}))),await _d[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new ud(e):Array.isArray(e)?new dd(e.map(Na)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),a=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return a}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Ed extends Fu{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=kl(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=kl(t);let r,a=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,a)if(void 0===r)r=t;else try{r=Il(r,t)}catch{r=void 0,a=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new Ku(new Hu({steps:e}))}}function Od(e){if(!e)return!1;if("object"!=typeof e)return!1;if(Array.isArray(e))return!1;const t=e;return!!t._def||(!!Object.values(so.ZodFirstPartyTypeKind).includes(t.constructor?.name??"NOT_INCLUDED")||"function"==typeof t.parse&&"function"==typeof t.parseAsync&&"function"==typeof t.safeParse&&"function"==typeof t.safeParseAsync)}function Sd(e){const t=[];for(const r of e){let e=r;if(Array.isArray(r.content))for(let t=0;t<r.content.length;t++){const a=r.content[t];(ra(n=a)&&"url"===n.source_type&&"url"in n&&"string"==typeof n.url||aa(a))&&e===r&&(e=new r.constructor({...e,content:[...r.content.slice(0,t),sa(a),...r.content.slice(t+1)]}))}t.push(e)}var n;return t}class $d extends xd{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){const n=$d._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===$d.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const n=$d._convertInputToPromptValue(e).toChatMessages(),[r,a]=this._separateRunnableConfigFromCallOptionsCompat(t),s={...r.metadata,...this.getLsParams(a)},i=await fl.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this?.invocationParams(a),batch_size:1},c=await(i?.handleChatModelStart(this.toJSON(),[Sd(n)],r.runId,void 0,o,void 0,void 0,r.runName));let l,u;try{for await(const e of this._streamResponseChunks(n,a,c?.[0])){if(null==e.message.id){const t=c?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,l=l?l.concat(e):e,va(e.message)&&void 0!==e.message.usage_metadata&&(u={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((c??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((c??[]).map((e=>e?.handleLLMEnd({generations:[[l]],llmOutput:u}))))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n,r){const a=e.map((e=>e.map(Na)));let s;if(void 0!==r&&r.length===a.length)s=r;else{const e={...n.metadata,...this.getLsParams(t)},r=await fl.configure(n.callbacks,this.callbacks,n.tags,this.tags,e,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:1};s=await(r?.handleChatModelStart(this.toJSON(),a.map(Sd),n.runId,void 0,i,void 0,void 0,n.runName))}const i=[],o=[];if(s?.[0].handlers.find(Dc)&&!this.disableStreaming&&1===a.length&&this._streamResponseChunks!==$d.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(a[0],t,s?.[0]);let n,r;for await(const t of e){if(null==t.message.id){const e=s?.at(0)?.runId;null!=e&&t.message._updateId(`run-${e}`)}n=void 0===n?t:Il(n,t),va(t.message)&&void 0!==t.message.usage_metadata&&(r={tokenUsage:{promptTokens:t.message.usage_metadata.input_tokens,completionTokens:t.message.usage_metadata.output_tokens,totalTokens:t.message.usage_metadata.total_tokens}})}if(void 0===n)throw new Error("Received empty response from chat model call.");i.push([n]),await(s?.[0].handleLLMEnd({generations:i,llmOutput:r}))}catch(e){throw await(s?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(a.map(((e,n)=>this._generate(e,{...t,promptIndex:n},s?.[n]))));await Promise.all(e.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations){if(null==e.message.id){const t=s?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),i[t]=n.generations,o[t]=n.llmOutput,s?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(s?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})))}const c={generations:i,llmOutput:o.length?this._combineLLMOutput?.(...o):void 0};return Object.defineProperty(c,Ll,{value:s?{runIds:s?.map((e=>e.runId))}:void 0,configurable:!0}),c}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:a}){const s=e.map((e=>e.map(Na))),i={...a.metadata,...this.getLsParams(r)},o=await fl.configure(a.callbacks,this.callbacks,a.tags,this.tags,i,this.metadata,{verbose:this.verbose}),c={options:r,invocation_params:this?.invocationParams(r),batch_size:1},l=await(o?.handleChatModelStart(this.toJSON(),s.map(Sd),a.runId,void 0,c,void 0,void 0,a.runName)),u=[],d=(await Promise.allSettled(s.map((async(e,r)=>{const a=$d._convertInputToPromptValue(e).toString(),s=await t.lookup(a,n);return null==s&&u.push(r),s})))).map(((e,t)=>({result:e,runManager:l?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),h=[];await Promise.all(d.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return h[n]=r.map((e=>("message"in e&&ma(e.message)&&_a(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e))),r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]},void 0,void 0,void 0,{cached:!0})}return await(t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(e.reason)})));const p={generations:h,missingPromptIndices:u,startedRunManagers:l};return Object.defineProperty(p,Ll,{value:l?{runIds:l?.map((e=>e.runId))}:void 0,configurable:!0}),p}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const a=e.map((e=>e.map(Na))),[s,i]=this._separateRunnableConfigFromCallOptionsCompat(r);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(a,i,s);const{cache:o}=this,c=this._getSerializedCacheKeyParametersForCall(i),{generations:l,missingPromptIndices:u,startedRunManagers:d}=await this._generateCached({messages:a,cache:o,llmStringKey:c,parsedOptions:i,handledOptions:s});let h={};if(u.length>0){const e=await this._generateUncached(u.map((e=>a[e])),i,s,void 0!==d?u.map((e=>d?.[e])):void 0);await Promise.all(e.generations.map((async(e,t)=>{const n=u[t];l[n]=e;const r=$d._convertInputToPromptValue(a[n]).toString();return o.update(r,c,e)}))),h=e.llmOutput??{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(Na)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new Oa(e),a=await this.call([r],t,n);if("string"!=typeof a.content)throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,r=t?.name,a=n.description??"A function available to call.",s=t?.method,i=t?.includeRaw;if("jsonMode"===s)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,c=r??"extract";Od(n)?o=[{type:"function",function:{name:c,description:a,parameters:$u(n)}}]:("name"in n&&(c=n.name),o=[{type:"function",function:{name:c,description:a,parameters:n}}]);const l=this.bindTools(o),u=Gu.from((e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find((e=>e.name===c));if(!t)throw new Error(`No tool call found with name ${c}.`);return t.args}));if(!i)return l.pipe(u).withConfig({runName:"StructuredOutput"});const d=Ed.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),h=Ed.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return qu.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}}class Id extends Fu{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class Pd extends Id{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class Ad extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Pa(this,"OUTPUT_PARSING_FAILURE")}}function Td(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!Td(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!Td(e[r],t[r]))return!1;return!0}return e===t}function Rd(e){return encodeURI(function(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}(e))}const jd={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Nd={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},Cd={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let Ld="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Md(e,t=Object.create(null),n=Ld,r=""){if(e&&"object"==typeof e&&!Array.isArray(e)){const a=e.$id||e.id;if(a){const s=new URL(a,n.href);s.hash.length>1?t[s.href]=e:(s.hash="",""===r?n=s:Md(e,t,n))}}else if(!0!==e&&!1!==e)return t;const a=n.href+(r?"#"+r:"");if(void 0!==t[a])throw new Error(`Duplicate schema URI "${a}".`);if(t[a]=e,!0===e||!1===e)return t;if(void 0===e.__absolute_uri__&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:a}),e.$ref&&void 0===e.__absolute_ref__){const t=new URL(e.$ref,n.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:t.href})}if(e.$recursiveRef&&void 0===e.__absolute_recursive_ref__){const t=new URL(e.$recursiveRef,n.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:t.href})}e.$anchor&&(t[new URL("#"+e.$anchor,n.href).href]=e);for(let a in e){if(Cd[a])continue;const s=`${r}/${Rd(a)}`,i=e[a];if(Array.isArray(i)){if(jd[a]){const e=i.length;for(let r=0;r<e;r++)Md(i[r],t,n,`${s}/${r}`)}}else if(Nd[a])for(let e in i)Md(i[e],t,n,`${s}/${Rd(e)}`);else Md(i,t,n,s)}return t}const Ud=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,Dd=[0,31,28,31,30,31,30,31,31,30,31,30,31],Fd=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function Bd(e){return e.test.bind(e)}const zd={date:Zd,time:qd.bind(void 0,!1),"date-time":function(e){const t=e.split(Hd);return 2==t.length&&Zd(t[0])&&qd(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return Wd.test(e)&&Gd.test(e)},"uri-reference":Bd(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":Bd(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:Bd(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;const[t,n,...r]=e.split("@");return!(!t||!n||0!==r.length||t.length>64||n.length>253)&&"."!==t[0]&&!t.endsWith(".")&&!t.includes("..")&&!(!/^[a-z0-9.-]+$/i.test(n)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t))&&n.split(".").every((e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e)))},hostname:Bd(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:Bd(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:Bd(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:function(e){if(Jd.test(e))return!1;try{return new RegExp(e,"u"),!0}catch(e){return!1}},uuid:Bd(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":Bd(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":Bd(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":Bd(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function Zd(e){const t=e.match(Ud);if(!t)return!1;const n=+t[1],r=+t[2],a=+t[3];return r>=1&&r<=12&&a>=1&&a<=(2==r&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(n)?29:Dd[r])}function qd(e,t){const n=t.match(Fd);if(!n)return!1;const r=+n[1],a=+n[2],s=+n[3],i=!!n[5];return(r<=23&&a<=59&&s<=59||23==r&&59==a&&60==s)&&(!e||i)}const Hd=/t|\s/i,Wd=/\/|:/,Gd=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,Jd=/[^\\]\\Z/;var Vd;function Kd(e,t,n="2019-09",r=Md(t),a=!0,s=null,i="#",o="#",c=Object.create(null)){if(!0===t)return{valid:!0,errors:[]};if(!1===t)return{valid:!1,errors:[{instanceLocation:i,keyword:"false",keywordLocation:i,error:"False boolean schema."}]};const l=typeof e;let u;switch(l){case"boolean":case"number":case"string":u=l;break;case"object":u=null===e?"null":Array.isArray(e)?"array":"object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:p,type:f,const:m,enum:g,required:y,not:b,anyOf:_,allOf:v,oneOf:w,if:k,then:x,else:E,format:O,properties:S,patternProperties:$,additionalProperties:I,unevaluatedProperties:P,minProperties:A,maxProperties:T,propertyNames:R,dependentRequired:j,dependentSchemas:N,dependencies:C,prefixItems:L,items:M,additionalItems:U,unevaluatedItems:D,contains:F,minContains:B,maxContains:z,minItems:Z,maxItems:q,uniqueItems:H,minimum:W,maximum:G,exclusiveMinimum:J,exclusiveMaximum:V,multipleOf:K,minLength:X,maxLength:Q,pattern:Y,__absolute_ref__:ee,__absolute_recursive_ref__:te}=t,ne=[];if(!0===p&&null===s&&(s=t),"#"===h){const l=null===s?r[te]:s,u=`${o}/$recursiveRef`,d=Kd(e,null===s?t:s,n,r,a,l,i,u,c);d.valid||ne.push({instanceLocation:i,keyword:"$recursiveRef",keywordLocation:u,error:"A subschema had errors."},...d.errors)}if(void 0!==d){const t=r[ee||d];if(void 0===t){let e=`Unresolved $ref "${d}".`;throw ee&&ee!==d&&(e+=`  Absolute URI "${ee}".`),e+=`\nKnown schemas:\n- ${Object.keys(r).join("\n- ")}`,new Error(e)}const l=`${o}/$ref`,u=Kd(e,t,n,r,a,s,i,l,c);if(u.valid||ne.push({instanceLocation:i,keyword:"$ref",keywordLocation:l,error:"A subschema had errors."},...u.errors),"4"===n||"7"===n)return{valid:0===ne.length,errors:ne}}if(Array.isArray(f)){let t=f.length,n=!1;for(let r=0;r<t;r++)if(u===f[r]||"integer"===f[r]&&"number"===u&&e%1==0&&e==e){n=!0;break}n||ne.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f.join('", "')}".`})}else"integer"===f?("number"!==u||e%1||e!=e)&&ne.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f}".`}):void 0!==f&&u!==f&&ne.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f}".`});if(void 0!==m&&("object"===u||"array"===u?Td(e,m)||ne.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`}):e!==m&&ne.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`})),void 0!==g&&("object"===u||"array"===u?g.some((t=>Td(e,t)))||ne.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some((t=>e===t))||ne.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),void 0!==b){const t=`${o}/not`;Kd(e,b,n,r,a,s,i,t).valid&&ne.push({instanceLocation:i,keyword:"not",keywordLocation:t,error:'Instance matched "not" schema.'})}let re=[];if(void 0!==_){const t=`${o}/anyOf`,l=ne.length;let u=!1;for(let o=0;o<_.length;o++){const l=_[o],d=Object.create(c),h=Kd(e,l,n,r,a,!0===p?s:null,i,`${t}/${o}`,d);ne.push(...h.errors),u=u||h.valid,h.valid&&re.push(d)}u?ne.length=l:ne.splice(l,0,{instanceLocation:i,keyword:"anyOf",keywordLocation:t,error:"Instance does not match any subschemas."})}if(void 0!==v){const t=`${o}/allOf`,l=ne.length;let u=!0;for(let o=0;o<v.length;o++){const l=v[o],d=Object.create(c),h=Kd(e,l,n,r,a,!0===p?s:null,i,`${t}/${o}`,d);ne.push(...h.errors),u=u&&h.valid,h.valid&&re.push(d)}u?ne.length=l:ne.splice(l,0,{instanceLocation:i,keyword:"allOf",keywordLocation:t,error:"Instance does not match every subschema."})}if(void 0!==w){const t=`${o}/oneOf`,l=ne.length,u=w.filter(((o,l)=>{const u=Object.create(c),d=Kd(e,o,n,r,a,!0===p?s:null,i,`${t}/${l}`,u);return ne.push(...d.errors),d.valid&&re.push(u),d.valid})).length;1===u?ne.length=l:ne.splice(l,0,{instanceLocation:i,keyword:"oneOf",keywordLocation:t,error:`Instance does not match exactly one subschema (${u} matches).`})}if("object"!==u&&"array"!==u||Object.assign(c,...re),void 0!==k){const t=`${o}/if`;if(Kd(e,k,n,r,a,s,i,t,c).valid){if(void 0!==x){const l=Kd(e,x,n,r,a,s,i,`${o}/then`,c);l.valid||ne.push({instanceLocation:i,keyword:"if",keywordLocation:t,error:'Instance does not match "then" schema.'},...l.errors)}}else if(void 0!==E){const l=Kd(e,E,n,r,a,s,i,`${o}/else`,c);l.valid||ne.push({instanceLocation:i,keyword:"if",keywordLocation:t,error:'Instance does not match "else" schema.'},...l.errors)}}if("object"===u){if(void 0!==y)for(const t of y)t in e||ne.push({instanceLocation:i,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${t}".`});const t=Object.keys(e);if(void 0!==A&&t.length<A&&ne.push({instanceLocation:i,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${A} properties.`}),void 0!==T&&t.length>T&&ne.push({instanceLocation:i,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${T} properties.`}),void 0!==R){const t=`${o}/propertyNames`;for(const o in e){const e=`${i}/${Rd(o)}`,c=Kd(o,R,n,r,a,s,e,t);c.valid||ne.push({instanceLocation:i,keyword:"propertyNames",keywordLocation:t,error:`Property name "${o}" does not match schema.`},...c.errors)}}if(void 0!==j){const t=`${o}/dependantRequired`;for(const n in j)if(n in e){const r=j[n];for(const a of r)a in e||ne.push({instanceLocation:i,keyword:"dependentRequired",keywordLocation:t,error:`Instance has "${n}" but does not have "${a}".`})}}if(void 0!==N)for(const t in N){const l=`${o}/dependentSchemas`;if(t in e){const o=Kd(e,N[t],n,r,a,s,i,`${l}/${Rd(t)}`,c);o.valid||ne.push({instanceLocation:i,keyword:"dependentSchemas",keywordLocation:l,error:`Instance has "${t}" but does not match dependant schema.`},...o.errors)}}if(void 0!==C){const t=`${o}/dependencies`;for(const o in C)if(o in e){const c=C[o];if(Array.isArray(c))for(const n of c)n in e||ne.push({instanceLocation:i,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not have "${n}".`});else{const l=Kd(e,c,n,r,a,s,i,`${t}/${Rd(o)}`);l.valid||ne.push({instanceLocation:i,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not match dependant schema.`},...l.errors)}}}const l=Object.create(null);let u=!1;if(void 0!==S){const t=`${o}/properties`;for(const o in S){if(!(o in e))continue;const d=`${i}/${Rd(o)}`,h=Kd(e[o],S[o],n,r,a,s,d,`${t}/${Rd(o)}`);if(h.valid)c[o]=l[o]=!0;else if(u=a,ne.push({instanceLocation:i,keyword:"properties",keywordLocation:t,error:`Property "${o}" does not match schema.`},...h.errors),u)break}}if(!u&&void 0!==$){const t=`${o}/patternProperties`;for(const o in $){const d=new RegExp(o,"u"),h=$[o];for(const p in e){if(!d.test(p))continue;const f=`${i}/${Rd(p)}`,m=Kd(e[p],h,n,r,a,s,f,`${t}/${Rd(o)}`);m.valid?c[p]=l[p]=!0:(u=a,ne.push({instanceLocation:i,keyword:"patternProperties",keywordLocation:t,error:`Property "${p}" matches pattern "${o}" but does not match associated schema.`},...m.errors))}}}if(u||void 0===I){if(!u&&void 0!==P){const t=`${o}/unevaluatedProperties`;for(const o in e)if(!c[o]){const l=`${i}/${Rd(o)}`,u=Kd(e[o],P,n,r,a,s,l,t);u.valid?c[o]=!0:ne.push({instanceLocation:i,keyword:"unevaluatedProperties",keywordLocation:t,error:`Property "${o}" does not match unevaluated properties schema.`},...u.errors)}}}else{const t=`${o}/additionalProperties`;for(const o in e){if(l[o])continue;const d=`${i}/${Rd(o)}`,h=Kd(e[o],I,n,r,a,s,d,t);h.valid?c[o]=!0:(u=a,ne.push({instanceLocation:i,keyword:"additionalProperties",keywordLocation:t,error:`Property "${o}" does not match additional properties schema.`},...h.errors))}}}else if("array"===u){void 0!==q&&e.length>q&&ne.push({instanceLocation:i,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${q}).`}),void 0!==Z&&e.length<Z&&ne.push({instanceLocation:i,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${Z}).`});const t=e.length;let l=0,u=!1;if(void 0!==L){const d=`${o}/prefixItems`,h=Math.min(L.length,t);for(;l<h;l++){const t=Kd(e[l],L[l],n,r,a,s,`${i}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=a,ne.push({instanceLocation:i,keyword:"prefixItems",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}if(void 0!==M){const d=`${o}/items`;if(Array.isArray(M)){const o=Math.min(M.length,t);for(;l<o;l++){const t=Kd(e[l],M[l],n,r,a,s,`${i}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=a,ne.push({instanceLocation:i,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}else for(;l<t;l++){const t=Kd(e[l],M,n,r,a,s,`${i}/${l}`,d);if(c[l]=!0,!t.valid&&(u=a,ne.push({instanceLocation:i,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}if(!u&&void 0!==U){const d=`${o}/additionalItems`;for(;l<t;l++){const t=Kd(e[l],U,n,r,a,s,`${i}/${l}`,d);c[l]=!0,t.valid||(u=a,ne.push({instanceLocation:i,keyword:"additionalItems",keywordLocation:d,error:"Items did not match additional items schema."},...t.errors))}}}if(void 0!==F)if(0===t&&void 0===B)ne.push({instanceLocation:i,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==B&&t<B)ne.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${t}) than minContains (${B}).`});else{const l=`${o}/contains`,u=ne.length;let d=0;for(let o=0;o<t;o++){const t=Kd(e[o],F,n,r,a,s,`${i}/${o}`,l);t.valid?(c[o]=!0,d++):ne.push(...t.errors)}d>=(B||0)&&(ne.length=u),void 0===B&&void 0===z&&0===d?ne.splice(u,0,{instanceLocation:i,keyword:"contains",keywordLocation:l,error:"Array does not contain item matching schema."}):void 0!==B&&d<B?ne.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${B} items matching schema. Only ${d} items were found.`}):void 0!==z&&d>z&&ne.push({instanceLocation:i,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${z} items matching schema. ${d} items were found.`})}if(!u&&void 0!==D){const u=`${o}/unevaluatedItems`;for(;l<t;l++){if(c[l])continue;const t=Kd(e[l],D,n,r,a,s,`${i}/${l}`,u);c[l]=!0,t.valid||ne.push({instanceLocation:i,keyword:"unevaluatedItems",keywordLocation:u,error:"Items did not match unevaluated items schema."},...t.errors)}}if(H)for(let n=0;n<t;n++){const r=e[n],a="object"==typeof r&&null!==r;for(let s=0;s<t;s++){if(n===s)continue;const t=e[s];(r===t||a&&"object"==typeof t&&null!==t&&Td(r,t))&&(ne.push({instanceLocation:i,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${n} and ${s}.`}),n=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER)}}}else if("number"===u){if("4"===n?(void 0!==W&&(!0===J&&e<=W||e<W)&&ne.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${J?"or equal to ":""} ${W}.`}),void 0!==G&&(!0===V&&e>=G||e>G)&&ne.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${V?"or equal to ":""} ${G}.`})):(void 0!==W&&e<W&&ne.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${W}.`}),void 0!==G&&e>G&&ne.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${G}.`}),void 0!==J&&e<=J&&ne.push({instanceLocation:i,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${J}.`}),void 0!==V&&e>=V&&ne.push({instanceLocation:i,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${V}.`})),void 0!==K){const t=e%K;Math.abs(0-t)>=1.1920929e-7&&Math.abs(K-t)>=1.1920929e-7&&ne.push({instanceLocation:i,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${K}.`})}}else if("string"===u){const t=void 0===X&&void 0===Q?0:function(e){let t,n=0,r=e.length,a=0;for(;a<r;)n++,t=e.charCodeAt(a++),t>=55296&&t<=56319&&a<r&&(t=e.charCodeAt(a),56320==(64512&t)&&a++);return n}(e);void 0!==X&&t<X&&ne.push({instanceLocation:i,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${t} < ${X}).`}),void 0!==Q&&t>Q&&ne.push({instanceLocation:i,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${t} > ${Q}).`}),void 0===Y||new RegExp(Y,"u").test(e)||ne.push({instanceLocation:i,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),void 0!==O&&zd[O]&&!zd[O](e)&&ne.push({instanceLocation:i,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${O}".`})}return{valid:0===ne.length,errors:ne}}!function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"}(Vd||(Vd={}));class Xd extends Pd{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Qd extends Xd{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const a of e){if("string"!=typeof a&&"string"!=typeof a.content)throw new Error("Cannot handle non-string output.");let e;if(ma(r=a)&&"function"==typeof r.concat){if("string"!=typeof a.content)throw new Error("Cannot handle non-string message output.");e=new Ul({message:a,text:a.content})}else if(ma(a)){if("string"!=typeof a.content)throw new Error("Cannot handle non-string message output.");e=new Ul({message:La(a),text:a.content})}else e=new Ml({text:a});n=void 0===n?e:n.concat(e);const s=await this.parsePartialResult([n]);null==s||Td(s,t)||(this.diff?yield this._diff(t,s):yield s,t=s)}var r}getFormatInstructions(){return""}}class Yd extends Pd{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(so.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,so.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify($u(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new Ad(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class eh extends Qd{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?jc(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Wr(e[0].text)}async parse(e){return Wr(e,JSON.parse)}getFormatInstructions(){return""}}function th(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=Gr(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new Ad([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function nh(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function rh(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class ah extends Qd{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){const n=e[0].message;let r;if(_a(n)&&n.tool_calls?.length?r=n.tool_calls.map((e=>{const{id:t,...n}=e;return this.returnId?{id:t,...n}:n})):void 0!==n.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map((e=>th(e,{returnId:this.returnId,partial:t})))),!r)return[];const a=[];for(const e of r)if(void 0!==e){const t={type:e.name,args:e.args,id:e.id};a.push(t)}return a}}class sh extends ah{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Ad(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter((e=>e.type===this.keyName));let n=t;if(t.length)return this.returnId||(n=t.map((e=>e.args))),this.returnSingle?n[0]:n}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter((e=>e.type===this.keyName));let n=t;if(!t.length)return;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function ih(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function oh(e,t,n,r,a){e[t]=n,ih(e,t,r,a)}function ch(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>ch(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return lh(e,t)}}const lh=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":oh(n,"minimum",r.value,r.message,t);break;case"max":oh(n,"maximum",r.value,r.message,t)}return n};let uh;const dh=/^[cC][^\s-]{8,}$/,hh=/^[0-9a-z]+$/,ph=/^[0-9A-HJKMNP-TV-Z]{26}$/,fh=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,mh=()=>(void 0===uh&&(uh=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),uh),gh=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,yh=/^[a-zA-Z0-9_-]{21}$/;function bh(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?_h(e):e}if(e.checks)for(const a of e.checks)switch(a.kind){case"min":oh(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,a.value):a.value,a.message,t);break;case"max":oh(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":vh(n,"email",a.message,t);break;case"format:idn-email":vh(n,"idn-email",a.message,t);break;case"pattern:zod":wh(n,fh,a.message,t)}break;case"url":vh(n,"uri",a.message,t);break;case"uuid":vh(n,"uuid",a.message,t);break;case"regex":wh(n,a.regex,a.message,t);break;case"cuid":wh(n,dh,a.message,t);break;case"cuid2":wh(n,hh,a.message,t);break;case"startsWith":wh(n,RegExp(`^${r(a.value)}`),a.message,t);break;case"endsWith":wh(n,RegExp(`${r(a.value)}$`),a.message,t);break;case"datetime":vh(n,"date-time",a.message,t);break;case"date":vh(n,"date",a.message,t);break;case"time":vh(n,"time",a.message,t);break;case"duration":vh(n,"duration",a.message,t);break;case"length":oh(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,a.value):a.value,a.message,t),oh(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,a.value):a.value,a.message,t);break;case"includes":wh(n,RegExp(r(a.value)),a.message,t);break;case"ip":"v6"!==a.version&&vh(n,"ipv4",a.message,t),"v4"!==a.version&&vh(n,"ipv6",a.message,t);break;case"emoji":wh(n,mh,a.message,t);break;case"ulid":wh(n,ph,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":vh(n,"binary",a.message,t);break;case"contentEncoding:base64":oh(n,"contentEncoding","base64",a.message,t);break;case"pattern:zod":wh(n,gh,a.message,t)}break;case"nanoid":wh(n,yh,a.message,t)}return n}const _h=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),vh=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):oh(e,"format",t,n,r)},wh=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:kh(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):oh(e,"pattern",kh(t,r),n,r)},kh=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),a=n.flags.includes("m"),s=n.flags.includes("s"),i=r?n.source.toLowerCase():n.source;let o="",c=!1,l=!1,u=!1;for(let e=0;e<i.length;e++)if(c)o+=i[e],c=!1;else{if(r)if(l){if(i[e].match(/[a-z]/)){u?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],u=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(a){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}s&&"."===i[e]?o+=l?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?c=!0:l&&"]"===i[e]?l=!1:l||"["!==i[e]||(l=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function xh(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===wi.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:Ph(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Ph(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===wi.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(bh(e.keyType._def,t)).reduce(((e,[t,n])=>"type"===t?e:{...e,[t]:n}),{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===wi.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const Eh={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Oh=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>Ph(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function Sh(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Ph(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Ph(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}const $h=Symbol("Let zodToJsonSchema decide on which parser to use"),Ih={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function Ph(e,t,n=!1){const r=t.seen.get(e);if(t.override){const a=t.override?.(e,t,r,n);if(a!==$h)return a}if(r&&!n){const e=Ah(r,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const s=Rh(e,e.typeName,t,n);return s&&jh(e,t,s),a.jsonSchema=s,s}const Ah=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Th(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Th=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Rh=(e,t,n,r)=>{switch(t){case wi.ZodString:return bh(e,n);case wi.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",ih(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?oh(n,"minimum",r.value,r.message,t):oh(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),oh(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?oh(n,"maximum",r.value,r.message,t):oh(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),oh(n,"maximum",r.value,r.message,t));break;case"multipleOf":oh(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case wi.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const a=[...t.currentPath,"properties",n],s=Ph(r._def,{...t,currentPath:a,propertyPath:a});return void 0===s?e:(t.openaiStrictMode&&r.isOptional()&&!r.isNullable()&&console.warn(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required\nThis will become an error in a future version of the SDK.`),{properties:{...e.properties,[n]:s},required:r.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]})}),{properties:{},required:[]}),additionalProperties:Sh(e,t)};return n.required.length||delete n.required,n}(e,n);case wi.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?oh(n,"minimum",r.value,r.message,t):oh(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),oh(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?oh(n,"maximum",r.value,r.message,t):oh(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),oh(n,"maximum",r.value,r.message,t));break;case"multipleOf":oh(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case wi.ZodBoolean:return{type:"boolean"};case wi.ZodDate:return ch(e,n);case wi.ZodUndefined:return{not:{}};case wi.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case wi.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==wi.ZodAny&&(n.items=Ph(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&oh(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&oh(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(oh(n,"minItems",e.exactLength.value,e.exactLength.message,t),oh(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case wi.ZodUnion:case wi.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Oh(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in Eh&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=Eh[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return Oh(e,t)}(e,n);case wi.ZodIntersection:return function(e,t){const n=[Ph(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Ph(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),a.length?{allOf:a,...r}:void 0}(e,n);case wi.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>Ph(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:Ph(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>Ph(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case wi.ZodRecord:return xh(e,n);case wi.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case wi.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case wi.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])),r=n.map((e=>t[e])),a=Array.from(new Set(r.map((e=>typeof e))));return{type:1===a.length?"string"===a[0]?"string":"number":["string","number"],enum:r}}(e);case wi.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:Eh[e.innerType._def.typeName],nullable:!0}:{type:[Eh[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Ph(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Ph(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case wi.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Ph(e.innerType._def,t);const n=Ph(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case wi.ZodMap:return function(e,t){return"record"===t.mapStrategy?xh(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Ph(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Ph(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case wi.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Ph(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&oh(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&oh(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case wi.ZodLazy:return Ph(e.getter()._def,n);case wi.ZodPromise:return function(e,t){return Ph(e.type._def,t)}(e,n);case wi.ZodNaN:case wi.ZodNever:return{not:{}};case wi.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?Ph(e.schema._def,t,n):{}}(e,n,r);case wi.ZodAny:case wi.ZodUnknown:return{};case wi.ZodDefault:return function(e,t){return{...Ph(e.innerType._def,t),default:e.defaultValue()}}(e,n);case wi.ZodBranded:return function(e,t){return Ph(e.type._def,t)}(e,n);case wi.ZodReadonly:case wi.ZodCatch:return((e,t)=>Ph(e.innerType._def,t))(e,n);case wi.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Ph(e.in._def,t);if("output"===t.pipeStrategy)return Ph(e.out._def,t);const n=Ph(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Ph(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case wi.ZodFunction:case wi.ZodVoid:case wi.ZodSymbol:default:return}},jh=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Nh=e=>"_def"in e?e._def:e;function Ch(e,t){return((e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...Ih,basePath:["#"],definitions:{},name:e}:{...Ih,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[Nh(n),{def:Nh(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="title"===t?.nameStrategy?void 0:t?.name,a=Ph(e._def,void 0===r?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},s=void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(a.title=s);const i=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let r=0;r<500;r++){const r=Object.entries(n.definitions).filter((([e])=>!t.has(e)));if(0===r.length)break;for(const[a,s]of r)e[a]=Ph(Nh(s),{...n,currentPath:[...n.basePath,n.definitionPath,a]},!0)??{},t.add(a)}return e})(),o=void 0===r?i?{...a,[n.definitionPath]:i}:a:"duplicate-ref"===n.nameStrategy?{...a,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[r]:a}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...i,[r]:a}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o})(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Lh(e,t,n){return function(t){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),n}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:Ch(e,{name:t})}})}function Mh(e){return function(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&Od(e.schema)}(e)||function(e){return void 0!==e&&Fu.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}(e)||function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)}function Uh(e,t){const n="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:(r=e.schema,Od(r)?$u(r):r),...void 0!==n?.strict?{strict:n.strict}:{}};var r}function Dh(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function Fh(e){let t;return e.constructor.name===U.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===L.name?(t=new Error(e.message),t.name="AbortError"):t=400===e.status&&e.message.includes("tool_calls")?Dh(e,"INVALID_TOOL_RESULTS"):401===e.status?Dh(e,"MODEL_AUTHENTICATION"):429===e.status?Dh(e,"MODEL_RATE_LIMIT"):404===e.status?Dh(e,"MODEL_NOT_FOUND"):e,t}function Bh(e){return e?"any"===e||"required"===e?"required":"auto"===e?"auto":"none"===e?"none":"string"==typeof e?{type:"function",function:{name:e}}:e:void 0}function zh(e,t){const n=[];for(const[r,a]of Object.entries(e.properties??{}))a.description&&t<2&&n.push(`// ${a.description}`),e.required?.includes(r)?n.push(`${r}: ${Zh(a,t)},`):n.push(`${r}?: ${Zh(a,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function Zh(e,t){if(void 0!==(n=e).anyOf&&Array.isArray(n.anyOf))return e.anyOf.map((e=>Zh(e,t))).join(" | ");var n;switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",zh(e,t+2),"}"].join("\n");case"array":return e.items?`${Zh(e.items,t)}[]`:"any[]";default:return""}}function qh(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!ka.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}const Hh={providerName:"ChatOpenAI",fromStandardTextBlock(e){return{type:"text",text:e.text}},fromStandardImageBlock(e){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};if("base64"===e.source_type)return{type:"image_url",image_url:{url:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(e){if("url"===e.source_type){const t=oa({dataUrl:e.url});if(!t)throw new Error(`URL audio blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);const n=t.mime_type||e.mime_type||"";let r;try{r=ia(n)}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==r.type||"wav"!==r.subtype&&"mp3"!==r.subtype)throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:r.subtype,data:t.data}}}if("base64"===e.source_type){let t;try{t=ia(e.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:e.data}}}throw new Error(`Audio content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(e){if("url"===e.source_type){if(!oa({dataUrl:e.url}))throw new Error(`URL file blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:e.url,...e.metadata?.filename||e.metadata?.name?{filename:e.metadata?.filename||e.metadata?.name}:{}}}}if("base64"===e.source_type)return{type:"file",file:{file_data:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.filename||e.metadata?.name||e.metadata?.title?{filename:e.metadata?.filename||e.metadata?.name||e.metadata?.title}:{}}};if("id"===e.source_type)return{type:"file",file:{file_id:e.id}};throw new Error(`File content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)}};function Wh(e,t){return e.flatMap((e=>{let n=qh(e);"system"===n&&Yh(t)&&(n="developer");const r={role:n,content:"string"==typeof e.content?e.content:e.content.map((e=>ra(e)?ca(e,Hh):e))};return null!=e.name&&(r.name=e.name),null!=e.additional_kwargs.function_call&&(r.function_call=e.additional_kwargs.function_call,r.content=""),_a(e)&&e.tool_calls?.length?(r.tool_calls=e.tool_calls.map(nh),r.content=""):(null!=e.additional_kwargs.tool_calls&&(r.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(r.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio?[r,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:r}))}const Gh="__openai_function_call_ids__";function Jh(e,t){return e.flatMap((e=>{let n=qh(e);if("system"===n&&Yh(t)&&(n="developer"),"function"===n)throw new Error("Function messages are not supported in Responses API");if("tool"===n){const t=e;if("computer_call_output"===t.additional_kwargs?.type){const e=(()=>{if("string"==typeof t.content)return{type:"computer_screenshot",image_url:t.content};if(Array.isArray(t.content)){const e=t.content.find((e=>"computer_screenshot"===e.type));if(e)return e;const n=t.content.find((e=>"image_url"===e.type));if(n)return{type:"computer_screenshot",image_url:"string"==typeof n.image_url?n.image_url:n.image_url.url}}throw new Error("Invalid computer call output")})();return{type:"computer_call_output",output:e,call_id:t.tool_call_id}}return{type:"function_call_output",call_id:t.tool_call_id,id:t.id,output:"string"!=typeof t.content?JSON.stringify(t.content):t.content}}if("assistant"===n){const t=[];null!=e.additional_kwargs.reasoning&&"object"==typeof(r=e.additional_kwargs.reasoning)&&null!=r&&"type"in r&&"reasoning"===r.type&&t.push(e.additional_kwargs.reasoning);let{content:n}=e;null!=e.additional_kwargs.refusal&&("string"==typeof n&&(n=[{type:"output_text",text:n,annotations:[]}]),n=[...n,{type:"refusal",refusal:e.additional_kwargs.refusal}]),t.push({type:"message",role:"assistant",content:"string"==typeof n?n:n.flatMap((e=>"text"===e.type?{type:"output_text",text:e.text,annotations:e.annotations??[]}:"output_text"===e.type||"refusal"===e.type?e:[]))});const a=e.additional_kwargs[Gh];_a(e)&&e.tool_calls?.length?t.push(...e.tool_calls.map((e=>({type:"function_call",name:e.name,arguments:JSON.stringify(e.args),call_id:e.id,id:a?.[e.id]})))):null!=e.additional_kwargs.tool_calls&&t.push(...e.additional_kwargs.tool_calls.map((e=>({type:"function_call",name:e.function.name,call_id:e.id,id:a?.[e.id],arguments:e.function.arguments}))));const s=e.response_metadata.output?.length?e.response_metadata.output:e.additional_kwargs.tool_outputs;if(null!=s){const e=s,n=e?.filter((e=>"reasoning"===e.type)),r=e?.filter((e=>"computer_call"===e.type));n.length>0&&r.length>0&&t.push(...n),r.length>0&&t.push(...r)}return t}var r;const a="string"==typeof e.content?e.content:e.content.flatMap((e=>ra(e)?ca(e,Hh):"text"===e.type?{type:"input_text",text:e.text}:"image_url"===e.type?{type:"input_image",image_url:"string"==typeof e.image_url?e.image_url:e.image_url.url,detail:"string"==typeof e.image_url?"auto":e.image_url.detail}:"input_text"===e.type||"input_image"===e.type||"input_file"===e.type?e:[]));return"user"===n||"system"===n||"developer"===n?{type:"message",role:n,content:a}:(console.warn(`Unsupported role found when converting to OpenAI Responses API: ${n}`),[])}))}function Vh(e){if(e.error){const t=new Error(e.error.message);throw t.name=e.error.code,t}const t=[],n=[],r=[],a={model:e.model,created_at:e.created_at,id:e.id,incomplete_details:e.incomplete_details,metadata:e.metadata,object:e.object,status:e.status,user:e.user,model_name:e.model},s={};for(const a of e.output)if("message"===a.type)t.push(...a.content.flatMap((e=>"output_text"===e.type?("parsed"in e&&null!=e.parsed&&(s.parsed=e.parsed),{type:"text",text:e.text,annotations:e.annotations}):"refusal"===e.type?(s.refusal=e.refusal,[]):e)));else if("function_call"===a.type){const e={function:{name:a.name,arguments:a.arguments},id:a.call_id};try{n.push(th(e,{returnId:!0}))}catch(t){let n;"object"==typeof t&&null!=t&&"message"in t&&"string"==typeof t.message&&(n=t.message),r.push(rh(e,n))}s[Gh]??={},a.id&&(s[Gh][a.call_id]=a.id)}else"reasoning"===a.type?s.reasoning=a:(s.tool_outputs??=[],s.tool_outputs.push(a));return new ba({id:e.id,content:t,tool_calls:n,invalid_tool_calls:r,usage_metadata:e.usage,additional_kwargs:s,response_metadata:a})}function Kh(e){const t=[];let n,r={};const a=[],s={},i={};let o;if("response.output_text.delta"===e.type)t.push({type:"text",text:e.delta,index:e.content_index});else if("response.output_text.annotation.added"===e.type)t.push({type:"text",text:"",annotations:[e.annotation],index:e.content_index});else if("response.output_item.added"===e.type&&"message"===e.item.type)o=e.item.id;else if("response.output_item.added"===e.type&&"function_call"===e.item.type)a.push({type:"tool_call_chunk",name:e.item.name,args:e.item.arguments,id:e.item.id,index:e.output_index}),i[Gh]={[e.item.call_id]:e.item.id};else if("response.output_item.done"!==e.type||"web_search_call"!==e.item.type&&"file_search_call"!==e.item.type&&"computer_call"!==e.item.type)if("response.created"===e.type)s.id=e.response.id,s.model_name=e.response.model,s.model=e.response.model;else if("response.completed"===e.type){const t=Vh(e.response);n=e.response.usage,"json_schema"===e.response.text?.format?.type&&(i.parsed??=JSON.parse(t.text));for(const[t,n]of Object.entries(e.response))"id"!==t&&(s[t]=n)}else if("response.function_call_arguments.delta"===e.type)a.push({type:"tool_call_chunk",args:e.delta,index:e.output_index});else if("response.web_search_call.completed"===e.type||"response.file_search_call.completed"===e.type)r={tool_outputs:{id:e.item_id,type:e.type.replace("response.","").replace(".completed",""),status:"completed"}};else{if("response.refusal.done"!==e.type)return null;i.refusal=e.refusal}else i.tool_outputs=[e.item];return new Ul({text:t.map((e=>e.text)).join(""),message:new wa({id:o,content:t,tool_call_chunks:a,usage_metadata:n,additional_kwargs:i,response_metadata:s}),generationInfo:r})}function Xh(e){return"type"in e&&"function"!==e.type}function Qh(e,t){return wd(e)?void 0!==t?.strict?{...e,function:{...e.function,strict:t.strict}}:e:function(e,t){let n;return n=Mh(e)?function(e){let t;return t=Mh(e)?{type:"function",function:Uh(e)}:e,t}(e):e,void 0!==t?.strict&&(n.function.strict=t.strict),n}(e,t)}function Yh(e){return e?.startsWith("o1")||e?.startsWith("o3")||e?.startsWith("o4")}class ep extends $d{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming"]}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??Mc("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??Mc("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.useResponsesApi=e?.useResponsesApi??this.useResponsesApi,this.disableStreaming=e?.disableStreaming??this.disableStreaming,"o1"===this.model&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=e?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},void 0!==e?.supportsStrictToolCalling&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return void 0!==t?.strict?n=t.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling),this.bind({tools:e.map((e=>Xh(e)?e:Qh(e,{strict:n}))),...t})}createResponseFormat(e){return e&&"json_schema"===e.type&&e.json_schema.schema&&tp(e.json_schema.schema)?Lh(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let n;if(void 0!==e?.strict?n=e.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling),this._useResponseApi(e)){const t={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?e.tools.map((e=>Xh(e)?e:wd(e)?{type:"function",name:e.function.name,parameters:e.function.parameters,description:e.function.description,strict:n}:null)).filter((e=>null!==e)):void 0,tool_choice:(r=e?.tool_choice,null!=r&&"object"==typeof r&&"type"in r&&"function"!==r.type?e?.tool_choice:(()=>{const t=Bh(e?.tool_choice);return"object"==typeof t&&"type"in t?{type:"function",name:t.function.name}:void 0})()),text:(()=>{if(e?.text)return e.text;const t=this.createResponseFormat(e?.response_format);return"json_schema"===t?.type?null!=t.json_schema.schema?{format:{type:"json_schema",schema:t.json_schema.schema,description:t.json_schema.description,name:t.json_schema.name,strict:t.json_schema.strict}}:void 0:{format:t}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:-1===this.maxTokens?void 0:this.maxTokens,...this.modelKwargs},a=e?.reasoning_effort??this.reasoningEffort;return void 0!==a&&(t.reasoning={effort:a}),t}var r;let a={};void 0!==e?.stream_options?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(a={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map((e=>Qh(e,{strict:n}))):void 0,tool_choice:Bh(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...a,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};void 0!==e?.prediction&&(s.prediction=e.prediction);const i=e?.reasoning_effort??this.reasoningEffort;return void 0!==i&&(s.reasoning_effort=i),Yh(s.model)?s.max_completion_tokens=-1===this.maxTokens?void 0:this.maxTokens:s.max_tokens=-1===this.maxTokens?void 0:this.maxTokens,s}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const n=e.tool_calls;if("assistant"===e.role){const r=[],a=[];for(const e of n??[])try{r.push(th(e,{returnId:!0}))}catch(t){a.push(rh(e,t.message))}const s={function_call:e.function_call,tool_calls:n};void 0!==this.__includeRawResponse&&(s.__raw_response=t);const i={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(s.audio=e.audio),new ba({content:e.content||"",tool_calls:r,invalid_tool_calls:a,additional_kwargs:s,response_metadata:i,id:t.id})}return new ka(e.content||"",e.role??"unknown")}_convertOpenAIDeltaToBaseMessageChunk(e,t,n){const r=e.role??n,a=e.content??"";let s;s=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},this.__includeRawResponse&&(s.__raw_response=t),e.audio&&(s.audio={...e.audio,index:t.choices[0].index});const i={usage:{...t.usage}};if("user"===r)return new Sa({content:a,response_metadata:i});if("assistant"===r){const n=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)n.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new wa({content:a,tool_call_chunks:n,additional_kwargs:s,id:t.id,response_metadata:i})}return"system"===r?new Ia({content:a,response_metadata:i}):"developer"===r?new Ia({content:a,response_metadata:i,additional_kwargs:{__openai_role__:"developer"}}):"function"===r?new Ea({content:a,additional_kwargs:s,name:e.name,response_metadata:i}):"tool"===r?new ya({content:a,additional_kwargs:s,tool_call_id:e.tool_call_id,response_metadata:i}):new xa({content:a,role:r,response_metadata:i})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){if(this._useResponseApi(t)){const n=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:Jh(e,this.model),stream:!0},t);for await(const e of n){const t=Kh(e);null!=t&&(yield t)}return}const r=Wh(e,this.model),a={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0};let s;const i=await this.completionWithRetry(a,t);let o;for await(const e of i){const r=e?.choices?.[0];if(e.usage&&(o=e.usage),!r)continue;const{delta:a}=r;if(!a)continue;const i=this._convertOpenAIDeltaToBaseMessageChunk(a,e,s);s=a.role??s;const c={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof i.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const l={...c};null!=r.finish_reason&&(l.finish_reason=r.finish_reason,l.system_fingerprint=e.system_fingerprint,l.model_name=e.model),this.logprobs&&(l.logprobs=r.logprobs);const u=new Ul({message:i,text:i.content,generationInfo:l});yield u,await(n?.handleLLMNewToken(u.text??"",c,void 0,void 0,void 0,{chunk:u}))}if(o){const e={...null!==o.prompt_tokens_details?.audio_tokens&&{audio:o.prompt_tokens_details?.audio_tokens},...null!==o.prompt_tokens_details?.cached_tokens&&{cache_read:o.prompt_tokens_details?.cached_tokens}},t={...null!==o.completion_tokens_details?.audio_tokens&&{audio:o.completion_tokens_details?.audio_tokens},...null!==o.completion_tokens_details?.reasoning_tokens&&{reasoning:o.completion_tokens_details?.reasoning_tokens}},n=new Ul({message:new wa({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield n}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,n){const r=this.invocationParams(t);if(r.stream){const r=this._streamResponseChunks(e,t,n);let a;for await(const e of r)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},a=a?.concat(e)??e;return{generations:a?[a]:[],llmOutput:{estimatedTokenUsage:a?.message?.usage_metadata}}}const a=Jh(e,this.model),s=await this.responseApiWithRetry({input:a,...r},{signal:t?.signal,...t?.options});return{generations:[{text:s.output_text,message:Vh(s)}],llmOutput:{id:s.id,estimatedTokenUsage:s.usage?{promptTokens:s.usage.input_tokens,completionTokens:s.usage.output_tokens,totalTokens:s.usage.total_tokens}:void 0}}}_useResponseApi(e){const t=e?.tools?.some(Xh),n=null!=e?.previous_response_id||null!=e?.text||null!=e?.truncation||null!=e?.include;return this.useResponsesApi||t||n}async _generate(e,t,n){if(this._useResponseApi(t))return this._responseApiGenerate(e,t,n);const r={},a=this.invocationParams(t),s=Wh(e,this.model);if(a.stream){const a=this._streamResponseChunks(e,t,n),s={};for await(const e of a){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}const i=Object.entries(s).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:c}=this.invocationParams(t),l=await this.getEstimatedTokenCountFromPrompt(e,o,c),u=await this.getNumTokensFromGenerations(i);return r.input_tokens=l,r.output_tokens=u,r.total_tokens=l+u,{generations:i,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options});const{completion_tokens:n,prompt_tokens:i,total_tokens:o,prompt_tokens_details:c,completion_tokens_details:l}=e?.usage??{};n&&(r.output_tokens=(r.output_tokens??0)+n),i&&(r.input_tokens=(r.input_tokens??0)+i),o&&(r.total_tokens=(r.total_tokens??0)+o),null===c?.audio_tokens&&null===c?.cached_tokens||(r.input_token_details={...null!==c?.audio_tokens&&{audio:c?.audio_tokens},...null!==c?.cached_tokens&&{cache_read:c?.cached_tokens}}),null===l?.audio_tokens&&null===l?.reasoning_tokens||(r.output_token_details={...null!==l?.audio_tokens&&{audio:l?.audio_tokens},...null!==l?.reasoning_tokens&&{reasoning:l?.reasoning_tokens}});const u=[];for(const t of e?.choices??[]){const n={text:t.message?.content??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(t.message??{role:"assistant"},e)};n.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},_a(n.message)&&(n.message.usage_metadata=r),n.message=new ba(Object.fromEntries(Object.entries(n.message).filter((([e])=>!e.startsWith("lc_"))))),u.push(n)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(zh(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const a=await Promise.all(e.map((async e=>{const a=await this.getNumTokens(e.content),s=await this.getNumTokens(qh(e)),i=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=a+n+s+i;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(c.additional_kwargs.function_call)),o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw Fh(e)}}))}async responseApiWithRetry(e,t){return this.caller.call((async()=>{const n=this._getClientOptions(t);try{return"json_schema"!==e.text?.format?.type||e.stream?await this.client.responses.create(e,n):await this.client.responses.parse(e,n)}catch(e){throw Fh(e)}}))}async betaParsedCompletionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.beta.chat.completions.parse(e,n)}catch(e){throw Fh(e)}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=e;if((r||i)&&a&&t)return`${a}/${t}`;if((r||i)&&o&&t)return`${o}/openai/deployments/${t}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return s}({baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new Hr(t)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,a,s;var i;let o,c;if(void 0!==(i=e)&&"object"==typeof i.schema?(n=e.schema,r=e.name,a=e.method,s=e.includeRaw):(n=e,r=t?.name,a=t?.method,s=t?.includeRaw),void 0!==t?.strict&&"jsonMode"===a)throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(this.model.startsWith("gpt-3")||this.model.startsWith("gpt-4-")||"gpt-4"===this.model?"jsonSchema"===a&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`):void 0===a&&(a="jsonSchema"),"jsonMode"===a)o=this.bind({response_format:{type:"json_object"}}),c=tp(n)?Yd.fromZodSchema(n):new eh;else if("jsonSchema"===a)if(o=this.bind({response_format:{type:"json_schema",json_schema:{name:r??"extract",description:n.description,schema:n,strict:t?.strict}}}),tp(n)){const e=Yd.fromZodSchema(n);c=Gu.from((t=>"parsed"in t.additional_kwargs?t.additional_kwargs.parsed:e))}else c=new eh;else{let e=r??"extract";if(tp(n)){const r=$u(n);o=this.bind({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},...void 0!==t?.strict?{strict:t.strict}:{}}),c=new sh({returnSingle:!0,keyName:e,zodSchema:n})}else{let r;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(r=n,e=n.name):(e=n.title??e,r={name:e,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},...void 0!==t?.strict?{strict:t.strict}:{}}),c=new sh({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(c);const l=Ed.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),u=Ed.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return qu.from([{raw:o},d])}}function tp(e){return"function"==typeof e?.parse}class np extends kd{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let n,r,a=kl(t);return Aa(e)?(n=e.id,r=e.args,a={...a,toolCall:e,configurable:{...a.configurable,tool_call_id:n}}):r=e,this.call(r,a)}async call(e,t,n){let r=e;if(Od(this.schema))try{r=await this.schema.parseAsync(e)}catch(t){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.message}`),new Ta(n,JSON.stringify(e))}else{const t=Kd(e,this.schema);if(!t.valid){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.errors.map((e=>`${e.keywordLocation}: ${e.error}`)).join("\n")}`),new Ta(n,JSON.stringify(e))}}const a=function(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}(t),s=fl.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),i=await(s?.handleToolStart(this.toJSON(),"string"==typeof r?r:JSON.stringify(r),a.runId,void 0,void 0,void 0,a.runName));let o,c,l,u;delete a.runId;try{o=await this._call(r,i,a)}catch(e){throw await(i?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(o)||2!==o.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(o)}`);[c,l]=o}else c=o;a&&"configurable"in a&&(u=a.configurable.tool_call_id);const d=function(e){const{content:t,artifact:n,toolCallId:r}=e;return r&&(null==(a=t)||"object"!=typeof a||!("lc_direct_tool_output"in a)||!0!==a.lc_direct_tool_output)?"string"==typeof t||Array.isArray(t)&&t.every((e=>"object"==typeof e))?new ga({content:t,artifact:n,tool_call_id:r,name:e.name}):new ga({content:ap(t),artifact:n,tool_call_id:r,name:e.name}):t;var a}({content:c,artifact:l,toolCallId:u,name:this.name});return await(i?.handleToolEnd(d)),d}}class rp extends np{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:so.object({input:so.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}function ap(e){try{return JSON.stringify(e,null,2)}catch(t){return`${e}`}}function sp(e){return sp="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},sp(e)}function ip(){ip=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},i=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof y?t:y,i=Object.create(s.prototype),o=new A(r||[]);return a(i,"_invoke",{value:S(e,n,o)}),i}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function y(){}function b(){}function _(){}var v={};l(v,i,(function(){return this}));var w=Object.getPrototypeOf,k=w&&w(w(T([])));k&&k!==n&&r.call(k,i)&&(v=k);var x=_.prototype=y.prototype=Object.create(v);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function n(a,s,i,o){var c=d(e[a],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==sp(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,i,o)}),(function(e){n("throw",e,i,o)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,o)}))}o(c.arg)}var s;a(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return s=s?s.then(a,a):a()}})}function S(t,n,r){var a=h;return function(s,i){if(a===f)throw Error("Generator is already running");if(a===m){if("throw"===s)throw i;return{value:e,done:!0}}for(r.method=s,r.arg=i;;){var o=r.delegate;if(o){var c=$(o,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===h)throw a=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=f;var l=d(t,n,r);if("normal"===l.type){if(a=r.done?m:p,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(a=m,r.method="throw",r.arg=l.arg)}}}function $(t,n){var r=n.method,a=t.iterator[r];if(a===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,$(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var s=d(a,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,g;var i=s.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,s=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(sp(t)+" is not iterable")}return b.prototype=_,a(x,"constructor",{value:_,configurable:!0}),a(_,"constructor",{value:b,configurable:!0}),b.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(x),e},t.awrap=function(e){return{__await:e}},E(O.prototype),l(O.prototype,o,(function(){return this})),t.AsyncIterator=O,t.async=function(e,n,r,a,s){void 0===s&&(s=Promise);var i=new O(u(e,n,r,a),s);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(x),l(x,c,"Generator"),l(x,i,(function(){return this})),l(x,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=T,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return o.type="throw",o.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s],o=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),l=r.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var s=a;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var i=s?s.completion:{};return i.type=e,i.arg=t,s?(this.method="next",this.next=s.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;P(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function op(e,t,n,r,a,s,i){try{var o=e[s](i),c=o.value}catch(e){return void n(e)}o.done?t(c):Promise.resolve(c).then(r,a)}function cp(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var s=e.apply(t,n);function i(e){op(s,r,a,i,o,"next",e)}function o(e){op(s,r,a,i,o,"throw",e)}i(void 0)}))}}function lp(e,t){return up.apply(this,arguments)}function up(){return up=cp(ip().mark((function e(t,n){var r,a;return ip().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat(t,"/models"),{headers:{Authorization:"Bearer ".concat(n),"HTTP-Referer":"https://localhost:3000","X-Title":"WordLLM"}});case 3:if((r=e.sent).ok){e.next=6;break}throw new Error("Failed to fetch models: ".concat(r.status," ").concat(r.statusText));case 6:return e.next=8,r.json();case 8:return a=e.sent,e.abrupt("return",a.data.map((function(e){return e.id})));case 12:throw e.prev=12,e.t0=e.catch(0),console.error("Error fetching models:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,null,[[0,12]])}))),up.apply(this,arguments)}function dp(e,t,n,r){var a={"HTTP-Referer":"https://localhost:3000","X-Title":r?"WordLLM/".concat(r):"WordLLM"};return new ep({openAIApiKey:t,configuration:{baseURL:e,defaultHeaders:a},modelName:n||"qwen/qwen-2.5-7b-instruct:free",temperature:.7})}function hp(e,t){return pp.apply(this,arguments)}function pp(){return pp=cp(ip().mark((function e(t,n){var r,a,s,i;return ip().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.invoke(t);case 3:return r=e.sent,e.abrupt("return",r.content);case 7:if(e.prev=7,e.t0=e.catch(0),console.error("Error getting LLM response:",e.t0),a="Sorry, there was an error processing your request.",!e.t0.response){e.next=24;break}return e.prev=12,e.next=15,e.t0.response.json();case 15:i=e.sent,a="API Error: ".concat((null===(s=i.error)||void 0===s?void 0:s.message)||JSON.stringify(i)),e.next=22;break;case 19:e.prev=19,e.t1=e.catch(12),a="API Error: ".concat(e.t0.response.status," ").concat(e.t0.response.statusText);case 22:e.next=25;break;case 24:e.t0.message&&(a="Error: ".concat(e.t0.message));case 25:return e.abrupt("return",a);case 26:case"end":return e.stop()}}),e,null,[[0,7],[12,19]])}))),pp.apply(this,arguments)}Object.defineProperty(class extends rp{static lc_name(){return"DallEAPIWrapper"}constructor(e){void 0!==e?.responseFormat&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??Mc("OPENAI_API_KEY"),organization:e?.organization??Mc("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseURL:e?.baseUrl};this.client=new Hr(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap((e=>e.data.flatMap((e=>e.url?{type:"image_url",image_url:e.url}:[])).filter((e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)))):e.flatMap((e=>e.data.flatMap((e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[])).filter((e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url))))}async _call(e){const t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){const e=await Promise.all(Array.from({length:this.n}).map((()=>this.client.images.generate(t))));return this.processMultipleGeneratedUrls(e)}const n=await this.client.images.generate(t);let r="";return"url"===this.dallEResponseFormat?[r]=n.data.map((e=>e.url)).filter((e=>"undefined"!==e)):[r]=n.data.map((e=>e.b64_json)).filter((e=>"undefined"!==e)),r}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});let fp={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};function mp(e){fp=e}const gp={exec:()=>null};function yp(e,t=""){let n="string"==typeof e?e:e.source;const r={replace:(e,t)=>{let a="string"==typeof t?t:t.source;return a=a.replace(bp.caret,"$1"),n=n.replace(e,a),r},getRegex:()=>new RegExp(n,t)};return r}const bp={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:e=>new RegExp(`^( {0,3}${e})((?:[\t ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ \t][^\\n]*)?(?:\\n|$))`),hrRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}#`),htmlBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}<(?:[a-z].*>|!--)`,"i")},_p=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,vp=/(?:[*+-]|\d{1,9}[.)])/,wp=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,kp=yp(wp).replace(/bull/g,vp).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),xp=yp(wp).replace(/bull/g,vp).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Ep=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Op=/(?!\s*\])(?:\\.|[^\[\]\\])+/,Sp=yp(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Op).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),$p=yp(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,vp).getRegex(),Ip="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Pp=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Ap=yp("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$))","i").replace("comment",Pp).replace("tag",Ip).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Tp=yp(Ep).replace("hr",_p).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Ip).getRegex(),Rp={blockquote:yp(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Tp).getRegex(),code:/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,def:Sp,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:_p,html:Ap,lheading:kp,list:$p,newline:/^(?:[ \t]*(?:\n|$))+/,paragraph:Tp,table:gp,text:/^[^\n]+/},jp=yp("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",_p).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}\t)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Ip).getRegex(),Np={...Rp,lheading:xp,table:jp,paragraph:yp(Ep).replace("hr",_p).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",jp).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Ip).getRegex()},Cp={...Rp,html:yp("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",Pp).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:gp,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:yp(Ep).replace("hr",_p).replace("heading"," *#{1,6} *[^\n]").replace("lheading",kp).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},Lp=/^( {2,}|\\)\n(?!\s*$)/,Mp=/[\p{P}\p{S}]/u,Up=/[\s\p{P}\p{S}]/u,Dp=/[^\s\p{P}\p{S}]/u,Fp=yp(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Up).getRegex(),Bp=/(?!~)[\p{P}\p{S}]/u,zp=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,Zp=yp(zp,"u").replace(/punct/g,Mp).getRegex(),qp=yp(zp,"u").replace(/punct/g,Bp).getRegex(),Hp="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",Wp=yp(Hp,"gu").replace(/notPunctSpace/g,Dp).replace(/punctSpace/g,Up).replace(/punct/g,Mp).getRegex(),Gp=yp(Hp,"gu").replace(/notPunctSpace/g,/(?:[^\s\p{P}\p{S}]|~)/u).replace(/punctSpace/g,/(?!~)[\s\p{P}\p{S}]/u).replace(/punct/g,Bp).getRegex(),Jp=yp("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Dp).replace(/punctSpace/g,Up).replace(/punct/g,Mp).getRegex(),Vp=yp(/\\(punct)/,"gu").replace(/punct/g,Mp).getRegex(),Kp=yp(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Xp=yp(Pp).replace("(?:--\x3e|$)","--\x3e").getRegex(),Qp=yp("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Xp).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Yp=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,ef=yp(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Yp).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),tf=yp(/^!?\[(label)\]\[(ref)\]/).replace("label",Yp).replace("ref",Op).getRegex(),nf=yp(/^!?\[(ref)\](?:\[\])?/).replace("ref",Op).getRegex(),rf={_backpedal:gp,anyPunctuation:Vp,autolink:Kp,blockSkip:/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,br:Lp,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:gp,emStrongLDelim:Zp,emStrongRDelimAst:Wp,emStrongRDelimUnd:Jp,escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,link:ef,nolink:nf,punctuation:Fp,reflink:tf,reflinkSearch:yp("reflink|nolink(?!\\()","g").replace("reflink",tf).replace("nolink",nf).getRegex(),tag:Qp,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:gp},af={...rf,link:yp(/^!?\[(label)\]\((.*?)\)/).replace("label",Yp).getRegex(),reflink:yp(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Yp).getRegex()},sf={...rf,emStrongRDelimAst:Gp,emStrongLDelim:qp,url:yp(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},of={...sf,br:yp(Lp).replace("{2,}","*").getRegex(),text:yp(sf.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},cf={normal:Rp,gfm:Np,pedantic:Cp},lf={normal:rf,gfm:sf,breaks:of,pedantic:af},uf={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},df=e=>uf[e];function hf(e,t){if(t){if(bp.escapeTest.test(e))return e.replace(bp.escapeReplace,df)}else if(bp.escapeTestNoEncode.test(e))return e.replace(bp.escapeReplaceNoEncode,df);return e}function pf(e){try{e=encodeURI(e).replace(bp.percentDecode,"%")}catch{return null}return e}function ff(e,t){const n=e.replace(bp.findPipe,((e,t,n)=>{let r=!1,a=t;for(;--a>=0&&"\\"===n[a];)r=!r;return r?"|":" |"})),r=n.split(bp.splitPipe);let a=0;if(r[0].trim()||r.shift(),r.length>0&&!r.at(-1)?.trim()&&r.pop(),t)if(r.length>t)r.splice(t);else for(;r.length<t;)r.push("");for(;a<r.length;a++)r[a]=r[a].trim().replace(bp.slashPipe,"|");return r}function mf(e,t,n){const r=e.length;if(0===r)return"";let a=0;for(;a<r&&e.charAt(r-a-1)===t;)a++;return e.slice(0,r-a)}function gf(e,t,n,r,a){const s=t.href,i=t.title||null,o=e[1].replace(a.other.outputLinkReplace,"$1");r.state.inLink=!0;const c={type:"!"===e[0].charAt(0)?"image":"link",raw:n,href:s,title:i,text:o,tokens:r.inlineTokens(o)};return r.state.inLink=!1,c}class yf{options;rules;lexer;constructor(e){this.options=e||fp}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:mf(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],n=function(e,t,n){const r=e.match(n.other.indentCodeCompensation);if(null===r)return t;const a=r[1];return t.split("\n").map((e=>{const t=e.match(n.other.beginningSpace);if(null===t)return e;const[r]=t;return r.length>=a.length?e.slice(a.length):e})).join("\n")}(e,t[3]||"",this.rules);return{type:"code",raw:e,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(this.rules.other.endingHash.test(e)){const t=mf(e,"#");this.options.pedantic?e=t.trim():t&&!this.rules.other.endingSpaceChar.test(t)||(e=t.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:this.lexer.inline(e)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:mf(t[0],"\n")}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){let e=mf(t[0],"\n").split("\n"),n="",r="";const a=[];for(;e.length>0;){let t=!1;const s=[];let i;for(i=0;i<e.length;i++)if(this.rules.other.blockquoteStart.test(e[i]))s.push(e[i]),t=!0;else{if(t)break;s.push(e[i])}e=e.slice(i);const o=s.join("\n"),c=o.replace(this.rules.other.blockquoteSetextReplace,"\n    $1").replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}\n${o}`:o,r=r?`${r}\n${c}`:c;const l=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(c,a,!0),this.lexer.state.top=l,0===e.length)break;const u=a.at(-1);if("code"===u?.type)break;if("blockquote"===u?.type){const t=u,s=t.raw+"\n"+e.join("\n"),i=this.blockquote(s);a[a.length-1]=i,n=n.substring(0,n.length-t.raw.length)+i.raw,r=r.substring(0,r.length-t.text.length)+i.text;break}if("list"!==u?.type);else{const t=u,s=t.raw+"\n"+e.join("\n"),i=this.list(s);a[a.length-1]=i,n=n.substring(0,n.length-u.raw.length)+i.raw,r=r.substring(0,r.length-t.raw.length)+i.raw,e=s.substring(a.at(-1).raw.length).split("\n")}}return{type:"blockquote",raw:n,tokens:a,text:r}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim();const r=n.length>1,a={type:"list",raw:"",ordered:r,start:r?+n.slice(0,-1):"",loose:!1,items:[]};n=r?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=r?n:"[*+-]");const s=this.rules.other.listItemRegex(n);let i=!1;for(;e;){let n=!1,r="",o="";if(!(t=s.exec(e)))break;if(this.rules.block.hr.test(e))break;r=t[0],e=e.substring(r.length);let c=t[2].split("\n",1)[0].replace(this.rules.other.listReplaceTabs,(e=>" ".repeat(3*e.length))),l=e.split("\n",1)[0],u=!c.trim(),d=0;if(this.options.pedantic?(d=2,o=c.trimStart()):u?d=t[1].length+1:(d=t[2].search(this.rules.other.nonSpaceChar),d=d>4?1:d,o=c.slice(d),d+=t[1].length),u&&this.rules.other.blankLine.test(l)&&(r+=l+"\n",e=e.substring(l.length+1),n=!0),!n){const t=this.rules.other.nextBulletRegex(d),n=this.rules.other.hrRegex(d),a=this.rules.other.fencesBeginRegex(d),s=this.rules.other.headingBeginRegex(d),i=this.rules.other.htmlBeginRegex(d);for(;e;){const h=e.split("\n",1)[0];let p;if(l=h,this.options.pedantic?(l=l.replace(this.rules.other.listReplaceNesting,"  "),p=l):p=l.replace(this.rules.other.tabCharGlobal,"    "),a.test(l))break;if(s.test(l))break;if(i.test(l))break;if(t.test(l))break;if(n.test(l))break;if(p.search(this.rules.other.nonSpaceChar)>=d||!l.trim())o+="\n"+p.slice(d);else{if(u)break;if(c.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4)break;if(a.test(c))break;if(s.test(c))break;if(n.test(c))break;o+="\n"+l}u||l.trim()||(u=!0),r+=h+"\n",e=e.substring(h.length+1),c=p.slice(d)}}a.loose||(i?a.loose=!0:this.rules.other.doubleBlankLine.test(r)&&(i=!0));let h,p=null;this.options.gfm&&(p=this.rules.other.listIsTask.exec(o),p&&(h="[ ] "!==p[0],o=o.replace(this.rules.other.listReplaceTask,""))),a.items.push({type:"list_item",raw:r,task:!!p,checked:h,loose:!1,text:o,tokens:[]}),a.raw+=r}const o=a.items.at(-1);if(!o)return;o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd(),a.raw=a.raw.trimEnd();for(let e=0;e<a.items.length;e++)if(this.lexer.state.top=!1,a.items[e].tokens=this.lexer.blockTokens(a.items[e].text,[]),!a.loose){const t=a.items[e].tokens.filter((e=>"space"===e.type)),n=t.length>0&&t.some((e=>this.rules.other.anyLine.test(e.raw)));a.loose=n}if(a.loose)for(let e=0;e<a.items.length;e++)a.items[e].loose=!0;return a}}html(e){const t=this.rules.block.html.exec(e);if(t)return{type:"html",block:!0,raw:t[0],pre:"pre"===t[1]||"script"===t[1]||"style"===t[1],text:t[0]}}def(e){const t=this.rules.block.def.exec(e);if(t){const e=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",r=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:e,raw:t[0],href:n,title:r}}}table(e){const t=this.rules.block.table.exec(e);if(!t)return;if(!this.rules.other.tableDelimiter.test(t[2]))return;const n=ff(t[1]),r=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),a=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split("\n"):[],s={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===r.length){for(const e of r)this.rules.other.tableAlignRight.test(e)?s.align.push("right"):this.rules.other.tableAlignCenter.test(e)?s.align.push("center"):this.rules.other.tableAlignLeft.test(e)?s.align.push("left"):s.align.push(null);for(let e=0;e<n.length;e++)s.header.push({text:n[e],tokens:this.lexer.inline(n[e]),header:!0,align:s.align[e]});for(const e of a)s.rows.push(ff(e,s.header.length).map(((e,t)=>({text:e,tokens:this.lexer.inline(e),header:!1,align:s.align[t]}))));return s}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e="\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:e,tokens:this.lexer.inline(e)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(e)){if(!this.rules.other.endAngleBracket.test(e))return;const t=mf(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;let n=0;for(let r=0;r<e.length;r++)if("\\"===e[r])r++;else if(e[r]===t[0])n++;else if(e[r]===t[1]&&(n--,n<0))return r;return n>0?-2:-1}(t[2],"()");if(-2===e)return;if(e>-1){const n=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,n).trim(),t[3]=""}}let n=t[2],r="";if(this.options.pedantic){const e=this.rules.other.pedanticHrefTitle.exec(n);e&&(n=e[1],r=e[3])}else r=t[3]?t[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(n=this.options.pedantic&&!this.rules.other.endAngleBracket.test(e)?n.slice(1):n.slice(1,-1)),gf(t,{href:n?n.replace(this.rules.inline.anyPunctuation,"$1"):n,title:r?r.replace(this.rules.inline.anyPunctuation,"$1"):r},t[0],this.lexer,this.rules)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){const e=t[(n[2]||n[1]).replace(this.rules.other.multipleSpaceGlobal," ").toLowerCase()];if(!e){const e=n[0].charAt(0);return{type:"text",raw:e,text:e}}return gf(n,e,n[0],this.lexer,this.rules)}}emStrong(e,t,n=""){let r=this.rules.inline.emStrongLDelim.exec(e);if(r&&(!r[3]||!n.match(this.rules.other.unicodeAlphaNumeric))&&(!r[1]&&!r[2]||!n||this.rules.inline.punctuation.exec(n))){const n=[...r[0]].length-1;let a,s,i=n,o=0;const c="*"===r[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,t=t.slice(-1*e.length+n);null!=(r=c.exec(t));){if(a=r[1]||r[2]||r[3]||r[4]||r[5]||r[6],!a)continue;if(s=[...a].length,r[3]||r[4]){i+=s;continue}if((r[5]||r[6])&&n%3&&!((n+s)%3)){o+=s;continue}if(i-=s,i>0)continue;s=Math.min(s,s+i+o);const t=[...r[0]][0].length,c=e.slice(0,n+r.index+t+s);if(Math.min(n,s)%2){const e=c.slice(1,-1);return{type:"em",raw:c,text:e,tokens:this.lexer.inlineTokens(e)}}const l=c.slice(2,-2);return{type:"strong",raw:c,text:l,tokens:this.lexer.inlineTokens(l)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(this.rules.other.newLineCharGlobal," ");const n=this.rules.other.nonSpaceChar.test(e),r=this.rules.other.startingSpaceChar.test(e)&&this.rules.other.endingSpaceChar.test(e);return n&&r&&(e=e.substring(1,e.length-1)),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){const t=this.rules.inline.autolink.exec(e);if(t){let e,n;return"@"===t[2]?(e=t[1],n="mailto:"+e):(e=t[1],n=e),{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let e,n;if("@"===t[2])e=t[0],n="mailto:"+e;else{let r;do{r=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??""}while(r!==t[0]);e=t[0],n="www."===t[1]?"http://"+t[0]:t[0]}return{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e){const t=this.rules.inline.text.exec(e);if(t){const e=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:e}}}}class bf{tokens;options;state;tokenizer;inlineQueue;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||fp,this.options.tokenizer=this.options.tokenizer||new yf,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={other:bp,block:cf.normal,inline:lf.normal};this.options.pedantic?(t.block=cf.pedantic,t.inline=lf.pedantic):this.options.gfm&&(t.block=cf.gfm,this.options.breaks?t.inline=lf.breaks:t.inline=lf.gfm),this.tokenizer.rules=t}static get rules(){return{block:cf,inline:lf}}static lex(e,t){return new bf(t).lex(e)}static lexInline(e,t){return new bf(t).inlineTokens(e)}lex(e){e=e.replace(bp.carriageReturn,"\n"),this.blockTokens(e,this.tokens);for(let e=0;e<this.inlineQueue.length;e++){const t=this.inlineQueue[e];this.inlineTokens(t.src,t.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){for(this.options.pedantic&&(e=e.replace(bp.tabCharGlobal,"    ").replace(bp.spaceLine,""));e;){let r;if(this.options.extensions?.block?.some((n=>!!(r=n.call({lexer:this},e,t))&&(e=e.substring(r.raw.length),t.push(r),!0))))continue;if(r=this.tokenizer.space(e)){e=e.substring(r.raw.length);const n=t.at(-1);1===r.raw.length&&void 0!==n?n.raw+="\n":t.push(r);continue}if(r=this.tokenizer.code(e)){e=e.substring(r.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.text,this.inlineQueue.at(-1).src=n.text):t.push(r);continue}if(r=this.tokenizer.fences(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.heading(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.hr(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.blockquote(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.list(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.html(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.def(e)){e=e.substring(r.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.raw,this.inlineQueue.at(-1).src=n.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title});continue}if(r=this.tokenizer.table(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.lheading(e)){e=e.substring(r.raw.length),t.push(r);continue}let a=e;if(this.options.extensions?.startBlock){let t=1/0;const n=e.slice(1);let r;this.options.extensions.startBlock.forEach((e=>{r=e.call({lexer:this},n),"number"==typeof r&&r>=0&&(t=Math.min(t,r))})),t<1/0&&t>=0&&(a=e.substring(0,t+1))}if(this.state.top&&(r=this.tokenizer.paragraph(a))){const s=t.at(-1);n&&"paragraph"===s?.type?(s.raw+="\n"+r.raw,s.text+="\n"+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=s.text):t.push(r),n=a.length!==e.length,e=e.substring(r.raw.length)}else if(r=this.tokenizer.text(e)){e=e.substring(r.raw.length);const n=t.at(-1);"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=n.text):t.push(r)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n=e,r=null;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(r=this.tokenizer.rules.inline.reflinkSearch.exec(n));)e.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(r=this.tokenizer.rules.inline.anyPunctuation.exec(n));)n=n.slice(0,r.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;null!=(r=this.tokenizer.rules.inline.blockSkip.exec(n));)n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let a=!1,s="";for(;e;){let r;if(a||(s=""),a=!1,this.options.extensions?.inline?.some((n=>!!(r=n.call({lexer:this},e,t))&&(e=e.substring(r.raw.length),t.push(r),!0))))continue;if(r=this.tokenizer.escape(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.tag(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.link(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(r.raw.length);const n=t.at(-1);"text"===r.type&&"text"===n?.type?(n.raw+=r.raw,n.text+=r.text):t.push(r);continue}if(r=this.tokenizer.emStrong(e,n,s)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.codespan(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.br(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.del(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.autolink(e)){e=e.substring(r.raw.length),t.push(r);continue}if(!this.state.inLink&&(r=this.tokenizer.url(e))){e=e.substring(r.raw.length),t.push(r);continue}let i=e;if(this.options.extensions?.startInline){let t=1/0;const n=e.slice(1);let r;this.options.extensions.startInline.forEach((e=>{r=e.call({lexer:this},n),"number"==typeof r&&r>=0&&(t=Math.min(t,r))})),t<1/0&&t>=0&&(i=e.substring(0,t+1))}if(r=this.tokenizer.inlineText(i)){e=e.substring(r.raw.length),"_"!==r.raw.slice(-1)&&(s=r.raw.slice(-1)),a=!0;const n=t.at(-1);"text"===n?.type?(n.raw+=r.raw,n.text+=r.text):t.push(r)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return t}}class _f{options;parser;constructor(e){this.options=e||fp}space(e){return""}code({text:e,lang:t,escaped:n}){const r=(t||"").match(bp.notSpaceStart)?.[0],a=e.replace(bp.endingNewline,"")+"\n";return r?'<pre><code class="language-'+hf(r)+'">'+(n?a:hf(a,!0))+"</code></pre>\n":"<pre><code>"+(n?a:hf(a,!0))+"</code></pre>\n"}blockquote({tokens:e}){return`<blockquote>\n${this.parser.parse(e)}</blockquote>\n`}html({text:e}){return e}heading({tokens:e,depth:t}){return`<h${t}>${this.parser.parseInline(e)}</h${t}>\n`}hr(e){return"<hr>\n"}list(e){const t=e.ordered,n=e.start;let r="";for(let t=0;t<e.items.length;t++){const n=e.items[t];r+=this.listitem(n)}const a=t?"ol":"ul";return"<"+a+(t&&1!==n?' start="'+n+'"':"")+">\n"+r+"</"+a+">\n"}listitem(e){let t="";if(e.task){const n=this.checkbox({checked:!!e.checked});e.loose?"paragraph"===e.tokens[0]?.type?(e.tokens[0].text=n+" "+e.tokens[0].text,e.tokens[0].tokens&&e.tokens[0].tokens.length>0&&"text"===e.tokens[0].tokens[0].type&&(e.tokens[0].tokens[0].text=n+" "+hf(e.tokens[0].tokens[0].text),e.tokens[0].tokens[0].escaped=!0)):e.tokens.unshift({type:"text",raw:n+" ",text:n+" ",escaped:!0}):t+=n+" "}return t+=this.parser.parse(e.tokens,!!e.loose),`<li>${t}</li>\n`}checkbox({checked:e}){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>\n`}table(e){let t="",n="";for(let t=0;t<e.header.length;t++)n+=this.tablecell(e.header[t]);t+=this.tablerow({text:n});let r="";for(let t=0;t<e.rows.length;t++){const a=e.rows[t];n="";for(let e=0;e<a.length;e++)n+=this.tablecell(a[e]);r+=this.tablerow({text:n})}return r&&(r=`<tbody>${r}</tbody>`),"<table>\n<thead>\n"+t+"</thead>\n"+r+"</table>\n"}tablerow({text:e}){return`<tr>\n${e}</tr>\n`}tablecell(e){const t=this.parser.parseInline(e.tokens),n=e.header?"th":"td";return(e.align?`<${n} align="${e.align}">`:`<${n}>`)+t+`</${n}>\n`}strong({tokens:e}){return`<strong>${this.parser.parseInline(e)}</strong>`}em({tokens:e}){return`<em>${this.parser.parseInline(e)}</em>`}codespan({text:e}){return`<code>${hf(e,!0)}</code>`}br(e){return"<br>"}del({tokens:e}){return`<del>${this.parser.parseInline(e)}</del>`}link({href:e,title:t,tokens:n}){const r=this.parser.parseInline(n),a=pf(e);if(null===a)return r;let s='<a href="'+(e=a)+'"';return t&&(s+=' title="'+hf(t)+'"'),s+=">"+r+"</a>",s}image({href:e,title:t,text:n,tokens:r}){r&&(n=this.parser.parseInline(r,this.parser.textRenderer));const a=pf(e);if(null===a)return hf(n);let s=`<img src="${e=a}" alt="${n}"`;return t&&(s+=` title="${hf(t)}"`),s+=">",s}text(e){return"tokens"in e&&e.tokens?this.parser.parseInline(e.tokens):"escaped"in e&&e.escaped?e.text:hf(e.text)}}class vf{strong({text:e}){return e}em({text:e}){return e}codespan({text:e}){return e}del({text:e}){return e}html({text:e}){return e}text({text:e}){return e}link({text:e}){return""+e}image({text:e}){return""+e}br(){return""}}class wf{options;renderer;textRenderer;constructor(e){this.options=e||fp,this.options.renderer=this.options.renderer||new _f,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new vf}static parse(e,t){return new wf(t).parse(e)}static parseInline(e,t){return new wf(t).parseInline(e)}parse(e,t=!0){let n="";for(let r=0;r<e.length;r++){const a=e[r];if(this.options.extensions?.renderers?.[a.type]){const e=a,t=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==t||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){n+=t||"";continue}}const s=a;switch(s.type){case"space":n+=this.renderer.space(s);continue;case"hr":n+=this.renderer.hr(s);continue;case"heading":n+=this.renderer.heading(s);continue;case"code":n+=this.renderer.code(s);continue;case"table":n+=this.renderer.table(s);continue;case"blockquote":n+=this.renderer.blockquote(s);continue;case"list":n+=this.renderer.list(s);continue;case"html":n+=this.renderer.html(s);continue;case"paragraph":n+=this.renderer.paragraph(s);continue;case"text":{let a=s,i=this.renderer.text(a);for(;r+1<e.length&&"text"===e[r+1].type;)a=e[++r],i+="\n"+this.renderer.text(a);n+=t?this.renderer.paragraph({type:"paragraph",raw:i,text:i,tokens:[{type:"text",raw:i,text:i,escaped:!0}]}):i;continue}default:{const e='Token with "'+s.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}parseInline(e,t=this.renderer){let n="";for(let r=0;r<e.length;r++){const a=e[r];if(this.options.extensions?.renderers?.[a.type]){const e=this.options.extensions.renderers[a.type].call({parser:this},a);if(!1!==e||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(a.type)){n+=e||"";continue}}const s=a;switch(s.type){case"escape":case"text":n+=t.text(s);break;case"html":n+=t.html(s);break;case"link":n+=t.link(s);break;case"image":n+=t.image(s);break;case"strong":n+=t.strong(s);break;case"em":n+=t.em(s);break;case"codespan":n+=t.codespan(s);break;case"br":n+=t.br(s);break;case"del":n+=t.del(s);break;default:{const e='Token with "'+s.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}}class kf{options;block;constructor(e){this.options=e||fp}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}provideLexer(){return this.block?bf.lex:bf.lexInline}provideParser(){return this.block?wf.parse:wf.parseInline}}const xf=new class{defaults={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=wf;Renderer=_f;TextRenderer=vf;Lexer=bf;Tokenizer=yf;Hooks=kf;constructor(...e){this.use(...e)}walkTokens(e,t){let n=[];for(const r of e)switch(n=n.concat(t.call(this,r)),r.type){case"table":{const e=r;for(const r of e.header)n=n.concat(this.walkTokens(r.tokens,t));for(const r of e.rows)for(const e of r)n=n.concat(this.walkTokens(e.tokens,t));break}case"list":{const e=r;n=n.concat(this.walkTokens(e.items,t));break}default:{const e=r;this.defaults.extensions?.childTokens?.[e.type]?this.defaults.extensions.childTokens[e.type].forEach((r=>{const a=e[r].flat(1/0);n=n.concat(this.walkTokens(a,t))})):e.tokens&&(n=n.concat(this.walkTokens(e.tokens,t)))}}return n}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach((e=>{const n={...e};if(n.async=this.defaults.async||n.async||!1,e.extensions&&(e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if("renderer"in e){const n=t.renderers[e.name];t.renderers[e.name]=n?function(...t){let r=e.renderer.apply(this,t);return!1===r&&(r=n.apply(this,t)),r}:e.renderer}if("tokenizer"in e){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");const n=t[e.level];n?n.unshift(e.tokenizer):t[e.level]=[e.tokenizer],e.start&&("block"===e.level?t.startBlock?t.startBlock.push(e.start):t.startBlock=[e.start]:"inline"===e.level&&(t.startInline?t.startInline.push(e.start):t.startInline=[e.start]))}"childTokens"in e&&e.childTokens&&(t.childTokens[e.name]=e.childTokens)})),n.extensions=t),e.renderer){const t=this.defaults.renderer||new _f(this.defaults);for(const n in e.renderer){if(!(n in t))throw new Error(`renderer '${n}' does not exist`);if(["options","parser"].includes(n))continue;const r=n,a=e.renderer[r],s=t[r];t[r]=(...e)=>{let n=a.apply(t,e);return!1===n&&(n=s.apply(t,e)),n||""}}n.renderer=t}if(e.tokenizer){const t=this.defaults.tokenizer||new yf(this.defaults);for(const n in e.tokenizer){if(!(n in t))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;const r=n,a=e.tokenizer[r],s=t[r];t[r]=(...e)=>{let n=a.apply(t,e);return!1===n&&(n=s.apply(t,e)),n}}n.tokenizer=t}if(e.hooks){const t=this.defaults.hooks||new kf;for(const n in e.hooks){if(!(n in t))throw new Error(`hook '${n}' does not exist`);if(["options","block"].includes(n))continue;const r=n,a=e.hooks[r],s=t[r];kf.passThroughHooks.has(n)?t[r]=e=>{if(this.defaults.async)return Promise.resolve(a.call(t,e)).then((e=>s.call(t,e)));const n=a.call(t,e);return s.call(t,n)}:t[r]=(...e)=>{let n=a.apply(t,e);return!1===n&&(n=s.apply(t,e)),n}}n.hooks=t}if(e.walkTokens){const t=this.defaults.walkTokens,r=e.walkTokens;n.walkTokens=function(e){let n=[];return n.push(r.call(this,e)),t&&(n=n.concat(t.call(this,e))),n}}this.defaults={...this.defaults,...n}})),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return bf.lex(e,t??this.defaults)}parser(e,t){return wf.parse(e,t??this.defaults)}parseMarkdown(e){return(t,n)=>{const r={...n},a={...this.defaults,...r},s=this.onError(!!a.silent,!!a.async);if(!0===this.defaults.async&&!1===r.async)return s(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(null==t)return s(new Error("marked(): input parameter is undefined or null"));if("string"!=typeof t)return s(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));a.hooks&&(a.hooks.options=a,a.hooks.block=e);const i=a.hooks?a.hooks.provideLexer():e?bf.lex:bf.lexInline,o=a.hooks?a.hooks.provideParser():e?wf.parse:wf.parseInline;if(a.async)return Promise.resolve(a.hooks?a.hooks.preprocess(t):t).then((e=>i(e,a))).then((e=>a.hooks?a.hooks.processAllTokens(e):e)).then((e=>a.walkTokens?Promise.all(this.walkTokens(e,a.walkTokens)).then((()=>e)):e)).then((e=>o(e,a))).then((e=>a.hooks?a.hooks.postprocess(e):e)).catch(s);try{a.hooks&&(t=a.hooks.preprocess(t));let e=i(t,a);a.hooks&&(e=a.hooks.processAllTokens(e)),a.walkTokens&&this.walkTokens(e,a.walkTokens);let n=o(e,a);return a.hooks&&(n=a.hooks.postprocess(n)),n}catch(e){return s(e)}}}onError(e,t){return n=>{if(n.message+="\nPlease report this to https://github.com/markedjs/marked.",e){const e="<p>An error occurred:</p><pre>"+hf(n.message+"",!0)+"</pre>";return t?Promise.resolve(e):e}if(t)return Promise.reject(n);throw n}}};function Ef(e,t){return xf.parse(e,t)}function Of(e,t){var n=Office.context.partitionKey;n?localStorage.setItem(n+e,t):localStorage.setItem(e,t)}function Sf(e){var t=Office.context.partitionKey;return t?localStorage.getItem(t+e):localStorage.getItem(e)}function $f(e){return $f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$f(e)}function If(){If=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},i=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof y?t:y,i=Object.create(s.prototype),o=new A(r||[]);return a(i,"_invoke",{value:S(e,n,o)}),i}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function y(){}function b(){}function _(){}var v={};l(v,i,(function(){return this}));var w=Object.getPrototypeOf,k=w&&w(w(T([])));k&&k!==n&&r.call(k,i)&&(v=k);var x=_.prototype=y.prototype=Object.create(v);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function n(a,s,i,o){var c=d(e[a],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==$f(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,i,o)}),(function(e){n("throw",e,i,o)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,o)}))}o(c.arg)}var s;a(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return s=s?s.then(a,a):a()}})}function S(t,n,r){var a=h;return function(s,i){if(a===f)throw Error("Generator is already running");if(a===m){if("throw"===s)throw i;return{value:e,done:!0}}for(r.method=s,r.arg=i;;){var o=r.delegate;if(o){var c=$(o,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===h)throw a=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=f;var l=d(t,n,r);if("normal"===l.type){if(a=r.done?m:p,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(a=m,r.method="throw",r.arg=l.arg)}}}function $(t,n){var r=n.method,a=t.iterator[r];if(a===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,$(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var s=d(a,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,g;var i=s.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,s=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError($f(t)+" is not iterable")}return b.prototype=_,a(x,"constructor",{value:_,configurable:!0}),a(_,"constructor",{value:b,configurable:!0}),b.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(x),e},t.awrap=function(e){return{__await:e}},E(O.prototype),l(O.prototype,o,(function(){return this})),t.AsyncIterator=O,t.async=function(e,n,r,a,s){void 0===s&&(s=Promise);var i=new O(u(e,n,r,a),s);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(x),l(x,c,"Generator"),l(x,i,(function(){return this})),l(x,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=T,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return o.type="throw",o.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s],o=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),l=r.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var s=a;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var i=s?s.completion:{};return i.type=e,i.arg=t,s?(this.method="next",this.next=s.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;P(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function Pf(e,t,n,r,a,s,i){try{var o=e[s](i),c=o.value}catch(e){return void n(e)}o.done?t(c):Promise.resolve(c).then(r,a)}function Af(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var s=e.apply(t,n);function i(e){Pf(s,r,a,i,o,"next",e)}function o(e){Pf(s,r,a,i,o,"throw",e)}i(void 0)}))}}function Tf(e,t){return Rf.apply(this,arguments)}function Rf(){return Rf=Af(If().mark((function e(t,n){var r,a,s,i,o,c,l=arguments;return If().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>2&&void 0!==l[2]&&l[2],""!==t){e.next=5;break}return e.abrupt("return",n);case 5:return e.next=7,fetch(t);case 7:if((a=e.sent).ok){e.next=10;break}throw new Error("Failed to load prompt: ".concat(a.status," ").concat(a.statusText));case 10:return e.next=12,a.text();case 12:if(s=e.sent,!r){e.next=26;break}return i=s.replace(/:$/,"."),e.next=17,fetch("/WordLLM/prompts/html_preserve.txt");case 17:if((o=e.sent).ok){e.next=20;break}throw new Error("Failed to load HTML preservation prompt: ".concat(o.status," ").concat(o.statusText));case 20:return e.next=22,o.text();case 22:return c=e.sent,e.abrupt("return",i+" "+c+"\n"+n);case 26:return e.abrupt("return",s+"\n"+n);case 27:case"end":return e.stop()}}),e)}))),Rf.apply(this,arguments)}function jf(e){return Nf.apply(this,arguments)}function Nf(){return Nf=Af(If().mark((function e(t){var n,r,a,s,i,o,c,l,u,d=arguments;return If().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=d.length>1&&void 0!==d[1]&&d[1],r=d.length>2&&void 0!==d[2]?d[2]:"",e.next=5,Tf(r,t,!n);case 5:a=e.sent,console.log("Full prompt:",a),r&&(i=r.split("/"),s=i[i.length-1].replace(".txt","")),o=Sf("baseURL"),c=Sf("apiKey"),l=Sf("selectedModel"),u=dp(o,c,l,s),Mf(a,n,u);case 13:case"end":return e.stop()}}),e)}))),Nf.apply(this,arguments)}function Cf(e){return Lf.apply(this,arguments)}function Lf(){return Lf=Af(If().mark((function e(t){var n,r,a,s=arguments;return If().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=s.length>1&&void 0!==s[1]&&s[1],r=s.length>3?s[3]:void 0,a=(s.length>2&&void 0!==s[2]?s[2]:"")+"\n"+t,console.log("Full prompt:",a),Mf(a,n,r);case 6:case"end":return e.stop()}}),e)}))),Lf.apply(this,arguments)}function Mf(e){return Uf.apply(this,arguments)}function Uf(){return Uf=Af(If().mark((function e(t){var n,r,a,s,i,o=arguments;return If().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]&&o[1],r=o.length>2?o[2]:void 0,(a=document.getElementById("loadingOverlay"))&&(a.style.display="flex",a.classList.add("active")),e.prev=4,e.next=7,Word.run(function(){var e=Af(If().mark((function e(a){var s,i,o,c,l,u,d,h;return If().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,hp(t,r);case 2:if(s=e.sent,console.log("Received the LLM response:",s),!n){e.next=16;break}if(!(i=document.getElementById("response"))){e.next=14;break}return e.next=9,Ef.parse(s);case 9:o=e.sent,console.log("Displaying response in taskpane : \n "+o),i.innerHTML='<div class="markdown-content">'.concat(o,"</div>"),(c=document.querySelector(".response-section"))&&c.scrollIntoView({behavior:"smooth",block:"start"});case 14:e.next=24;break;case 16:return l=a.document.getSelection(),u=l.getHtml(),e.next=20,a.sync();case 20:d=/<body[^>]*>([\s\S]*)<\/body>/i,h=u.value.replace(d,"<body>".concat(s,"</body>")),l.clear(),l.insertHtml(h,Word.InsertLocation.replace);case 24:return e.next=26,a.sync();case 26:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 7:e.next=14;break;case 9:e.prev=9,e.t0=e.catch(4),console.error("Error in askLLM:",e.t0),(s=document.getElementById("response"))&&(console.log("Displaying error in UI"),s.textContent="An error occurred: ".concat(e.t0.message||e.t0,". Please try again."),(i=document.querySelector(".response-section"))&&i.scrollIntoView({behavior:"smooth",block:"start"}));case 14:return e.prev=14,a&&(a.style.display="none",a.classList.remove("active")),e.finish(14);case 17:console.log("Finished askLLM function");case 18:case"end":return e.stop()}}),e,null,[[4,9,14,17]])}))),Uf.apply(this,arguments)}function Df(e){return Df="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Df(e)}function Ff(){Ff=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},i=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var s=t&&t.prototype instanceof y?t:y,i=Object.create(s.prototype),o=new A(r||[]);return a(i,"_invoke",{value:S(e,n,o)}),i}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function y(){}function b(){}function _(){}var v={};l(v,i,(function(){return this}));var w=Object.getPrototypeOf,k=w&&w(w(T([])));k&&k!==n&&r.call(k,i)&&(v=k);var x=_.prototype=y.prototype=Object.create(v);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function n(a,s,i,o){var c=d(e[a],e,s);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==Df(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,i,o)}),(function(e){n("throw",e,i,o)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,o)}))}o(c.arg)}var s;a(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return s=s?s.then(a,a):a()}})}function S(t,n,r){var a=h;return function(s,i){if(a===f)throw Error("Generator is already running");if(a===m){if("throw"===s)throw i;return{value:e,done:!0}}for(r.method=s,r.arg=i;;){var o=r.delegate;if(o){var c=$(o,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===h)throw a=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=f;var l=d(t,n,r);if("normal"===l.type){if(a=r.done?m:p,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(a=m,r.method="throw",r.arg=l.arg)}}}function $(t,n){var r=n.method,a=t.iterator[r];if(a===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,$(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var s=d(a,t.iterator,n.arg);if("throw"===s.type)return n.method="throw",n.arg=s.arg,n.delegate=null,g;var i=s.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,s=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n};return s.next=s}}throw new TypeError(Df(t)+" is not iterable")}return b.prototype=_,a(x,"constructor",{value:_,configurable:!0}),a(_,"constructor",{value:b,configurable:!0}),b.displayName=l(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,l(e,c,"GeneratorFunction")),e.prototype=Object.create(x),e},t.awrap=function(e){return{__await:e}},E(O.prototype),l(O.prototype,o,(function(){return this})),t.AsyncIterator=O,t.async=function(e,n,r,a,s){void 0===s&&(s=Promise);var i=new O(u(e,n,r,a),s);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(x),l(x,c,"Generator"),l(x,i,(function(){return this})),l(x,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=T,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return o.type="throw",o.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s],o=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),l=r.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var s=a;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var i=s?s.completion:{};return i.type=e,i.arg=t,s?(this.method="next",this.next=s.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;P(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function Bf(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function zf(e,t,n,r,a,s,i){try{var o=e[s](i),c=o.value}catch(e){return void n(e)}o.done?t(c):Promise.resolve(c).then(r,a)}function Zf(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var s=e.apply(t,n);function i(e){zf(s,r,a,i,o,"next",e)}function o(e){zf(s,r,a,i,o,"throw",e)}i(void 0)}))}}Ef.options=Ef.setOptions=function(e){return xf.setOptions(e),Ef.defaults=xf.defaults,mp(Ef.defaults),Ef},Ef.getDefaults=function(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}},Ef.defaults=fp,Ef.use=function(...e){return xf.use(...e),Ef.defaults=xf.defaults,mp(Ef.defaults),Ef},Ef.walkTokens=function(e,t){return xf.walkTokens(e,t)},Ef.parseInline=xf.parseInline,Ef.Parser=wf,Ef.parser=wf.parse,Ef.Renderer=_f,Ef.TextRenderer=vf,Ef.Lexer=bf,Ef.lexer=bf.lex,Ef.Tokenizer=yf,Ef.Hooks=kf,Ef.parse=Ef,Ef.options,Ef.setOptions,Ef.use,Ef.walkTokens,Ef.parseInline,wf.parse,bf.lex;var qf=null,Hf=[],Wf=null;function Gf(){return Jf.apply(this,arguments)}function Jf(){return(Jf=Zf(Ff().mark((function e(){var t,n,r,a;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(t=document.getElementById("modelSelect")).classList.add("loading"),e.prev=2,n=document.getElementById("baseURL").value,r=document.getElementById("apiKey").value,e.next=7,lp(n,r);case 7:Vf(Hf=e.sent),(a=Sf("selectedModel"))&&Hf.includes(a)&&(t.value=a),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("Error fetching models:",e.t0),t.innerHTML='<option value="">Error loading models</option>';case 17:return e.prev=17,t.classList.remove("loading"),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[2,13,17,20]])})))).apply(this,arguments)}function Vf(e){var t=document.getElementById("modelSelect"),n=function(e){var t=document.getElementById("modelSearch").value.toLowerCase();return e.filter((function(e){return e.toLowerCase().includes(t)}))}(e);t.innerHTML=n.length>0?n.map((function(e){return'<option value="'.concat(e,'">').concat(e,"</option>")})).join(""):'<option value="">No models found</option>',1===n.length&&(t.value=n[0],Qf())}function Kf(){Vf(Hf)}function Xf(){var e=document.getElementById("modelSelect").value;e&&(Of("selectedModel",e),Qf())}function Qf(){var e=document.getElementById("baseURL").value,t=document.getElementById("apiKey").value,n=document.getElementById("modelSelect").value;qf=dp(e,t,n),console.log("Model updated to:",n)}function Yf(){var e=document.getElementById("baseURL").value,t=document.getElementById("apiKey").value;Of("baseURL",e),Of("apiKey",t);var n=document.getElementById("response");n&&(n.innerHTML='<div class="markdown-content">Configuration saved successfully!</div>'),Gf()}function em(){return tm.apply(this,arguments)}function tm(){return(tm=Zf(Ff().mark((function e(){var t;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=document.getElementById("prompt").value,console.log("Retrieved textAreaValue:",t),e.next=4,jf(t,!0,"",qf);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function nm(){return rm.apply(this,arguments)}function rm(){return rm=Zf(Ff().mark((function e(){return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(t){var n,r;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.document.getSelection()).load("text"),e.next=4,t.sync();case 4:return r=n.text,e.next=7,jf(r,!0,"/WordLLM/prompts/explain.txt",qf);case 7:return e.next=9,t.sync();case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),rm.apply(this,arguments)}function am(){return sm.apply(this,arguments)}function sm(){return sm=Zf(Ff().mark((function e(){return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(t){var n,r,a,s,i,o;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.document.getSelection(),r=n.getHtml(),e.next=4,t.sync();case 4:return a=/<body[^>]*>([\s\S]*)<\/body>/i,s=r.value.match(a),i=s?s[1]:"",o=r.value.replace(a,"<body>BODYTOREPLACE</body>"),e.abrupt("return",{html:o,body:i});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),sm.apply(this,arguments)}function im(){return om.apply(this,arguments)}function om(){return om=Zf(Ff().mark((function e(){return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(t){var n,r;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("translate to english button clicked"),e.next=3,am();case 3:return(n=e.sent).html,r=n.body,e.next=8,jf(r,!1,"/WordLLM/prompts/translateToEnglish.txt",qf);case 8:return e.next=10,t.sync();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),om.apply(this,arguments)}function cm(){return lm.apply(this,arguments)}function lm(){return lm=Zf(Ff().mark((function e(){return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(t){var n,r;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("translate to english button clicked"),e.next=3,am();case 3:return(n=e.sent).html,r=n.body,e.next=8,jf(r,!1,"/WordLLM/prompts/translateToFrench.txt",qf);case 8:return e.next=10,t.sync();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),lm.apply(this,arguments)}function um(){return dm.apply(this,arguments)}function dm(){return dm=Zf(Ff().mark((function e(){return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(t){var n,r;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("enhance button clicked"),e.next=3,am();case 3:return(n=e.sent).html,r=n.body,e.next=8,jf(r,!1,"/WordLLM/prompts/enhance.txt",qf);case 8:return e.next=10,t.sync();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),dm.apply(this,arguments)}function hm(){return pm.apply(this,arguments)}function pm(){return pm=Zf(Ff().mark((function e(){return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(t){var n,r;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("correct spelling button clicked"),e.next=3,am();case 3:return(n=e.sent).html,r=n.body,e.next=8,jf(r,!1,"/WordLLM/prompts/correctSpelling.txt",qf);case 8:return e.next=10,t.sync();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),pm.apply(this,arguments)}function fm(){return mm.apply(this,arguments)}function mm(){return mm=Zf(Ff().mark((function e(){var t;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("promptReplaceSelection").value){e.next=3;break}return e.abrupt("return");case 3:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(n){var r,a;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,am();case 2:return(r=e.sent).html,a=r.body,e.next=7,Cf(a,!1,t,qf);case 7:return e.next=9,n.sync();case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e)}))),mm.apply(this,arguments)}function gm(){return ym.apply(this,arguments)}function ym(){return ym=Zf(Ff().mark((function e(){var t;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("promptReplyTaskpane").value){e.next=3;break}return e.abrupt("return");case 3:return e.abrupt("return",Word.run(function(){var e=Zf(Ff().mark((function e(n){var r,a;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.document.getSelection()).load("text"),e.next=4,n.sync();case 4:return a=r.text,e.next=7,Cf(a,!0,t,qf);case 7:return e.next=9,n.sync();case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 4:case"end":return e.stop()}}),e)}))),ym.apply(this,arguments)}function bm(e){Wf=e;var t=document.getElementById("promptNamePopup");if(t){t.classList.add("active");var n=document.getElementById("promptName");n&&(n.value="",n.focus())}}function _m(){var e=document.getElementById("promptNamePopup");e&&e.classList.remove("active"),Wf=null}function vm(){if(Wf){var e=document.getElementById("promptName").value.trim();if(e){var t;if(t="replaceSelection"===Wf?document.getElementById("promptReplaceSelection").value:document.getElementById("promptReplyTaskpane").value){var n=JSON.parse(Sf("savedPrompts")||"{}");n[e]={type:Wf,text:t},Of("savedPrompts",JSON.stringify(n)),wm('Prompt "'.concat(e,'" saved successfully!')),_m(),km()}}else wm("Please enter a name for the prompt")}}function wm(e){var t=document.getElementById("response");t&&(t.innerHTML='<div class="markdown-content">'.concat(e,"</div>"))}function km(){var e=JSON.parse(Sf("savedPrompts")||"{}"),t=document.getElementById("customReplacePrompts"),n=document.getElementById("customTaskpanePrompts");t&&n&&(t.innerHTML="",n.innerHTML="",Object.entries(e).forEach((function(e){var r,a,s=(a=2,function(e){if(Array.isArray(e))return e}(r=e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,s,i,o=[],c=!0,l=!1;try{if(s=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=s.call(n)).done)&&(o.push(r.value),o.length!==t);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw a}}return o}}(r,a)||function(e,t){if(e){if("string"==typeof e)return Bf(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Bf(e,t):void 0}}(r,a)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),i=s[0],o=s[1],c=function(e,t){var n=document.createElement("button");n.className="action-button custom-prompt-button",n.innerHTML='\n        <span class="button-text">'.concat(e,'</span>\n        <button class="delete-prompt-button" title="Delete prompt">ðŸ—‘ï¸</button>\n    '),n.addEventListener("click",(function(){return"replaceSelection"===t.type?Word.run(function(){var e=Zf(Ff().mark((function e(n){var r,a,s,i;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,am();case 2:return(r=e.sent).html,a=r.body,s=t.text.replace(/:$/,"."),e.t0=s+" ",e.next=9,fetch("/WordLLM/prompts/html_preserve.txt");case 9:return e.next=11,e.sent.text();case 11:return e.t1=e.sent,i=e.t0+e.t1,e.next=15,Cf(a,!1,i,qf);case 15:return e.next=17,n.sync();case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):Word.run(function(){var e=Zf(Ff().mark((function e(n){var r,a;return Ff().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=n.document.getSelection()).load("text"),e.next=4,n.sync();case 4:return a=r.text,e.next=7,Cf(a,!0,t.text,qf);case 7:return e.next=9,n.sync();case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}));var r=n.querySelector(".delete-prompt-button");return r&&r.addEventListener("click",(function(t){t.stopPropagation(),function(e){var t=JSON.parse(Sf("savedPrompts")||"{}");delete t[e],Of("savedPrompts",JSON.stringify(t)),km(),wm('Prompt "'.concat(e,'" deleted successfully!'))}(e)})),n}(i,o);"replaceSelection"===o.type?t.appendChild(c):n.appendChild(c)})))}function xm(){var e=document.querySelector(".config-section");if(e){e.classList.toggle("collapsed");var t=document.getElementById("toggleConfig");t&&(t.innerHTML=e.classList.contains("collapsed")?'<span class="button-icon">+</span>':'<span class="button-icon">âˆ’</span>')}}Office.onReady((function(e){if(e.host===Office.HostType.Word){var t=Sf("baseURL"),n=Sf("apiKey"),r=Sf("selectedModel");t&&(document.getElementById("baseURL").value=t),n&&(document.getElementById("apiKey").value=n);var a=document.getElementById("baseURL").value,s=document.getElementById("apiKey").value;qf=dp(a,s,r||void 0),document.getElementById("baseURL").addEventListener("change",Qf),document.getElementById("apiKey").addEventListener("change",Qf),document.getElementById("saveConfig").addEventListener("click",Yf),document.getElementById("modelSearch").addEventListener("input",Kf),document.getElementById("modelSelect").addEventListener("change",Xf),document.getElementById("toggleConfig").addEventListener("click",xm);var i=document.querySelectorAll(".tab-button");i.forEach((function(e){e.addEventListener("click",(function(){i.forEach((function(e){return e.classList.remove("active")})),document.querySelectorAll(".tab-content").forEach((function(e){return e.classList.remove("active")})),e.classList.add("active");var t=e.getAttribute("data-tab");document.getElementById("".concat(t,"-tab")).classList.add("active")}))})),document.getElementById("executeReplaceSelection").addEventListener("click",fm),document.getElementById("executeReplyTaskpane").addEventListener("click",gm),document.getElementById("saveReplaceSelectionPrompt").addEventListener("click",(function(){return bm("replaceSelection")})),document.getElementById("saveTaskpanePrompt").addEventListener("click",(function(){return bm("taskpane")})),document.getElementById("savePromptConfirm").addEventListener("click",vm),document.getElementById("cancelPromptSave").addEventListener("click",_m),km(),Gf(),document.getElementById("chat").onclick=em,document.getElementById("explain").onclick=nm,document.getElementById("translateToEnglish").onclick=im,document.getElementById("translateToFrench").onclick=cm,document.getElementById("enhance").onclick=um,document.getElementById("correctSpelling").onclick=hm}}))}(),function(){"use strict";new URL(n(58394),n.b)}()}();
//# sourceMappingURL=taskpane.js.map